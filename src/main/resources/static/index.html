<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Full-Stack Observability Demo</title>
    <style>
        body { font-family: sans-serif; padding: 2em; }
        button { font-size: 1.2em; padding: 0.5em 1em; }
        #result { margin-top: 1em; font-weight: bold; }
    </style>
    
    <script src="https://cdn.jsdelivr.net/npm/@grafana/faro-web-sdk@^1/dist/bundle/faro-web-sdk.iife.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@grafana/faro-web-tracing@^1/dist/bundle/faro-web-tracing.iife.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@grafana/faro-transport-otlp-http@^1/dist/bundle/faro-transport-otlp-http.iife.js"></script>

    <script>
        // ç¢ºä¿åœ¨æ‰€æœ‰å‡½å¼åº«è¼‰å…¥å¾ŒåŸ·è¡Œåˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Initializing Grafana Faro...');
            console.log('Available objects:', {
                GrafanaFaroWebSdk: window.GrafanaFaroWebSdk,
                GrafanaFaroWebTracing: window.GrafanaFaroWebTracing,
                GrafanaFaroTransportOtlpHttp: window.GrafanaFaroTransportOtlpHttp
            });

            try {
                const { initializeFaro, getWebInstrumentations } = window.GrafanaFaroWebSdk;
                const { TracingInstrumentation } = window.GrafanaFaroWebTracing;
                const { OtlpHttpTransport } = window.GrafanaFaroTransportOtlpHttp;

                const faro = initializeFaro({
                    // æ‡‰ç”¨ç¨‹å¼æ¨™è­˜
                    app: {
                        // é—œéµï¼šè¨­å®šå‰ç«¯æœå‹™åç¨±ï¼Œä»¥å€åˆ¥æ–¼å¾Œç«¯
                        name: 'my-app-frontend',
                        version: '1.0.0',
                        // å¯é¸ï¼Œä½†å»ºè­°è¨­å®šç’°å¢ƒ
                        environment: 'development'
                    },

                    // æ˜ç¢ºè¨­ç½® OpenTelemetry resource å±¬æ€§
                    otelResourceAttributes: {
                        'service.name': 'my-app-frontend',
                        'service.version': '1.0.0',
                        'deployment.environment': 'development'
                    },

                    // è‡ªå‹•æª¢æ¸¬é…ç½®
                    instrumentations: [
                        // åŸºæœ¬çš„ Web æª¢æ¸¬å™¨ï¼ˆåŒ…æ‹¬é é¢è¼‰å…¥ã€éŒ¯èª¤ç­‰ï¼‰
                        ...getWebInstrumentations(),
                        // è¿½è¹¤æª¢æ¸¬å™¨ï¼ˆç”¨æ–¼ fetchã€XHR ç­‰ï¼‰
                        new TracingInstrumentation()
                    ],

                    // å‚³è¼¸å™¨é…ç½®
                    transports: [
                        new OtlpHttpTransport({
                            // æ ¹æ“šå®˜æ–¹æ–‡ä»¶ä½¿ç”¨æ­£ç¢ºçš„åƒæ•¸åç¨±
                            tracesURL: 'http://localhost:4318/v1/traces',
                            logsURL: 'http://localhost:4318/v1/logs',
                            
                            // æ·»åŠ è«‹æ±‚é¸é …
                            requestOptions: {
                                headers: {
                                    // å¯ä»¥æ·»åŠ é¡å¤–çš„æ¨™é ­å¦‚æœéœ€è¦
                                }
                            },
                            
                            // ç·©è¡è¨­ç½®
                            bufferSize: 100,
                            concurrency: 5,
                        })
                    ],

                    // æ·»åŠ èª¿è©¦æ¨¡å¼
                    debug: true,
                });

                console.log('Grafana Faro initialized successfully:', faro);

                // å°‡ faro API é™„åŠ åˆ° window ç‰©ä»¶ï¼Œä»¥ä¾¿åœ¨æ§åˆ¶å°ä¸­é€²è¡Œèª¿è©¦
                window.faro = faro;

                // æ¸¬è©¦ç™¼é€ä¸€å€‹åˆå§‹äº‹ä»¶
                faro.api.pushEvent('page_loaded', { timestamp: Date.now() });
                console.log('Initial event sent');

            } catch (error) {
                console.error('Failed to initialize Grafana Faro:', error);
            }

            // ç‚ºæŒ‰éˆ•æ·»åŠ äº‹ä»¶ç›£è½å™¨
            const getBooksButton = document.getElementById('getBooksButton');
            const resultDiv = document.getElementById('result');

            getBooksButton.addEventListener('click', () => {
                console.log('Button clicked, making API request...');
                resultDiv.textContent = 'è¼‰å…¥æ›¸æœ¬åˆ—è¡¨ä¸­...';
                
                // æ‰‹å‹•å‰µå»ºä¸€å€‹ span ä¾†æ¸¬è©¦è¿½è¹¤
                if (window.faro && window.faro.api) {
                    window.faro.api.pushEvent('button_clicked', { action: 'get_books' });
                }
                
                // ä½¿ç”¨ fetch èª¿ç”¨å¾Œç«¯ API
                // TracingInstrumentation å°‡è‡ªå‹•ç‚ºæ­¤è«‹æ±‚æ³¨å…¥ 'traceparent' æ¨™é ­
                fetch('/books')
                  .then(response => {
                      console.log('API response received:', response.status);
                      if (!response.ok) {
                          throw new Error('Network response was not ok');
                      }
                      return response.json();
                  })
                  .then(data => {
                        console.log('Books data received:', data);
                        if (Array.isArray(data) && data.length > 0) {
                            const bookList = data.map(book => 
                                `ğŸ“š ${book.title} - ${book.author} (${book.publishYear || 'N/A'})`
                            ).join('<br>');
                            resultDiv.innerHTML = `æ‰¾åˆ° ${data.length} æœ¬æ›¸ï¼š<br>${bookList}`;
                        } else {
                            resultDiv.textContent = 'ç›®å‰æ²’æœ‰æ›¸æœ¬è³‡æ–™ï¼Œè«‹å…ˆæ–°å¢ä¸€äº›æ›¸æœ¬ã€‚';
                        }
                        // æˆ‘å€‘ä¹Ÿå¯ä»¥æ‰‹å‹•ç™¼é€ä¸€å€‹äº‹ä»¶
                        if (window.faro && window.faro.api) {
                            window.faro.api.pushEvent('books_fetched', { count: data.length });
                        }
                    })
                  .catch(error => {
                        console.error('API request failed:', error);
                        resultDiv.textContent = 'è¼‰å…¥æ›¸æœ¬åˆ—è¡¨æ™‚ç™¼ç”ŸéŒ¯èª¤ã€‚';
                        // æ‰‹å‹•æ•ç²ä¸¦ç™¼é€éŒ¯èª¤
                        if (window.faro && window.faro.api) {
                            window.faro.api.pushError(error);
                        }
                    });
            });
        });
    </script>
</head>
<body>
    <h1>Grafana Faro + Spring Boot Demo</h1>
    <p>Click the button to get a list of books. This action will trigger a frontend trace, which is correlated with a backend trace.</p>
    <button id="getBooksButton">Get Books</button>
    <div id="result"></div>
</body>
</html>