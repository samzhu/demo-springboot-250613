# Spring Boot 3 ç¾ä»£åŒ–å°ˆæ¡ˆå¯¦æˆ°æ‰‹å†Š

## ç°¡ä»‹èˆ‡ç›®æ¨™

é€™ä»½é–‹ç™¼è€…æ‰‹å†Šæ—¨åœ¨å¼•å°æ‚¨äº†è§£ä¸€å€‹åŸºæ–¼ Java 21ã€Spring Boot 3.5 èˆ‡ Gradle çš„å°ˆæ¡ˆã€‚æˆ‘å€‘çš„ç›®æ¨™ä¸åƒ…æ˜¯å®ŒæˆåŠŸèƒ½ï¼Œä¹ŸåŒæ¨£é‡è¦–å°ˆæ¡ˆçš„å¥å£¯æ€§ã€æ•ˆèƒ½èˆ‡å¯ç¶­è­·æ€§ã€‚  
æˆ‘å€‘å°‡å¾å°ˆæ¡ˆè¨­å®šé–‹å§‹ï¼Œæ¢è¨ JPAã€Liquibaseã€Redis å¿«å–çš„ä½¿ç”¨ï¼Œä¸¦èšç„¦æ–¼å¦‚ä½•é€é Micrometer èˆ‡ OpenTelemetry (OTLP) å¯¦ç¾å¯è§€æ¸¬æ€§ï¼Œæœ€çµ‚å°‡æ‰€æœ‰é™æ¸¬æ•¸æ“šç™¼é€åˆ° Grafana LGTM ç›£æ§å¾Œç«¯é€²è¡Œåˆ†æã€‚æœ¬æ‰‹å†Šç‚ºå¸Œæœ›æå‡å°ˆæ¡ˆå“è³ªã€æ¡ç”¨æ¥­ç•Œå¸¸è¦‹å¯¦è¸çš„é–‹ç™¼äººå“¡è¨­è¨ˆã€‚

---

## è»Ÿé«”åˆ†å±¤æ¶æ§‹

```mermaid
graph TB
    subgraph "æ›¸æœ¬ç®¡ç†ç³»çµ±"
        WebController
        AppService
        DomainModel
        Repository
        CacheService
    end

    User["ç”¨æˆ¶"] --> WebController
    WebController --> AppService
    AppService --> DomainModel
    AppService --> Repository
    AppService --> CacheService
    Repository --> PostgreSQL
    CacheService --> Redis

    classDef container fill:#1168bd,stroke:#0b4884,color:#ffffff
    classDef external fill:#999999,stroke:#6b6b6b,color:#ffffff

    class WebController,AppService,DomainModel,Repository,CacheService container
    class User,PostgreSQL,Redis external
```

---

## ğŸ“ å°ˆæ¡ˆçµæ§‹æ¦‚è¦½

æœ¬å°ˆæ¡ˆéµå¾ªå¸¸è¦‹çš„åˆ†å±¤æ¶æ§‹ï¼Œå°‡ä¸åŒè·è²¬çš„ç¨‹å¼ç¢¼é€²è¡Œå€éš”ï¼Œæœ‰åŠ©æ–¼å¾ŒçºŒçš„ç¶­è­·å’Œæ“´å±•ã€‚  

```text
.
â”œâ”€â”€ build.gradle                # Gradle å»ºç½®è…³æœ¬ï¼Œå®šç¾©å°ˆæ¡ˆä¾è³´å’Œä»»å‹™
â”œâ”€â”€ config/                     # ä¸æ‡‰è©²è¢«åŒ…é€²å» docker image ä¸­çš„ä¸åŒç’°å¢ƒçš„è¨­å®šæª”
â”‚   â”œâ”€â”€ application-local.yml   # "local" Profile æœ¬æ©Ÿå°ˆç”¨çš„è¨­å®šæª”
â”‚   â”œâ”€â”€ application-ut.yml      # "ut" Profile å–®å…ƒæ¸¬è©¦å°ˆç”¨çš„è¨­å®šæª”
â”‚   â”œâ”€â”€ application-sit.yml     # "sit" Profile æ•´åˆæ¸¬è©¦å°ˆç”¨çš„è¨­å®šæª”
â”‚   â””â”€â”€ application-prod-example.yml     # "prod" Profile æ­£å¼ç’°å¢ƒåƒè€ƒç”¨çš„è¨­å®šæª”(æ©Ÿæ•è³‡è¨Šæ‡‰è©²è¦æ”¾åœ¨secret manager è®Šæ•¸ä¸­ )
â”œâ”€â”€ compose.yaml                # Docker Compose è¨­å®šï¼Œç”¨æ–¼ä¸€éµå•Ÿå‹•æœ¬åœ°é–‹ç™¼ç’°å¢ƒ (DB, Redis, LGTM)
â”œâ”€â”€ dev-resources/
â”‚   â””â”€â”€ openapi.yaml            # API è¦æ ¼æª”æ¡ˆ (Single Source of Truth)
â””â”€â”€ src/
    â”œâ”€â”€ main/
    â”‚   â”œâ”€â”€ java/com/example/demo/
    â”‚   â”‚   â”œâ”€â”€ applications/        # æ‡‰ç”¨å±¤ (Service): å­˜æ”¾æ ¸å¿ƒæ¥­å‹™é‚è¼¯ (e.g., BookService)
    â”‚   â”‚   â”œâ”€â”€ config/              # è¨­å®šå±¤: å­˜æ”¾ Spring è¨­å®šé¡åˆ¥ (e.g., CacheConfig)
    â”‚   â”‚   â”œâ”€â”€ infrastructure/      # åŸºç¤è¨­æ–½å±¤: å­˜æ”¾è³‡æ–™åº«å­˜å–ç›¸é—œä»‹é¢ (e.g., BookRepository)
    â”‚   â”‚   â”œâ”€â”€ interfaces/          # ä»‹é¢å±¤: å­˜æ”¾èˆ‡å¤–éƒ¨äº’å‹•çš„ç¨‹å¼ç¢¼
    â”‚   â”‚   â”‚   â”œâ”€â”€ api/             # - (è‡ªå‹•ç”¢ç”Ÿ) OpenAPI ç”¢ç”Ÿçš„ API ä»‹é¢ (e.g., BooksApi)
    â”‚   â”‚   â”‚   â”œâ”€â”€ dto/             # - (è‡ªå‹•ç”¢ç”Ÿ) OpenAPI ç”¢ç”Ÿçš„è³‡æ–™å‚³è¼¸ç‰©ä»¶ (e.g., BookDto)
    â”‚   â”‚   â”‚   â”œâ”€â”€ mapper/          # - DTO èˆ‡ Entity çš„è½‰æ›å™¨ (e.g., BookMapper)
    â”‚   â”‚   â”‚   â””â”€â”€ rest/            # - REST Controller çš„å¯¦ä½œ (e.g., BookController)
    â”‚   â”‚   â”œâ”€â”€ models/              # æ¨¡å‹å±¤: å­˜æ”¾ JPA è³‡æ–™åº«å¯¦é«” (e.g., Book)
    â”‚   â”‚   â””â”€â”€ DemoApplication.java # Spring Boot æ‡‰ç”¨ç¨‹å¼é€²å…¥é»
    â”‚   â””â”€â”€ resources/
    â”‚       â”œâ”€â”€ application.yml      # æœ€é€šç”¨åŸºç¤çš„çš„ Spring Boot è¨­å®šæª”
    â”‚       â”œâ”€â”€ application-gcp.yml  # é‡å° GCP ç’°å¢ƒçš„è¨­å®šæª”(ä¸åŒ…å«ç’°å¢ƒè®Šæ•¸)
    â”‚       â”œâ”€â”€ application-aws.yml  # é‡å° AWS ç’°å¢ƒçš„è¨­å®šæª”(ä¸åŒ…å«ç’°å¢ƒè®Šæ•¸)
    â”‚       â””â”€â”€ db/changelog/        # Liquibase è³‡æ–™åº«é·ç§»è…³æœ¬
    â”‚           â”œâ”€â”€ db.changelog-master.yaml
    â”‚           â””â”€â”€ history/         # Liquibase è³‡æ–™åº«é·ç§»ç´€éŒ„
    â””â”€â”€ test/                                    # æ¸¬è©¦ç¨‹å¼ç¢¼
        â””â”€â”€ java/com/example/demo/
            â”œâ”€â”€ TestDemoApplication.java
            â”œâ”€â”€ TestcontainersConfiguration.java # Testcontainers çš„è¨­å®š
            â””â”€â”€ DemoApplicationTests.java        # æ•´åˆæ¸¬è©¦
```

---

## ğŸ§© æ ¸å¿ƒæŠ€è¡“èˆ‡é—œéµå¥—ä»¶ä¸€è¦½

æœ¬å°ˆæ¡ˆæ¡ç”¨äº†ä¸€ç³»åˆ—æ¥­ç•Œå¸¸è¦‹çš„æŠ€è¡“æ£§ï¼Œç”¨ä»¥å»ºæ§‹æ‡‰ç”¨ç¨‹å¼ã€‚  

### èªè¨€/æ¡†æ¶

Java 21, Spring Boot 3.5.0  

### å»ºç½®èˆ‡å·¥å…·å¤–æ› (Plugins)

- **`org.springframework.boot`**  
  Spring Boot æ ¸å¿ƒå¤–æ›ï¼Œæä¾› `bootRun` ä»»å‹™ä¸¦å°‡å°ˆæ¡ˆæ‰“åŒ…æˆå¯åŸ·è¡Œçš„ JARã€‚
- **`io.spring.dependency-management`**  
  Spring çš„ä¾è³´ç®¡ç†ï¼Œè®“æˆ‘å€‘å¯ä»¥çœç•¥å¸¸ç”¨å‡½å¼åº«çš„ç‰ˆæœ¬è™Ÿï¼Œç”± Spring Boot çµ±ä¸€æ§åˆ¶ã€‚
- **`org.openapi.generator`**  
  API First çš„å¯¦è¸æ ¸å¿ƒã€‚å¾ `openapi.yaml` è¦æ ¼æª”è‡ªå‹•ç”¢ç”Ÿ Java çš„ API ä»‹é¢èˆ‡ DTOsï¼Œç¢ºä¿ç¨‹å¼ç¢¼èˆ‡ API è¦æ ¼çš„ä¸€è‡´æ€§ã€‚
- **`com.gorylenko.gradle-git-properties`**  
  ç”¢ç”Ÿä¸€å€‹åŒ…å«ç•¶å‰ Git ç‹€æ…‹ï¼ˆå¦‚ commit IDã€åˆ†æ”¯åç¨±ï¼‰çš„ `git.properties` æª”æ¡ˆã€‚é€™å€‹æª”æ¡ˆå¯ä»¥è¢« Actuator çš„ `/info` ç«¯é»è®€å–ï¼Œè®“æˆ‘å€‘èƒ½ç²¾ç¢ºçŸ¥é“ç”Ÿç”¢ç’°å¢ƒä¸­é‹è¡Œçš„åˆ°åº•æ˜¯å“ªå€‹ç‰ˆæœ¬çš„ç¨‹å¼ç¢¼ã€‚ Â¹
- **`org.cyclonedx.bom`**  
  è»Ÿé«”ç‰©æ–™æ¸…å–® (SBOM) ç”¢ç”Ÿå™¨ã€‚å®ƒæœƒç”¢ç”Ÿä¸€å€‹ CycloneDX æ ¼å¼çš„ BOM æª”æ¡ˆï¼Œè©³ç´°åˆ—å‡ºå°ˆæ¡ˆçš„æ‰€æœ‰çµ„ä»¶åŠå…¶ä¾è³´é—œä¿‚ã€‚é€™å°æ–¼é€²è¡Œè‡ªå‹•åŒ–çš„å®‰å…¨æ€§æ¼æ´æƒæå’Œæˆæ¬Šåˆè¦æ€§æª¢æŸ¥è‡³é—œé‡è¦ã€‚ âµ
- **`jacoco`**  
  ç”¨æ–¼è¨ˆç®—ç¨‹å¼ç¢¼æ¸¬è©¦è¦†è“‹ç‡çš„å·¥å…·ï¼Œå¯ä»¥ç”¢ç”Ÿå ±å‘Šï¼Œå¹«åŠ©æˆ‘å€‘è©•ä¼°æ¸¬è©¦çš„å®Œæ•´æ€§ã€‚

### é—œéµä¾è³´ (Dependencies)

#### API èˆ‡ Web å±¤

- **`spring-boot-starter-web`**  
  å»ºæ§‹ RESTful API çš„æ‰€æœ‰å¿…éœ€å“ï¼ŒåŒ…å«å…§åµŒçš„ Tomcat ä¼ºæœå™¨å’Œ Spring MVCã€‚
- **`spring-boot-starter-validation`**  
  å•Ÿç”¨ Java Bean Validationã€‚è®“æˆ‘å€‘å¯ä»¥åœ¨ DTO ä¸Šä½¿ç”¨ `@NotNull`, `@Size` ç­‰è¨»è§£ï¼ŒSpring æœƒåœ¨è™•ç†è«‹æ±‚æ™‚è‡ªå‹•æ ¡é©—å‚³å…¥çš„è³‡æ–™æ˜¯å¦ç¬¦åˆè¦å‰‡ã€‚
- **`springdoc-openapi-starter-webmvc-ui`**  
  è‡ªå‹•æ•´åˆ Swagger UIï¼ŒåŸºæ–¼æˆ‘å€‘çš„ Controller å’Œ OpenAPI è¦æ ¼ç”¢ç”Ÿä¸€å€‹äº’å‹•å¼çš„ API æ–‡ä»¶é é¢ (é è¨­è·¯å¾‘ `/swagger-ui.html`)ï¼Œæ–¹ä¾¿åœ¨æœ¬æ©Ÿé€²è¡Œ API æ¸¬è©¦ã€‚
- **`mapstruct`** å’Œ **`annotationProcessor "org.mapstruct:mapstruct-processor"`**  
  ä¸€å€‹ç·¨è­¯æœŸåŸ·è¡Œçš„ç‰©ä»¶æ˜ å°„å·¥å…·ï¼Œç”¨æ–¼ DTO èˆ‡ Entity ä¹‹é–“çš„è½‰æ›ï¼Œé¿å…æ‰‹å¯«é‡è¤‡çš„æ˜ å°„ç¨‹å¼ç¢¼ã€‚
- **`jackson-databind-nullable`**  
  é€™æ˜¯ OpenAPI Generator çš„ä¸€å€‹è¼”åŠ©å‡½å¼åº«ã€‚å®ƒè§£æ±ºäº† `null` å’Œ `undefined` (æœªæä¾›) åœ¨ JSON ä¸­çš„å€åˆ¥ï¼Œé€™å°æ–¼è™•ç† PATCH é€™é¡éƒ¨åˆ†æ›´æ–°çš„æ“ä½œç‰¹åˆ¥é‡è¦ï¼Œå¯ä»¥ç²¾ç¢ºåœ°åˆ¤æ–·ä½¿ç”¨è€…æ˜¯æƒ³å°‡æŸå€‹æ¬„ä½è¨­ç‚º `null`ï¼Œé‚„æ˜¯æ ¹æœ¬æ²’æ‰“ç®—æ›´æ–°å®ƒã€‚

#### è³‡æ–™å­˜å–èˆ‡å¿«å–å±¤

- **`spring-boot-starter-data-jpa`**  
  ç°¡åŒ–è³‡æ–™åº«çš„ CRUD æ“ä½œï¼Œæä¾› JpaRepository ä»‹é¢ï¼Œåº•å±¤ä½¿ç”¨ Hibernate ä½œç‚º ORM å¯¦ä½œã€‚
- **`liquibase-core`**  
  ä¸€å€‹è³‡æ–™åº«é·ç§»å·¥å…·ã€‚è®“æˆ‘å€‘å¯ä»¥ç”¨æª”æ¡ˆ (å¦‚ YAML, XML, SQL) ä¾†ç®¡ç†è³‡æ–™åº«çµæ§‹ (Schema) çš„æ¼”é€²ï¼Œå¯¦ç¾è³‡æ–™åº«çš„ç‰ˆæœ¬æ§åˆ¶ï¼Œç¢ºä¿å„ç’°å¢ƒçš„ä¸€è‡´æ€§ã€‚  
- **`spring-boot-starter-cache`**  
  æä¾›äº†ä¸€å¥—çµ±ä¸€çš„å¿«å–æŠ½è±¡ APIã€‚æˆ‘å€‘å¯ä»¥ä½¿ç”¨ `@Cacheable`, `@CacheEvict` ç­‰è¨»è§£ç‚ºæ–¹æ³•åŠ ä¸Šå¿«å–é‚è¼¯ï¼Œè€Œä¸éœ€è¦è€¦åˆåº•å±¤çš„å¿«å–å¯¦ç¾ã€‚
- **`spring-boot-starter-data-redis`**  
  æ•´åˆ Redisã€‚ç•¶å®ƒå’Œ `spring-boot-starter-cache` ä¸€èµ·ä½¿ç”¨æ™‚ï¼ŒSpring Boot æœƒè‡ªå‹•å°‡ Redis è¨­å®šç‚ºå¿«å–çš„å…·é«”å¯¦ç¾ã€‚

#### å¯è§€æ¸¬æ€§ (Observability) å±¤

- **`spring-boot-starter-actuator`**  
  å¯è§€æ¸¬æ€§åŠŸèƒ½çš„åŸºç¤ã€‚å®ƒå¼•å…¥äº† Micrometerï¼Œä¸¦æä¾›äº†å¤šå€‹ç”Ÿç”¢å°±ç·’çš„ç®¡ç†ç«¯é»ï¼Œå¦‚ `/actuator/health`, `/actuator/info`ã€‚
- **`spring-boot-starter-aop`**  
  å•Ÿç”¨ `@Observed` çš„é—œéµã€‚å®ƒæä¾›äº†é¢å‘åˆ‡é¢ç·¨ç¨‹ (AOP) çš„èƒ½åŠ›ï¼Œè®“ Micrometer çš„ `ObservedAspect` å¯ä»¥æ””æˆªè¢« `@Observed` è¨»è§£æ¨™è¨˜çš„æ–¹æ³•ï¼Œä¸¦åœ¨å…¶å‰å¾Œè‡ªå‹•åŠ å…¥ç”¢ç”ŸæŒ‡æ¨™å’Œè¿½è¹¤çš„é‚è¼¯ã€‚
- **`io.micrometer:micrometer-tracing-bridge-otel`**  
  æ©‹æ¥å™¨ã€‚å®ƒçš„ä½œç”¨æ˜¯å°‡ Micrometer Tracing API çš„å‘¼å«ï¼ˆä¾‹å¦‚ç•¶ `@Observed` å»ºç«‹ä¸€å€‹ Span æ™‚ï¼‰è½‰è­¯æˆ OpenTelemetry Tracer èƒ½å¤ ç†è§£çš„æŒ‡ä»¤ã€‚
- **`io.opentelemetry:opentelemetry-exporter-otlp`**  
  è¿½è¹¤èˆ‡æ—¥èªŒåŒ¯å‡ºå™¨ã€‚å®ƒåŒ…å«äº†å°‡è¿½è¹¤æ•¸æ“šï¼ˆTracesï¼‰å’Œæ—¥èªŒï¼ˆLogsï¼‰æ‰“åŒ…æˆ OTLP æ ¼å¼ä¸¦é€éç¶²è·¯å‚³é€å‡ºå»çš„å…·é«”å¯¦ä½œã€‚
- **`io.opentelemetry.instrumentation:opentelemetry-spring-boot-starter`**  
  OTel è‡ªå‹•è¨­å®šå¥—ä»¶ã€‚å®ƒç°¡åŒ–äº†æ•´åˆå·¥ä½œï¼Œèƒ½è‡ªå‹•åµæ¸¬å°ˆæ¡ˆä¸­çš„å‡½å¼åº«ï¼ˆå¦‚ Logbackï¼‰ï¼Œä¸¦å°‡ OTel çš„åŠŸèƒ½ï¼ˆå¦‚æ—¥èªŒåŒ¯å‡ºï¼‰æ•´åˆé€² Spring Boot çš„ç”Ÿå‘½é€±æœŸä¸­ã€‚
- **`io.micrometer:micrometer-registry-otlp`**  
  æŒ‡æ¨™åŒ¯å‡ºå™¨ã€‚å®ƒæ˜¯ä¸€å€‹ Micrometer çš„è¨»å†Šè¡¨ (Registry) å¯¦ä½œï¼Œè² è²¬å°‡ Micrometer æ”¶é›†åˆ°çš„æŒ‡æ¨™ (Metrics) æ•¸æ“šè½‰æ›ç‚º OTLP æ ¼å¼ä¸¦ç™¼é€å‡ºå»ã€‚
- **`io.micrometer:micrometer-registry-prometheus`**  
  Prometheus æŒ‡æ¨™ç«¯é»ã€‚å®ƒæä¾›äº†å¦ä¸€å€‹æŒ‡æ¨™è¨»å†Šè¡¨ï¼Œå¯ä»¥åœ¨ `/actuator/prometheus` ç«¯é»ä¸Šæš´éœ²ä¸€å€‹ Prometheus æ ¼å¼çš„æŒ‡æ¨™é é¢ã€‚é€™åœ¨æœ¬åœ°é–‹ç™¼æ™‚å¾ˆå¯¦ç”¨ï¼Œå¯ä»¥ç›´æ¥æŸ¥çœ‹æŒ‡æ¨™æ•¸æ“šã€‚

---

## ğŸ› ï¸ é–‹ç™¼èˆ‡è¨­å®š

### é–‹ç™¼æŒ‡å—

- ç•¶ `openapi.yaml` æœ‰æ›´å‹•æ™‚ï¼Œéœ€æ‰‹å‹•åŸ·è¡Œ `./gradlew clean openApiGenerate` é‡æ–°ç”Ÿæˆ API ç›¸é—œä»‹é¢ã€‚
- ä½¿ç”¨ `./gradlew bootRun --args='--spring.profiles.active=local'` æŒ‡ä»¤ä¾†å•Ÿå‹•æœ¬æ©Ÿç’°å¢ƒã€‚
- æœ¬æ©Ÿ Swagger UI ä½ç½®ï¼š`http://localhost:8080/swagger-ui.html`

### VSCode è¨­å®š

#### å»ºç«‹ launch.json

å¯ä»¥æ‰‹å‹•å»ºç«‹ `.vscode/launch.json` æª”æ¡ˆï¼Œæˆ–é€é VSCode å·¦å´çš„ **Run and Debug** é¢æ¿æ–°å¢é…ç½®ã€‚
æ­¤è¨­å®šçš„ä½œç”¨æ˜¯åœ¨é€é IDE å•Ÿå‹• Spring Boot æ‡‰ç”¨æ™‚ï¼Œå¯ä»¥ç‚ºå…¶æŒ‡å®š `profile`ï¼Œè®“æ‡‰ç”¨åœ¨æœ¬åœ°ç’°å¢ƒä¸­è¼‰å…¥å°æ‡‰çš„è¨­å®šæª” (ä¾‹å¦‚ `application-local.yml`)ã€‚

```json
{
    "version": "0.2.0",
    "configurations": [
        {
            "type": "java",
            "name": "Current File",
            "request": "launch",
            "mainClass": "${file}"
        },
        {
            "type": "java",
            "name": "DemoApplication",
            "request": "launch",
            "mainClass": "com.example.demo.DemoApplication",
            "projectName": "demo-springboot-250613",
            "env": {
                "spring.profiles.active": "local"
            }
        },
        {
            "type": "java",
            "name": "TestDemoApplication",
            "request": "launch",
            "mainClass": "com.example.demo.TestDemoApplication",
            "projectName": "demo-springboot-250613"
        }
    ]
}
```

---

## ğŸ¤ API First é–‹ç™¼æµç¨‹

æœ¬å°ˆæ¡ˆæ¡ç”¨ **API First** çš„é–‹ç™¼æ¨¡å¼ã€‚é€™æ„å‘³è‘—æˆ‘å€‘å…ˆåœ¨ä¸€å€‹ä¸­ç«‹çš„ã€æ¨™æº–åŒ–çš„æª”æ¡ˆ (`openapi.yaml`) ä¸­å®šç¾© API çš„è¦æ ¼ï¼ˆå¥‘ç´„ï¼‰ï¼Œç„¶å¾Œå†æ ¹æ“šé€™ä»½è¦æ ¼ä¾†ç”¢ç”Ÿç¨‹å¼ç¢¼çš„éª¨æ¶ã€‚é€™ä»½è¦æ ¼æª”æ¡ˆæ˜¯**å”¯ä¸€çš„çœŸç›¸ä¾†æº (Single Source of Truth)**ï¼Œç”¨ä»¥ç¢ºä¿ API æ–‡ä»¶èˆ‡å¯¦éš›ç¨‹å¼ç¢¼çš„ä¸€è‡´æ€§ã€‚  

### é‹ä½œæ–¹å¼

æˆ‘å€‘é€é `org.openapi.generator`é€™å€‹ Gradle å¤–æ›ä¾†å¯¦ç¾è‡ªå‹•åŒ–ã€‚ç•¶ä½ ç·¨è­¯å°ˆæ¡ˆæ™‚ï¼Œå®ƒæœƒåŸ·è¡Œä»¥ä¸‹æ­¥é©Ÿï¼š  

1. **è®€å–è¦æ ¼**: è®€å–ä½æ–¼ `dev-resources/openapi.yaml` çš„ API è¦æ ¼æª”æ¡ˆã€‚
2. **ç”¢ç”Ÿç¨‹å¼ç¢¼**: æ ¹æ“šè¦æ ¼ï¼Œåœ¨ `build/generated/openapi` ç›®éŒ„ä¸‹è‡ªå‹•ç”¢ç”Ÿ Java ä»‹é¢ (Interface) å’Œè³‡æ–™å‚³è¼¸ç‰©ä»¶ (DTO)ã€‚
3. **ç´å…¥ç·¨è­¯**: æˆ‘å€‘è¨­å®š `sourceSets` å°‡é€™å€‹è‡ªå‹•ç”¢ç”Ÿçš„ç›®éŒ„è¦–ç‚ºå°ˆæ¡ˆåŸå§‹ç¢¼çš„ä¸€éƒ¨åˆ†ï¼Œä½¿å…¶èƒ½è¢«æ­£å¸¸ç·¨è­¯å’Œä½¿ç”¨ã€‚
4. **é–‹ç™¼è€…å¯¦ä½œ**: é–‹ç™¼è€…åªéœ€è¦å°ˆæ³¨æ–¼æ¥­å‹™é‚è¼¯ï¼Œå»å¯¦ä½œ (implement) é€™äº›è‡ªå‹•ç”¢ç”Ÿçš„ä»‹é¢å³å¯ã€‚

### build.gradle ä¸­çš„é—œéµè¨­å®š

è®“æˆ‘å€‘çœ‹çœ‹ `openApiGenerate` é€™å€‹ä»»å‹™çš„è¨­å®šç´°ç¯€ï¼š  

```groovy
tasks.named('openApiGenerate') {
    generatorName.set("spring")
    library.set("spring-cloud")
    inputSpec.set(layout.projectDirectory.file("dev-resources/openapi.yaml").asFile.path) // API è¦æ ¼ä¾†æº
    outputDir.set(layout.buildDirectory.dir("generated/openapi").get().asFile.path)      // ç¨‹å¼ç¢¼è¼¸å‡ºä½ç½®
    apiPackage.set("com.example.demo.interfaces.api")   // ç”¢ç”Ÿçš„ API ä»‹é¢è¦æ”¾åœ¨å“ªå€‹ package
    modelPackage.set("com.example.demo.interfaces.dto") // ç”¢ç”Ÿçš„ DTO æ¨¡å‹è¦æ”¾åœ¨å“ªå€‹ package
    configOptions.set([
        hateoas: "false",
        interfaceOnly: "true",        // âœ¨ åªç”¢ç”Ÿä»‹é¢ï¼Œä¸ç”¢ç”Ÿå¯¦ä½œ
        useResponseEntity: "true",    // âœ¨ ä½¿ç”¨ Spring çš„ ResponseEntity<T> ä½œç‚ºå›å‚³å‹åˆ¥
        useSpringBoot3: "true",       // âœ¨ ç¢ºä¿èˆ‡ Spring Boot 3 ç›¸å®¹
        useTags: "true",              // âœ¨ æ ¹æ“š YAML ä¸­çš„ "tags" ç”¢ç”Ÿä¸åŒ API ä»‹é¢
        unhandledException: "true"    // âœ¨ å¼·åˆ¶é–‹ç™¼è€…è™•ç†ä¾‹å¤–
    ])
}
```

ConfigOptions é‡è¦åƒæ•¸è§£æ

- interfaceOnly: "true"

  - ç”¨é€”: åªç”¢ç”Ÿ API ä»‹é¢ï¼Œä¸ç”¢ç”Ÿ Controller å¯¦ä½œé¡åˆ¥
  - å„ªé»: é–‹ç™¼è€…å¯ä»¥è‡ªç”±å¯¦ä½œæ¥­å‹™é‚è¼¯ï¼Œä¿æŒç¨‹å¼ç¢¼çš„å½ˆæ€§
  - çµæœ: ç”¢ç”Ÿå¦‚ UserApi.java ä»‹é¢ï¼Œè€Œé UserApiController.java å¯¦ä½œé¡åˆ¥

- useSpringBoot3: "true"

  - é‡è¦æ€§: ç¢ºä¿ç”Ÿæˆçš„ç¨‹å¼ç¢¼èˆ‡ Spring Boot 3.x ç›¸å®¹
  - å½±éŸ¿: ä½¿ç”¨æ­£ç¢ºçš„ Jakarta EE è¨»è§£ï¼ˆè€ŒéèˆŠçš„ javaxï¼‰
  - ç¯„ä¾‹: ç”Ÿæˆ @jakarta.validation.Valid è€Œé @javax.validation.Valid

- useTags: "true"

  - åŠŸèƒ½: æ ¹æ“š OpenAPI è¦æ ¼ä¸­çš„ tags åˆ†çµ„ç”¢ç”Ÿä¸åŒçš„ API ä»‹é¢
  - ç¯„ä¾‹: å¦‚æœ YAML ä¸­æœ‰ tags: [users, orders]ï¼Œæœƒç”¢ç”Ÿ UsersApi.java å’Œ OrdersApi.java
  - å¥½è™•: é¿å…å–®ä¸€å·¨å¤§çš„ API ä»‹é¢ï¼Œæå‡ç¨‹å¼ç¢¼å¯ç¶­è­·æ€§

- useResponseEntity: "true"

  - ç”¨é€”: ä½¿ç”¨ Spring çš„ ResponseEntity<T> ä½œç‚ºå›å‚³å‹åˆ¥
  - å„ªé»: å¯ä»¥ç²¾ç¢ºæ§åˆ¶ HTTP ç‹€æ…‹ç¢¼ã€æ¨™é ­ç­‰å›æ‡‰ç´°ç¯€
  - ç¯„ä¾‹: ResponseEntity<User> getUser(Long id) è€Œé User getUser(Long id)

- unhandledException: "true"

  - ç›®çš„: å¼·åˆ¶é–‹ç™¼è€…æ˜ç¢ºè™•ç†å¯èƒ½çš„ä¾‹å¤–æƒ…æ³
  - æ•ˆæœ: åœ¨æ–¹æ³•ç°½åä¸­åŠ å…¥ throws Exception
  - å»ºè­°: æ­é… @ControllerAdvice çµ±ä¸€è™•ç†ä¾‹å¤–

- hateoas: "false"

  - èªªæ˜: ä¸å•Ÿç”¨ HATEOASï¼ˆHypermedia as the Engine of Application Stateï¼‰
  - é©ç”¨: ä¸€èˆ¬ RESTful API é€šå¸¸ä¸éœ€è¦ HATEOAS åŠŸèƒ½

å…¶ä¸­ `interfaceOnly: "true"` çš„è¨­å®šï¼Œå‘Šè¨´ç”¢ç”Ÿå™¨åªéœ€å®šç¾© API ä»‹é¢èˆ‡ DTOï¼Œè€Œ Controller çš„å…·é«”é‚è¼¯ç”±é–‹ç™¼è€…è‡ªè¡Œç·¨å¯«ã€‚é€™ç¨®æ–¹å¼æœ‰åŠ©æ–¼åˆ†é›¢ã€ŒAPI çš„å®šç¾©ã€å’Œã€Œæ¥­å‹™é‚è¼¯çš„å¯¦ç¾ã€ã€‚  

### API First çš„å„ªé»

- **å¥‘ç´„å³æ–‡ä»¶**ï¼š`openapi.yaml` æœ¬èº«å°±æ˜¯æœ€æº–ç¢ºçš„ API æ–‡ä»¶ã€‚
- **å¼·åˆ¶ä¸€è‡´æ€§**ï¼š`BookController` å¿…é ˆå¯¦ä½œ `BooksApi` ä»‹é¢ï¼Œä»»ä½•èˆ‡è¦æ ¼ä¸ç¬¦çš„ä¿®æ”¹éƒ½æœƒåœ¨ç·¨è­¯æ™‚æœŸå¼•ç™¼éŒ¯èª¤ã€‚
- **å¹³è¡Œé–‹ç™¼**ï¼šå¾Œç«¯åœ¨å¯¦ä½œæ¥­å‹™é‚è¼¯çš„åŒæ™‚ï¼Œå‰ç«¯æˆ–å…¶ä»–æœå‹™çš„é–‹ç™¼è€…å¯ä»¥ä½¿ç”¨ `openapi.yaml` ä¾†ç”¢ç”Ÿå®¢æˆ¶ç«¯ç¨‹å¼ç¢¼ (Client Stub) æˆ–å»ºç«‹ Mock Serverï¼Œç„¡éœ€ç­‰å¾…å¾Œç«¯é–‹ç™¼å®Œæˆã€‚

---

## ğŸ—ºï¸ ç‰©ä»¶æ˜ å°„ (MapStruct)

- `org.mapstruct:mapstruct`
- `org.mapstruct:mapstruct-processor` (annotationProcessor)

### ç”¨é€”

åœ¨åˆ†å±¤æ¶æ§‹ä¸­ï¼Œé€šå¸¸ä¸å¸Œæœ›å°‡è³‡æ–™åº«å¯¦é«” (Entity) ç›´æ¥æš´éœ²çµ¦å¤–éƒ¨ APIã€‚å› æ­¤ï¼Œéœ€è¦å®šç¾©è³‡æ–™å‚³è¼¸ç‰©ä»¶ (DTO)ã€‚MapStruct æ˜¯ä¸€å€‹ç·¨è­¯æœŸåŸ·è¡Œçš„ Java Bean æ˜ å°„å·¥å…·ï¼Œç”¨ä¾†è™•ç† DTO èˆ‡ Entity ä¹‹é–“çš„è½‰æ›å•é¡Œã€‚  

### å„ªé»

- **æ•ˆèƒ½**: åœ¨ç·¨è­¯æœŸç”¢ç”ŸåŸç”Ÿ Java ç¨‹å¼ç¢¼ï¼Œæ²’æœ‰åŸ·è¡ŒæœŸçš„åå°„æˆ–ä»£ç†ï¼Œæ•ˆèƒ½è¡¨ç¾è‰¯å¥½ã€‚
- **å‹åˆ¥å®‰å…¨**: æ‰€æœ‰æ˜ å°„éƒ½åœ¨ç·¨è­¯æœŸæª¢æŸ¥ï¼Œè‹¥æœ‰æ¬„ä½ä¸åŒ¹é…æˆ–å‹åˆ¥éŒ¯èª¤ï¼Œç·¨è­¯æœƒå¤±æ•—ã€‚
- **æ¸›å°‘æ¨£æ¿ç¨‹å¼ç¢¼**: é–‹ç™¼è€…åªéœ€å®šç¾©ä¸€å€‹ä»‹é¢ï¼ŒMapStruct å°±æœƒè‡ªå‹•ç”¢ç”Ÿå°æ‡‰çš„ get/set ç¨‹å¼ç¢¼ã€‚

### build.gradleä¸­çš„é—œéµè¨­å®š

```groovy
tasks.withType(JavaCompile) {
    options.compilerArgs = [
            '-Amapstruct.defaultComponentModel=spring' // å‘Šè¨´ MapStruct é è¨­ç”¢ç”Ÿ Spring Bean
    ]
}
```

### Mapper ä»‹é¢å®šç¾© (`BookMapper.java`)

æˆ‘å€‘å®šç¾©äº† `BookMapper` ä»‹é¢ï¼Œä¸¦ä½¿ç”¨ `@Mapper` è¨»è§£æ¨™è¨˜ã€‚é€éè¨­å®š `componentModel = "spring"`ï¼ŒMapStruct æœƒåœ¨å…¶ç”Ÿæˆçš„å¯¦ç¾é¡åˆ¥ `BookMapperImpl` ä¸ŠåŠ ä¸Š `@Component` è¨»è§£ï¼Œä½¿å…¶å¯ä»¥ä½œç‚ºä¸€å€‹ Spring Bean è¢«æ³¨å…¥åˆ°å…¶ä»–æœå‹™ä¸­ã€‚

```java
@Mapper(
    componentModel = "spring", // è®“ MapStruct ç”¢ç”Ÿ Spring Bean
    unmappedTargetPolicy = ReportingPolicy.IGNORE
)
public interface BookMapper {
    // å°‡ BookDto (DTO) è½‰æ›ç‚º Book (Entity)
    Book toEntity(BookDto dto);

    // å°‡ Book (Entity) è½‰æ›ç‚º BookDto (DTO)
    BookDto toDto(Book entity);
}
```

### ä½¿ç”¨ç¯„ä¾‹

```java
@RestController
@RequiredArgsConstructor // è‡ªå‹•æ³¨å…¥ final çš„æ¬„ä½
public class BookController implements BooksApi {

    private final BookService bookService;
    private final BookMapper bookMapper; // âœ¨ MapStruct Mapper è¢«æ³¨å…¥

    @Override
    public ResponseEntity<BookDto> booksPost(@Valid BookRequest bookRequest) {
        // å‘¼å« mapper å°‡å‚³å…¥çš„ Request DTO è½‰ç‚º Entity
        Book bookEntity = bookMapper.toEntity(bookRequest);
        Book createdBook = bookService.createBook(bookEntity);
        // å‘¼å« mapper å°‡å›å‚³çš„ Entity è½‰ç‚º Response DTO
        return ResponseEntity.status(HttpStatus.CREATED).body(bookMapper.toDto(createdBook));
    }
}
```

---

## ğŸ“œ è³‡æ–™åº«ç‰ˆæœ¬æ§åˆ¶ (Liquibase)

åœ¨åœ˜éšŠé–‹ç™¼ä¸­ï¼Œç®¡ç†è³‡æ–™åº«çµæ§‹ (Schema) çš„è®Šæ›´æ˜¯ä¸€å¤§æŒ‘æˆ°ã€‚å¦‚æœæ¯å€‹äººéƒ½åœ¨æœ¬åœ°éš¨æ„ä¿®æ”¹è³‡æ–™åº«ï¼Œæˆ–ä¾è³´ JPA çš„ `ddl-auto: update`ï¼Œå¯èƒ½å°è‡´é–‹ç™¼ã€æ¸¬è©¦å’Œæ­£å¼ç’°å¢ƒçš„è³‡æ–™åº«çµæ§‹ä¸ä¸€è‡´ï¼Œå¼•ç™¼é›£ä»¥è¿½è¹¤çš„éŒ¯èª¤ã€‚  
æœ¬å°ˆæ¡ˆæ¡ç”¨ Liquibase å°‡è³‡æ–™åº«çš„è®Šæ›´åƒç¨‹å¼ç¢¼ä¸€æ¨£é€²è¡Œç‰ˆæœ¬æ§åˆ¶ï¼Œä»¥ç¢ºä¿æ‰€æœ‰ç’°å¢ƒçš„è³‡æ–™åº«çµæ§‹éƒ½æ˜¯ä¸€è‡´ä¸”å¯è¿½æº¯çš„ã€‚  

### ç‚ºä»€éº¼ä¸ç”¨ ddl-auto?

é›–ç„¶ `spring.jpa.hibernate.ddl-auto = update` åœ¨é–‹ç™¼åˆæœŸå¾ˆæ–¹ä¾¿ï¼Œä½†å®ƒå­˜åœ¨ä¸€äº›å•é¡Œï¼š  

- **ç¼ºä¹æ§åˆ¶**: ä½ ç„¡æ³•ç²¾ç¢ºæ§åˆ¶å®ƒç”¢ç”Ÿçš„ SQLã€‚
- **è³‡æ–™éºå¤±é¢¨éšª**: åœ¨æŸäº›æƒ…æ³ä¸‹å¯èƒ½å°è‡´è³‡æ–™éºå¤±ã€‚
- **ç„¡ç‰ˆæœ¬ç´€éŒ„**: ä½ ä¸çŸ¥é“è³‡æ–™åº«åœ¨ä½•æ™‚ã€è¢«èª°ã€åšäº†å“ªäº›è®Šæ›´ã€‚
- **ä¸é©ç”¨æ–¼æ­£å¼ç’°å¢ƒ**: åœ¨æ­£å¼ç’°å¢ƒä½¿ç”¨ `update` æ˜¯ä¸è¢«æ¨è–¦çš„ã€‚

Liquibase é€éä¸€å€‹æ›´åš´è¬¹çš„æµç¨‹ä¾†æ‡‰å°é€™äº›å•é¡Œã€‚  

### Liquibase å¦‚ä½•é‹ä½œï¼Ÿ

- **è‡ªå‹•åŸ·è¡Œ**: ç•¶ Spring Boot æ‡‰ç”¨ç¨‹å¼å•Ÿå‹•æ™‚ï¼Œå®ƒæœƒè‡ªå‹•åµæ¸¬åˆ° Liquibase çš„å­˜åœ¨ï¼Œä¸¦åŸ·è¡Œè³‡æ–™åº«çš„é·ç§»ã€‚  
- **è®Šæ›´æ—¥èªŒ (Changelog)**: é–‹ç™¼è€…å°‡æ‰€æœ‰è³‡æ–™åº«è®Šæ›´ï¼ˆå¦‚å»ºè¡¨ã€åŠ æ¬„ä½ï¼‰å®šç¾©åœ¨ã€Œè®Šæ›´æ—¥èªŒã€æª”æ¡ˆä¸­ã€‚åœ¨æœ¬å°ˆæ¡ˆä¸­ï¼Œæˆ‘å€‘ä½¿ç”¨ YAML æ ¼å¼ã€‚  
- **è¿½è¹¤è¡¨**: Liquibase æœƒåœ¨ä½ çš„è³‡æ–™åº«ä¸­å»ºç«‹å…©å¼µè¿½è¹¤è¡¨ï¼š`DATABASECHANGELOG` å’Œ `DATABASECHANGELOGLOCK`ã€‚  
  - `DATABASECHANGELOGLOCK`: ç”¨ä¾†ç¢ºä¿åœ¨åŒä¸€æ™‚é–“åªæœ‰ä¸€å€‹æ‡‰ç”¨ç¨‹å¼å¯¦ä¾‹åœ¨åŸ·è¡Œè³‡æ–™åº«é·ç§»ï¼Œé˜²æ­¢è¡çªã€‚  
  - `DATABASECHANGELOG`: è¨˜éŒ„æ¯ä¸€å€‹å·²ç¶“è¢«æˆåŠŸåŸ·è¡Œçš„è®Šæ›´é›† (changeSet)ã€‚æ‡‰ç”¨ç¨‹å¼æ¯æ¬¡å•Ÿå‹•æ™‚ï¼ŒLiquibase æœƒæ¯”å°æ—¥èªŒæª”æ¡ˆå’Œé€™å¼µè¡¨ï¼ŒåªåŸ·è¡Œé‚£äº›å°šæœªè¢«è¨˜éŒ„çš„ã€æ–°çš„è®Šæ›´é›†ã€‚  

### å°ˆæ¡ˆå¯¦è¸

#### ä¸»è®Šæ›´æ—¥èªŒ (Master Changelog)

é€™æ˜¯ Liquibase çš„é€²å…¥é»ï¼Œä½æ–¼ `src/main/resources/db/changelog/db.changelog-master.yaml`ã€‚å®ƒæœ¬èº«ä¸åŒ…å«å…·é«”çš„è®Šæ›´ï¼Œè€Œæ˜¯åƒä¸€å€‹ç›®éŒ„ï¼Œè² è²¬å¼•å…¥å…¶ä»–çš„è®Šæ›´æ—¥èªŒæª”æ¡ˆã€‚  

```yaml
# db.changelog-master.yaml
databaseChangeLog:
  - include:
      file: history/20250614.yaml
      relativeToChangelogFile: true # è·¯å¾‘ç›¸å°æ–¼ç•¶å‰æª”æ¡ˆ
      description: åˆå§‹åŒ–è¡¨æ ¼
  # âœ¨ ç•¶æœ‰æ–°çš„è®Šæ›´æ™‚ï¼Œåœ¨é€™è£¡åŠ å…¥æ–°çš„ include
  # - include:
  #     file: history/20250615.yaml
  #     relativeToChangelogFile: true
  #     description: æ–°å¢ä½¿ç”¨è€…è¡¨æ ¼
```

#### è®Šæ›´é›†æª”æ¡ˆ (Changeset File)

æ‰€æœ‰å¯¦éš›çš„è³‡æ–™åº«çµæ§‹è®Šæ›´éƒ½å®šç¾©åœ¨é€™äº›æª”æ¡ˆè£¡ã€‚æˆ‘å€‘å°‡å®ƒå€‘å­˜æ”¾åœ¨ `history/` ç›®éŒ„ä¸‹ï¼Œä¸¦ä»¥æ—¥æœŸå‘½åï¼Œæ–¹ä¾¿è¿½æº¯ã€‚
ä¸€å€‹æª”æ¡ˆå¯ä»¥åŒ…å«å¤šå€‹ `changeSet`ã€‚æ¯å€‹ `changeSet` éƒ½æ˜¯ä¸€å€‹ä¸å¯è®Šçš„ã€åŸå­çš„è³‡æ–™åº«æ“ä½œå–®å…ƒï¼Œç”± `id` å’Œ `author` å”¯ä¸€è­˜åˆ¥ã€‚
è®“æˆ‘å€‘çœ‹çœ‹ `history/20250614.yaml` çš„å…§å®¹ï¼š

```yaml
# history/20250614.yaml
databaseChangeLog:
- changeSet:
    id: 1749857749130-1 # å”¯ä¸€ IDï¼Œå¯ä»¥æ˜¯æ•¸å­—ã€å­—ä¸²æˆ–è‡ªå‹•ç”Ÿæˆ
    author: samzhu (generated)
    changes:
    - createTable:
        tableName: book
        remarks: æ›¸æœ¬è³‡æ–™è¡¨ï¼Œç”¨æ–¼å„²å­˜æ›¸æœ¬çš„åŸºæœ¬è³‡è¨Š
        columns:
        - column:
            name: id
            type: INTEGER
            autoIncrement: true
            constraints:
              primaryKey: true
              nullable: false
        - column:
            name: title
            type: VARCHAR(255)
            constraints:
              nullable: false
        #... å…¶ä»–æ¬„ä½...
```

#### é–‹ç™¼æµç¨‹ï¼šå¦‚ä½•æ–°å¢ä¸€ç­†è³‡æ–™åº«è®Šæ›´ï¼Ÿ

å‡è¨­ä½ éœ€è¦ç‚º `book` è¡¨å¢åŠ ä¸€å€‹ `stock_quantity`ï¼ˆåº«å­˜æ•¸é‡ï¼‰æ¬„ä½ã€‚

1. **å»ºç«‹æ–°æª”æ¡ˆ**: åœ¨ `src/main/resources/db/changelog/history/` ç›®éŒ„ä¸‹å»ºç«‹ä¸€å€‹æ–°çš„ YAML æª”æ¡ˆï¼Œä¾‹å¦‚ `20250616-add-stock-to-book.yaml`ã€‚
2. **å®šç¾© ChangeSet**: åœ¨æ–°æª”æ¡ˆä¸­ï¼ŒåŠ å…¥ä½ çš„è®Šæ›´é›†ã€‚`id` å¿…é ˆæ˜¯å”¯ä¸€çš„ã€‚
3. **æ›´æ–°ä¸»æª”æ¡ˆ**: åœ¨ `db.changelog-master.yaml` ä¸­å¼•å…¥ä½ å‰›å‰›å»ºç«‹çš„æª”æ¡ˆã€‚

    ```yaml
    databaseChangeLog:
      - include:
          file: history/20250614.yaml
          relativeToChangelogFile: true
          description: åˆå§‹åŒ–è¡¨æ ¼
      - include: # âœ¨ æ–°å¢é€™ä¸€æ®µ
          file: history/20250616-add-stock-to-book.yaml
          relativeToChangelogFile: true
          description: ç‚ºæ›¸æœ¬æ–°å¢åº«å­˜æ¬„ä½
    ```

4. **å•Ÿå‹•æ‡‰ç”¨**: é‡æ–°å•Ÿå‹• Spring Boot æ‡‰ç”¨ã€‚Liquibase æœƒæª¢æŸ¥ `DATABASECHANGELOG` è¡¨ï¼Œç™¼ç¾é€™å€‹æ–°çš„ `changeSet` é‚„æ²’æœ‰è¢«åŸ·è¡Œéï¼Œæ–¼æ˜¯å®ƒæœƒåŸ·è¡Œå°æ‡‰çš„ `ALTER TABLE` SQL å‘½ä»¤ï¼Œç‚ºä½ çš„è³‡æ–™åº«åŠ ä¸Šæ–°æ¬„ä½ã€‚  

é€™å€‹æµç¨‹ç¢ºä¿äº†æ¯ä¸€æ¬¡è³‡æ–™åº«çš„è®Šæ›´éƒ½æœ‰ç´€éŒ„ã€å¯è¿½è¹¤ï¼Œä¸¦ä¸”èƒ½åœ¨åœ˜éšŠæ‰€æœ‰æˆå“¡å’Œæ‰€æœ‰ç’°å¢ƒä¸­è‡ªå‹•ä¸”ä¸€è‡´åœ°è¢«æ‡‰ç”¨ã€‚  

---

## âš¡ï¸ å¿«å–æ©Ÿåˆ¶ (Spring Cache + Redis)

ç‚ºäº†æå‡æ‡‰ç”¨ç¨‹å¼çš„å›æ‡‰é€Ÿåº¦ä¸¦é™ä½è³‡æ–™åº«çš„è² è¼‰ï¼Œæˆ‘å€‘å¼•å…¥äº†å¿«å–æ©Ÿåˆ¶ã€‚å°æ–¼é‚£äº›ä¸å¸¸è®Šå‹•ä½†è®€å–é »ç¹çš„è³‡æ–™ï¼Œå¿«å–æœ‰åŠ©æ–¼æå‡æ•ˆèƒ½ã€‚ Â³Â³
æœ¬å°ˆæ¡ˆæ¡ç”¨ **Spring Cache** ä½œç‚ºæŠ½è±¡å±¤ï¼Œä¸¦ä»¥ **Redis** ä½œç‚ºå…·é«”çš„å¿«å–å¯¦ç¾ã€‚  

### Spring Cache: ä¸€è‡´çš„å¿«å–æŠ½è±¡

`spring-boot-starter-cache` æä¾›äº†ä¸€å¥—æ¨™æº–çš„å¿«å–æŠ½è±¡ APIã€‚å®ƒçš„å„ªé»æ˜¯è®“æ¥­å‹™é‚è¼¯ç¨‹å¼ç¢¼èˆ‡å…·é«”çš„å¿«å–æŠ€è¡“è§£è€¦ã€‚é–‹ç™¼è€…åªéœ€ä½¿ç”¨å¹¾ç¨®æ¨™æº–è¨»è§£ï¼Œå°±èƒ½ç‚ºæ–¹æ³•åŠ ä¸Šå¿«å–åŠŸèƒ½ã€‚  

- `@EnableCaching`: åœ¨è¨­å®šé¡åˆ¥ä¸Šä½¿ç”¨ï¼Œæ˜¯å•Ÿç”¨ Spring Cache åŠŸèƒ½çš„ç¸½é–‹é—œã€‚  
- `@Cacheable`: ç”¨æ–¼è®€å–æ“ä½œã€‚åœ¨åŸ·è¡Œæ–¹æ³•å‰ï¼ŒSpring æœƒå…ˆæª¢æŸ¥å¿«å–ä¸­æ˜¯å¦å­˜åœ¨å°æ‡‰çš„è³‡æ–™ã€‚å¦‚æœå­˜åœ¨ï¼Œå‰‡ç›´æ¥å¾å¿«å–è¿”å›ï¼›å¦‚æœä¸å­˜åœ¨ï¼Œå‰‡åŸ·è¡Œæ–¹æ³•ï¼Œä¸¦å°‡å…¶å›å‚³çµæœå­˜å…¥å¿«å–å¾Œå†è¿”å›ã€‚  
- `@CacheEvict`: ç”¨æ–¼å¯«å…¥æˆ–åˆªé™¤æ“ä½œã€‚ç•¶è³‡æ–™ç™¼ç”Ÿè®Šæ›´æ™‚ï¼Œç”¨ä¾†å¾å¿«å–ä¸­æ¸…é™¤å°æ‡‰çš„è³‡æ–™ï¼Œä»¥é¿å…ä½¿ç”¨è€…è®€åˆ°éæœŸçš„èˆŠè³‡æ–™ã€‚  

### Redis: é«˜æ•ˆèƒ½çš„å¿«å–å¯¦ç¾

æˆ‘å€‘é¸æ“‡ Redis ä½œç‚ºå¿«å–ä¼ºæœå™¨ã€‚å¾—ç›Šæ–¼ Spring Boot çš„è‡ªå‹•è¨­å®šï¼Œæ•´åˆéç¨‹å¾ˆç›´æ¥ï¼š  

1. åœ¨ `build.gradle` ä¸­åŠ å…¥ `spring-boot-starter-data-redis` ä¾è³´ã€‚  
2. åœ¨ `application.yml` ä¸­è¨­å®š Redis çš„é€£ç·šè³‡è¨Šã€‚  

åªè¦é€™å…©æ­¥å®Œæˆï¼ŒSpring Boot å°±æœƒè‡ªå‹•å»ºç«‹ä¸€å€‹ `RedisCacheManager` ä½œç‚º Spring Cache çš„é è¨­å¯¦ç¾ã€‚  

### Cacheå¯¦è¸

å¯åƒè€ƒåœ¨ `BookService` ä¸­å¯¦ç¾çš„å¿«å–åŠŸèƒ½ã€‚  

#### ç­–ç•¥ï¼šåªå¿«å–é«˜é »è®€å–çš„å–®ä¸€é …ç›®

åœ¨æ–°çš„è¨­è¨ˆä¸­ï¼Œæˆ‘å€‘æ¡å–äº†æ›´ç²¾ç¢ºçš„å¿«å–ç­–ç•¥ã€‚æˆ‘å€‘æ„è­˜åˆ° `getAllBooks()`ï¼ˆç²å–æ‰€æœ‰æ›¸æœ¬ï¼‰é€™å€‹æ“ä½œå¯èƒ½è¿”å›è¼ƒå¤§çš„æ•¸æ“šé‡ï¼Œä¸”åˆ—è¡¨å…§å®¹æœƒå› ä»»ä½•æ›¸ç±çš„å¢åˆªæ”¹è€Œé »ç¹è®Šå‹•ï¼Œå¿«å–æ•´å€‹åˆ—è¡¨çš„æ•ˆç›Šä¸é«˜ã€‚  
å› æ­¤ï¼Œæˆ‘å€‘çš„ç­–ç•¥æ˜¯ï¼š**åªå¿«å– `getBookById(id)` é€™ç¨®é«˜é »ç‡ã€è®€å–å–®ä¸€é …ç›®çš„æ“ä½œ**ã€‚  

#### 1. å•Ÿç”¨å¿«å–åŠŸèƒ½

æˆ‘å€‘åœ¨ `CacheConfig.java` ä¸­å•Ÿç”¨å¿«å–ï¼Œä¸¦å®šç¾©å¿«å–ç©ºé–“çš„åç¨±ã€‚  

```java
// src/main/java/com/example/demo/config/CacheConfig.java
@Configuration
@EnableCaching // âœ¨ å•Ÿç”¨å¿«å–ç¸½é–‹é—œ
public class CacheConfig {
    /**
     * æ›¸æœ¬å¿«å–çš„åç¨±å¸¸é‡
     */
    public static final String BOOKS_CACHE = "books";
}
```

#### 2. å¿«å–å–®ä¸€æ›¸æœ¬çš„è®€å–æ“ä½œ

æˆ‘å€‘åªåœ¨ `getBookById` æ–¹æ³•ä¸ŠåŠ ä¸Š `@Cacheable`ã€‚æ³¨æ„ `key` çš„å¯«æ³•ï¼Œæˆ‘å€‘ä½¿ç”¨äº† Spring Expression Language (SpEL) ä¾†çµ„åˆä¸€å€‹æ›´æœ‰æ„ç¾©çš„éµå€¼ã€‚  

```java
// src/main/java/com/example/demo/applications/BookService.java
@Service
public class BookService {
    //...

    /**
     * æ ¹æ“š ID ç²å–æ›¸æœ¬
     * @Cacheable - å°‡çµæœå­˜å…¥ 'books' å¿«å–ï¼Œä¸¦ä»¥ 'book_{id}' ä½œç‚º key
     */
    @Cacheable(cacheNames = CacheConfig.BOOKS_CACHE, key = "'book_' + #id")
    public Book getBookById(Integer id) {
        log.info("å¾è³‡æ–™åº«ç²å–æ›¸æœ¬ ID: {}", id); // âœ¨ é€™è¡Œ log åªæœƒåœ¨å¿«å–æœªå‘½ä¸­æ™‚å°å‡º
        return bookRepository.findById(id)
           .orElseThrow(() -> new ResponseStatusException(HttpStatus.NOT_FOUND, "æ‰¾ä¸åˆ°æŒ‡å®šçš„æ›¸æœ¬"));
    }
}
```

`key = "'book_' + #id"`: é€™æ˜¯ä¸€å€‹æœ‰ç”¨çš„å¯¦è¸ã€‚å®ƒç‚ºæ‰€æœ‰æ›¸æœ¬ç›¸é—œçš„å¿«å–éµåŠ ä¸Šäº† `book_` å‰ç¶´ã€‚é€™æ¨£ï¼Œç•¶ `id` ç‚º `123` æ™‚ï¼Œåœ¨ Redis ä¸­å„²å­˜çš„éµå°±æ˜¯ `book_123`ï¼Œè€Œä¸æ˜¯å–®ç´”çš„ `123`ã€‚é€™æé«˜äº†éµçš„å¯è®€æ€§ï¼Œä¸¦é¿å…äº†èˆ‡å…¶ä»–å¯èƒ½ä¹Ÿä½¿ç”¨æ•¸å­— ID çš„å¿«å–ï¼ˆä¾‹å¦‚ `user_123`ï¼‰ç™¼ç”Ÿè¡çªã€‚  

#### 3. ç²¾ç¢ºåœ°æ¸…é™¤å–®ä¸€å¿«å–

å› ç‚ºæˆ‘å€‘ä¸å†å¿«å– `getAllBooks()` çš„åˆ—è¡¨ï¼Œæ‰€ä»¥åœ¨æ›´æ–°æˆ–åˆªé™¤æ™‚ï¼Œæˆ‘å€‘ä¹Ÿä¸éœ€è¦ä½¿ç”¨ `allEntries = true` ä¾†æ¸…ç©ºæ‰€æœ‰å¿«å–ã€‚æˆ‘å€‘åªéœ€è¦ç²¾ç¢ºåœ°æ¸…é™¤è¢«ä¿®æ”¹æˆ–åˆªé™¤çš„é‚£ä¸€æœ¬æ›¸çš„å¿«å–å³å¯ã€‚  

```java
// src/main/java/com/example/demo/applications/BookService.java
@Service
public class BookService {
    //...

    /**
     * æ›´æ–°æ›¸æœ¬
     * @CacheEvict - åªæ¸…é™¤ 'books' å¿«å–ä¸­ 'book_{id}' é€™å€‹ key å°æ‡‰çš„è³‡æ–™
     */
    @Transactional
    @CacheEvict(cacheNames = CacheConfig.BOOKS_CACHE, key = "'book_' + #id")
    public Book updateBook(Integer id, Book book) {
        //...
    }

    /**
     * åˆªé™¤æ›¸æœ¬
     * @CacheEvict - åŒæ¨£ï¼Œåªæ¸…é™¤è¢«åˆªé™¤çš„ç‰¹å®šæ›¸æœ¬å¿«å–
     */
    @Async
    @Transactional
    @CacheEvict(cacheNames = CacheConfig.BOOKS_CACHE, key = "'book_' + #id")
    public void deleteBook(Integer id) {
        //...
    }
}
```

`createBook` æ–¹æ³•ç¾åœ¨ä¸éœ€è¦ä»»ä½• `@CacheEvict` è¨»è§£ã€‚å› ç‚ºæ–°å¢ä¸€æœ¬æ›¸ï¼Œä¸¦ä¸æœƒè®“ä»»ä½•æ—¢æœ‰çš„å¿«å–è³‡æ–™è®Šå¾—ã€ŒéæœŸã€ã€‚  

#### ç­–ç•¥çš„å„ªå‹¢

é€™ç¨®ã€Œåªå¿«å–å–®ä¸€é …ç›®ã€çš„ç­–ç•¥æ›´ç‚ºç°¡æ½”ä¸”é«˜æ•ˆï¼š  

- **é‚è¼¯ç°¡å–®**: ä¸å†éœ€è¦è™•ç†åˆ—è¡¨å¿«å–å¤±æ•ˆçš„å•é¡Œã€‚  
- **æ•ˆèƒ½**: ç‚ºæœ€å¸¸è¦‹çš„ã€Œæ ¹æ“š ID æŸ¥è©³æƒ…ã€å ´æ™¯æä¾›äº†æ•ˆèƒ½ä¸Šçš„å¹«åŠ©ã€‚  
- **å¯«å…¥æ“ä½œ**: æ›´æ–°æˆ–åˆªé™¤æ“ä½œå°å¿«å–çš„å½±éŸ¿é™åˆ°æœ€ä½ï¼Œåªç²¾ç¢ºåœ°æ“ä½œä¸€å€‹éµï¼Œä¸æœƒå½±éŸ¿å…¶ä»–æœ‰æ•ˆçš„å¿«å–ã€‚  

---

## ğŸš€ æ•ˆèƒ½æå‡ï¼šJava 21 è™›æ“¬åŸ·è¡Œç·’

æœ¬å°ˆæ¡ˆå•Ÿç”¨ Java 21 çš„ç‰¹æ€§ä¹‹ä¸€ï¼š**è™›æ“¬åŸ·è¡Œç·’ (Virtual Threads)**ã€‚  

### å‚³çµ±åŸ·è¡Œç·’çš„å•é¡Œ

åœ¨å‚³çµ±æ¨¡å‹ä¸­ï¼Œä¸€å€‹ Java åŸ·è¡Œç·’ (Platform Thread) å°±æœƒä½”ç”¨ä¸€å€‹ä½œæ¥­ç³»çµ±åŸ·è¡Œç·’ã€‚å°æ–¼åƒ Web æœå‹™é€™æ¨£ I/O å¯†é›†çš„æ‡‰ç”¨ï¼ˆå¤§é‡æ™‚é–“èŠ±åœ¨ç­‰å¾…è³‡æ–™åº«ã€å¿«å–æˆ–å…¶ä»– API å›æ‡‰ï¼‰ï¼Œä½œæ¥­ç³»çµ±åŸ·è¡Œç·’æœƒé•·æ™‚é–“è™•æ–¼é˜»å¡ç‹€æ…‹ï¼Œä½†ä¾ç„¶ä½”ç”¨è‘—è¨˜æ†¶é«”å’Œæ ¸å¿ƒè³‡æºï¼Œå°è‡´ç³»çµ±èƒ½åŒæ™‚è™•ç†çš„è«‹æ±‚æ•¸é‡å—é™ã€‚  

### è™›æ“¬åŸ·è¡Œç·’çš„å„ªå‹¢

è™›æ“¬åŸ·è¡Œç·’æ˜¯ç”± JVM ç®¡ç†çš„è¼•é‡ç´šåŸ·è¡Œç·’ã€‚æˆåƒä¸Šè¬å€‹è™›æ“¬åŸ·è¡Œç·’å¯ä»¥é‹è¡Œåœ¨å°‘æ•¸å¹¾å€‹å¹³å°åŸ·è¡Œç·’ä¹‹ä¸Šã€‚ç•¶ä¸€å€‹è™›æ“¬åŸ·è¡Œç·’åŸ·è¡Œä¸€å€‹é˜»å¡ I/O æ“ä½œæ™‚ï¼š  

1. å®ƒä¸æœƒé˜»å¡ä½œæ¥­ç³»çµ±åŸ·è¡Œç·’ã€‚  
2. JVM æœƒå°‡å…¶æš«åœï¼Œä¸¦è®“åº•å±¤çš„ä½œæ¥­ç³»çµ±åŸ·è¡Œç·’å»è™•ç†å¦ä¸€å€‹è™›æ“¬åŸ·è¡Œç·’çš„ä»»å‹™ã€‚  
3. ç•¶ I/O æ“ä½œå®Œæˆå¾Œï¼ŒJVM æœƒå†å–šé†’åŸä¾†çš„è™›æ“¬åŸ·è¡Œç·’ç¹¼çºŒåŸ·è¡Œã€‚  

é€™ç¨®æ©Ÿåˆ¶æœ‰åŠ©æ–¼æå‡ I/O å¯†é›†å‹æ‡‰ç”¨çš„ååé‡ï¼Œè®“æ‡‰ç”¨ç¨‹å¼èƒ½ç”¨æ›´å°‘çš„ç¡¬é«”è³‡æºè™•ç†æ›´å¤šçš„ä½µç™¼è«‹æ±‚ã€‚  

### å¦‚ä½•å•Ÿç”¨ï¼Ÿ

åœ¨ Spring Boot 3.2+ ä¸­ï¼Œå•Ÿç”¨è™›æ“¬åŸ·è¡Œç·’åªéœ€åœ¨ `application.yml` ä¸­åŠ å…¥ä¸€è¡Œè¨­å®šï¼š  

```yaml
spring:
  threads:
    virtual:
      enabled: true
```

é€™è¡Œè¨­å®šæœƒå‘Šè¨´ Spring Boot ä½¿ç”¨è™›æ“¬åŸ·è¡Œç·’ä¾†è™•ç†æ‰€æœ‰å‚³å…¥çš„ HTTP è«‹æ±‚ã€‚  

---

## ğŸ”¬ ç¾ä»£åŒ–å¯è§€æ¸¬æ€§ (Observability) - ç¬¬ä¸€éƒ¨åˆ†ï¼šSpring çš„å¯¦è¸

åœ¨æˆ‘å€‘çš„æ‡‰ç”¨ç¨‹å¼ä¸­ï¼Œã€Œå¯è§€æ¸¬æ€§ã€æ˜¯ç‚ºäº†è§£æ±ºä¸€å€‹æ ¸å¿ƒå•é¡Œï¼šç•¶æ‡‰ç”¨ç¨‹å¼é‹è¡Œæ™‚ï¼Œå¦‚ä½•æ·±å…¥ç†è§£å…¶å…§éƒ¨è¡Œç‚ºï¼Œå¾è€Œå¿«é€Ÿåœ°è¨ºæ–·å•é¡Œã€å„ªåŒ–æ•ˆèƒ½ã€‚é€™å¥—ç³»çµ±å»ºç«‹åœ¨ä¸‰å¤§æ”¯æŸ±ä¹‹ä¸Šï¼š**æŒ‡æ¨™ (Metrics)**ã€**è¿½è¹¤ (Traces)** å’Œ **æ—¥èªŒ (Logs)**ã€‚  

- **æ—¥èªŒ (Logs)**: è¨˜éŒ„äº†ç³»çµ±ä¸­ç™¼ç”Ÿçš„é›¢æ•£äº‹ä»¶ã€‚å®ƒå€‘å›ç­”äº†ã€Œç™¼ç”Ÿäº†ä»€éº¼ï¼Ÿã€çš„å•é¡Œã€‚æ—¥èªŒå¯ä»¥æ˜¯çµæ§‹åŒ–çš„ï¼ˆå¦‚ JSONï¼‰ï¼Œä¹Ÿå¯ä»¥æ˜¯éçµæ§‹åŒ–çš„æ–‡æœ¬ã€‚  
- **æŒ‡æ¨™ (Metrics)**: æ˜¯åœ¨ä¸€æ®µæ™‚é–“å†…èšåˆçš„æ•¸å€¼æ•¸æ“šï¼Œé€šå¸¸ç”¨æ–¼è¡¡é‡ç³»çµ±çš„æ•´é«”å¥åº·ç‹€æ³å’Œæ€§èƒ½ã€‚å®ƒå€‘å›ç­”äº†ã€Œç³»çµ±è¡¨ç¾å¦‚ä½•ï¼Ÿã€çš„å•é¡Œï¼Œä¾‹å¦‚è«‹æ±‚ç‡ã€éŒ¯èª¤ç‡ã€å»¶é²ç­‰ã€‚  
- **è¿½è¹¤ (Traces)**: æç¹ªäº†ä¸€å€‹è«‹æ±‚åœ¨åˆ†æ•£å¼ç³»çµ±ä¸­ç©¿è¶Šå¤šå€‹æœå‹™çš„å®Œæ•´è·¯å¾‘ã€‚å®ƒå€‘å›ç­”äº†ã€Œè«‹æ±‚å»äº†å“ªè£¡ï¼Ÿã€ä»¥åŠã€Œç‚ºä»€éº¼é€™éº¼æ…¢ï¼Ÿã€çš„å•é¡Œã€‚ä¸€å€‹è¿½è¹¤ç”±å¤šå€‹è·¨åº¦ï¼ˆSpanï¼‰çµ„æˆï¼Œæ¯å€‹è·¨åº¦ä»£è¡¨ä¸€å€‹å·¥ä½œå–®å…ƒ ã€‚  

### Spring çš„ç¾ä»£è§€æ¸¬å“²å­¸

åœ¨é–‹å§‹æ’°å¯«ä»»ä½•è§€æ¸¬æ€§ç¨‹å¼ç¢¼ä¹‹å‰ï¼Œå…ˆç†è§£ Spring Boot 3 çš„è§€æ¸¬å“²å­¸ã€‚Micrometer èˆ‡ Spring Observability çš„æ ¸å¿ƒé–‹ç™¼è€… Jonatan Ivanov å¼·èª¿ï¼š  

> â€œIn these apps I don't create any Observations manually because basically everything that I would need is automatically instrumentedâ€¦â€
> (åœ¨é€™äº›æ‡‰ç”¨ç¨‹å¼ä¸­ï¼Œæˆ‘æ²’æœ‰æ‰‹å‹•å»ºç«‹ä»»ä½•è§€æ¸¬ï¼Œå› ç‚ºæˆ‘æ‰€éœ€è¦çš„åŸºæœ¬ä¸Šéƒ½å·²ç¶“è¢«æˆ‘ä½¿ç”¨çš„æ¡†æ¶/å‡½å¼åº«è‡ªå‹•æª¢æ¸¬äº†â€¦)

é€™æ®µè©±æ­ç¤ºäº†ä¸€å€‹æ ¸å¿ƒæ€æƒ³ï¼š**å„ªå…ˆä¾è³´è‡ªå‹•åŒ–æª¢æ¸¬ (Rely on Automatic Instrumentation First)**ã€‚  
ç•¶æˆ‘å€‘å¼•å…¥ `spring-boot-starter-actuator` å’Œç›¸é—œçš„å¯è§€æ¸¬æ€§ä¾è³´æ™‚ï¼ŒSpring Boot çš„ç”Ÿæ…‹ç³»çµ±å·²ç¶“ç‚ºæˆ‘å€‘è‡ªå‹•æª¢æ¸¬äº†å¤§é‡å¸¸è¦‹çš„æŠ€è¡“äº’å‹•ï¼ŒåŒ…æ‹¬ï¼š  

- å‚³å…¥çš„ HTTP Server è«‹æ±‚  
- ç™¼å‡ºçš„ RestTemplate è«‹æ±‚  
- è³‡æ–™åº« JDBC æŸ¥è©¢  
- Redis æ“ä½œ  
- ...ç­‰ç­‰  

é€™æ„å‘³è‘—æˆ‘å€‘ç„¡éœ€ä»»ä½•é¡å¤–è¨­å®šï¼Œå°±èƒ½åœ¨ç›£æ§å¾Œå°çœ‹åˆ°é€™äº›åŸºç¤è¨­æ–½å±¤é¢çš„æŒ‡æ¨™å’Œè¿½è¹¤ã€‚  

é‚£éº¼ï¼Œæˆ‘å€‘ä»€éº¼æ™‚å€™æ‰éœ€è¦è‡ªå·±å‹•æ‰‹ï¼Ÿ  
**ç­”æ¡ˆæ˜¯ï¼šç•¶è‡ªå‹•åŒ–æª¢æ¸¬ç„¡æ³•è§¸åŠï¼Œè€Œæˆ‘å€‘åˆæƒ³æ·±å…¥æ´å¯Ÿå…¶å…§éƒ¨è¡Œç‚ºçš„è‡ªè¨‚æ ¸å¿ƒæ¥­å‹™é‚è¼¯æ™‚ã€‚**ä¾‹å¦‚ï¼Œåœ¨æˆ‘å€‘çš„ `BookService` ä¸­ï¼Œ`createBook` æ–¹æ³•åŒ…å«äº†æª¢æŸ¥ ISBNã€è¨­å®šæ™‚é–“æˆ³ã€å„²å­˜å¯¦é«”ç­‰å¤šå€‹æ­¥é©Ÿã€‚æˆ‘å€‘å¸Œæœ›å°‡æ•´å€‹ `createBook` æ“ä½œè¦–ç‚ºä¸€å€‹ç¨ç«‹çš„ã€æœ‰æ¥­å‹™æ„ç¾©çš„å–®å…ƒä¾†é€²è¡Œè§€æ¸¬ã€‚  
é€™å°±æ˜¯ Micrometer å’Œ `@Observed` è¨»è§£å¯ä»¥ç™¼æ®ä½œç”¨çš„åœ°æ–¹ã€‚  

### `@Observed`: ä¸€ç¨®é©ç”¨æ–¼è§€æ¸¬æ ¸å¿ƒæ¥­å‹™é‚è¼¯çš„å·¥å…·

Micrometer æ˜¯ Spring å®˜æ–¹æŒ‡å®šçš„è§€æ¸¬æ€§é–€é¢ (Facade)ï¼Œå®ƒæä¾›äº†ä¸€å¥—æ¨™æº–åŒ–çš„ APIï¼Œè®“æˆ‘å€‘çš„ç¨‹å¼ç¢¼å¯ä»¥å°ˆæ³¨æ–¼ã€Œè§€æ¸¬çš„æ„åœ–ã€ï¼Œè€Œä¸ç”¨é—œå¿ƒåº•å±¤çš„å¯¦ç¾ç´°ç¯€ã€‚  
åœ¨ Micrometer çš„ç”Ÿæ…‹ä¸­ï¼Œ`@Observed` è¨»è§£æ˜¯ç‚ºæˆ‘å€‘çš„è‡ªè¨‚æ¥­å‹™é‚è¼¯åŠ ä¸Šè§€æ¸¬èƒ½åŠ›çš„ä¸€ç¨®æœ‰æ•ˆå¯¦è¸ã€‚Jonatan Ivanov é—¡è¿°äº†å…¶æ ¸å¿ƒåƒ¹å€¼ï¼š  

> â€œThe idea... was that we want the users to instrument their code once using a single API and have multiple benefits out of it (e.g. metrics, tracing, logging).â€
> (æˆ‘å€‘çš„åˆè¡·æ˜¯ï¼Œå¸Œæœ›ä½¿ç”¨è€…èƒ½ç”¨ä¸€å¥— API ä¾†æª¢æ¸¬ä»–å€‘çš„ç¨‹å¼ç¢¼ä¸€æ¬¡ï¼Œä¸¦å¾ä¸­ç²å¾—å¤šé‡æ•ˆç›Šï¼Œä¾‹å¦‚ï¼šæŒ‡æ¨™ã€è¿½è¹¤ã€æ—¥èªŒã€‚)

é€™å°±æ˜¯ `@Observed` çš„æ ¸å¿ƒç†å¿µï¼š**ã€Œä¸€æ¬¡æª¢æ¸¬ï¼Œå¤šé‡æ•ˆç›Šã€**ã€‚  

#### ç‚ºä½•ä¸ç›´æ¥ç”¨ SDK æˆ– Java Agentï¼Ÿ  

- **ç›¸è¼ƒæ–¼ç›´æ¥ä½¿ç”¨ OpenTelemetry SDK**: ç›´æ¥ä½¿ç”¨ SDK éœ€è¦ä½ æ‰‹å‹•ç·¨å¯« Span çš„é–‹å§‹ã€çµæŸã€è¨­å®šå±¬æ€§ã€ç®¡ç†ä¸Šä¸‹æ–‡ç­‰ç¨‹å¼ç¢¼ï¼Œä¸åƒ…å·¥ä½œé‡å¤§ï¼Œè€Œä¸”å®¹æ˜“å‡ºéŒ¯æˆ–éºæ¼ï¼ŒåŒæ™‚ä¹Ÿè®“æ¥­å‹™ç¨‹å¼ç¢¼èˆ‡ç‰¹å®šå·¥å…·ç·Šå¯†è€¦åˆã€‚`@Observed` ä»¥å®£å‘Šå¼çš„æ–¹å¼å°‡é€™ä¸€åˆ‡éƒ½è‡ªå‹•åŒ–äº†ã€‚
- **ç›¸è¼ƒæ–¼ä½¿ç”¨ OpenTelemetry Java Agent**: Agent å°æ–¼è‡ªå‹•æª¢æ¸¬ç¬¬ä¸‰æ–¹å‡½å¼åº«å¾ˆæœ‰æ•ˆï¼Œä½†å®ƒç„¡æ³•ç†è§£ä½ è‡ªè¨‚çš„æ¥­å‹™æ–¹æ³•ï¼ˆå¦‚ `createBook`ï¼‰çš„å…·é«”èªç¾©å’Œå‘½åã€‚`@Observed` å‰‡è®“ä½ èƒ½å¤ ç²¾ç¢ºåœ°ç‚ºæ¥­å‹™æ–¹æ³•å‘½åï¼Œä½¿å…¶åœ¨ç›£æ§å¾Œå°å…·æœ‰æ›´æ¸…æ™°çš„å¯è®€æ€§ã€‚

`@Observed` è¨»è§£åœ¨å®£å‘Šå¼è§€æ¸¬èˆ‡ç¨‹å¼ç¢¼ä¾µå…¥æ€§ä¹‹é–“ï¼Œæä¾›äº†ä¸€å€‹è¼ƒå¥½çš„å¹³è¡¡ã€‚å®ƒæ¯”ç›´æ¥ä½¿ç”¨ SDK ç°¡æ½”ï¼ŒåŒæ™‚åˆæ¯” Java Agent åœ¨æª¢æ¸¬è‡ªè¨‚æ¥­å‹™é‚è¼¯æ™‚æ›´å…·å½ˆæ€§ã€‚  

### `@Observed` å•Ÿç”¨èˆ‡å¯¦è¸æŒ‡å—

éš¨è‘— Spring Boot çš„ç‰ˆæœ¬æ¼”é€²ï¼Œä½¿ç”¨ `@Observed` çš„è¨­å®šå·²ç›¸ç•¶ç°¡åŒ–ã€‚

#### æ­¥é©Ÿ 1ï¼šåŠ å…¥æ ¸å¿ƒä¾è³´

åœ¨ `build.gradle` ä¸­ï¼Œç¢ºä¿æœ‰ä»¥ä¸‹å…©å€‹é—œéµä¾è³´ï¼š

```groovy
// build.gradle
dependencies {
    // æä¾›äº† Micrometer è§€æ¸¬åŠŸèƒ½çš„åŸºç¤ï¼Œæ˜¯æ‰€æœ‰è§€æ¸¬åŠŸèƒ½çš„åŸºçŸ³
    implementation 'org.springframework.boot:spring-boot-starter-actuator'

    // æä¾›äº† AOP (é¢å‘åˆ‡é¢ç·¨ç¨‹) çš„èƒ½åŠ›ï¼Œé€™æ˜¯ @Observed èƒ½é‹ä½œçš„æŠ€è¡“åŸºç¤
    implementation 'org.springframework.boot:spring-boot-starter-aop'
}
```

#### æ­¥é©Ÿ 2ï¼šé–‹å•Ÿå…¨åŸŸé–‹é—œ

åœ¨ `application.yml` ä¸­ï¼Œæ˜ç¢ºåœ°å•Ÿç”¨åŸºæ–¼è¨»è§£çš„è§€æ¸¬åŠŸèƒ½ï¼š Â³â´

```yaml
# src/main/resources/application.yml
management:
  observations:
    annotations:
      enabled: true  # @Observed åŠŸèƒ½çš„ç¸½é–‹é—œ
```

#### æ­¥é©Ÿ 3ï¼šè¨­å®šéåŒæ­¥è¿½è¹¤ (å¦‚æœ‰éœ€è¦)

Jonatan Ivanov æåˆ°ï¼Œå¾ Spring Boot 3.2.0 é–‹å§‹ï¼Œ`ObservedAspect` é€™å€‹è®“ `@Observed` ç”Ÿæ•ˆçš„æ ¸å¿ƒ Bean å·²ç¶“è¢« Spring Boot è‡ªå‹•è¨­å®šäº†ã€‚å› æ­¤ï¼Œä½ ä¸å†éœ€è¦æ‰‹å‹•å»å®£å‘Š `ObservedAspect` çš„ `@Bean`ã€‚  
ç¾åœ¨ï¼Œåªæœ‰ç•¶ä½ çš„å°ˆæ¡ˆä¸­ä½¿ç”¨äº† `@Async` ç­‰éåŒæ­¥è™•ç†æ™‚ï¼Œç‚ºäº†ç¢ºä¿è¿½è¹¤ä¸Šä¸‹æ–‡èƒ½å¤ åœ¨ä¸åŒåŸ·è¡Œç·’ä¹‹é–“æ­£ç¢ºå‚³æ’­ï¼Œä½ æ‰éœ€è¦å»ºç«‹ä»¥ä¸‹çš„è¨­å®šæª”ï¼š  

```java
// src/main/java/com/example/demo/config/ObservabilityConfig.java
@Configuration(proxyBeanMethods = false)
public class ObservabilityConfig {

    /**
     * ç‚ºäº†è®“è¿½è¹¤åœ¨éåŒæ­¥åŸ·è¡Œç·’ä¸­ä¹Ÿèƒ½æ­£ç¢ºå‚³æ’­ï¼Œæˆ‘å€‘éœ€è¦é…ç½®ä¸€å€‹ TaskExecutorã€‚
     * ContextPropagatingTaskDecorator æœƒè‡ªå‹•å°‡ç•¶å‰åŸ·è¡Œç·’çš„è¿½è¹¤ä¸Šä¸‹æ–‡ (å¦‚ traceId) è¤‡è£½åˆ°
     * å³å°‡åŸ·è¡Œ @Async ä»»å‹™çš„æ–°åŸ·è¡Œç·’ä¸­ï¼Œç¢ºä¿è¿½è¹¤éˆçš„å®Œæ•´æ€§ã€‚
     */
    @Bean
    public TaskExecutor taskExecutor() {
        ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor();
        executor.setTaskDecorator(new ContextPropagatingTaskDecorator());
        return executor;
    }
}
```

**æ³¨æ„**ï¼šå¦‚æœæ‚¨çš„å°ˆæ¡ˆä¸­å®Œå…¨æ²’æœ‰ä½¿ç”¨ `@Async`ï¼Œé‚£éº¼æ‚¨ç”šè‡³ä¸éœ€è¦å»ºç«‹ `ObservabilityConfig.java` é€™å€‹æª”æ¡ˆã€‚

#### æ­¥é©Ÿ 4ï¼šåœ¨æ¥­å‹™é‚è¼¯ä¸­æ‡‰ç”¨è¨»è§£

`BookService` ç¨‹å¼ç¢¼åœ¨ `@Observed` çš„ä½¿ç”¨ä¸Šï¼Œå¼•å…¥äº†èªç¾©åŒ–å‘½åå’Œè‡ªè¨‚æ¨™ç±¤ï¼Œé€™æ˜¯ä¸€å€‹é€²éšå¯¦è¸ã€‚  

```java
// src/main/java/com/example/demo/applications/BookService.java
@Service
public class BookService {

    /**
     * æ ¹æ“š ID ç²å–æ›¸æœ¬
     * @Cacheable - ä½¿ç”¨ 'book_{id}' ä½œç‚ºå¿«å–éµå€¼ï¼Œå¢åŠ éµåå¯è®€æ€§
     */
    @Cacheable(cacheNames = CacheConfig.BOOKS_CACHE, key = "'book_' + #id")
    @Observed(
        name = "book.details.view",
        contextualName = "æ›¸æœ¬è©³æƒ…æŸ¥çœ‹",
        lowCardinalityKeyValues = {
            "operation", "get_by_id",
            "cache_enabled", "true"
        }
    )
    public Book getBookById(Integer id) {
        //... æ¥­å‹™é‚è¼¯...
    }

    /**
     * æ›´æ–°æ›¸æœ¬
     * @CacheEvict - åªæ¸…é™¤è¢«æ›´æ–°çš„ç‰¹å®šæ›¸æœ¬å¿«å–
     */
    @Transactional
    @CacheEvict(cacheNames = CacheConfig.BOOKS_CACHE, key = "'book_' + #id")
    @Observed(
        name = "book.inventory.update",
        contextualName = "æ›¸æœ¬è³‡è¨Šæ›´æ–°",
        lowCardinalityKeyValues = {
            "operation", "update",
            "cache_evict", "single",
            "business_impact", "medium"
        }
    )
    public Book updateBook(Integer id, Book book) {
        //... æ¥­å‹™é‚è¼¯...
    }
}
```

`@Observed` è¨»è§£åŒ…å«äº†æ›´è±å¯Œçš„è³‡è¨Šï¼š

- **`name`**: æŒ‡æ¨™çš„åç¨± (`book.details.view`)ã€‚æˆ‘å€‘æ¡ç”¨äº† `é ˜åŸŸ.å­åŸŸ.å‹•ä½œ` çš„å‘½åé¢¨æ ¼ï¼Œé€™æ¯” `books.get_by_id` æ›´èƒ½é«”ç¾æ¥­å‹™æ­¸å±¬ï¼Œæ–¹ä¾¿åœ¨ç›£æ§ç³»çµ±ä¸­é€²è¡Œåˆ†çµ„å’Œç¯©é¸ã€‚
- **`contextualName`**: è¿½è¹¤ Span çš„åç¨± (`æ›¸æœ¬è©³æƒ…æŸ¥çœ‹`)ã€‚æˆ‘å€‘ç›´æ¥ä½¿ç”¨ä¸­æ–‡æ¥­å‹™è¡“èªï¼Œè®“éæŠ€è¡“äººå“¡æˆ–ç”¢å“ç¶“ç†åœ¨æŸ¥çœ‹è¿½è¹¤éˆè·¯æ™‚ï¼Œä¹Ÿèƒ½çœ‹æ‡‚æ¯å€‹æ­¥é©Ÿä»£è¡¨çš„æ¥­å‹™æ„ç¾©ã€‚
- **`lowCardinalityKeyValues`**: é€™æ˜¯ä¸€å€‹å¾ˆå¯¦ç”¨çš„åŠŸèƒ½ã€‚å®ƒå…è¨±æˆ‘å€‘ç‚ºæŒ‡æ¨™å’Œè¿½è¹¤é™„åŠ è‡ªè¨‚çš„ Key-Value æ¨™ç±¤ (Tags)ã€‚
  - **ä»€éº¼æ˜¯ä½åŸºæ•¸ (Low Cardinality)ï¼Ÿ** ã€ŒåŸºæ•¸ã€æŒ‡çš„æ˜¯ä¸€å€‹æ¨™ç±¤å¯èƒ½å‡ºç¾çš„ä¸åŒå€¼çš„æ•¸é‡ã€‚ä½åŸºæ•¸ä»£è¡¨å€¼çš„ç¨®é¡æ˜¯æœ‰é™ä¸”å¯é æ¸¬çš„ï¼ˆä¾‹å¦‚ï¼š`operation` çš„å€¼å¯èƒ½æ˜¯ `create`, `update`, `delete`ï¼‰ã€‚æˆ‘å€‘æ‡‰è©²åªå°‡ä½åŸºæ•¸çš„æ¨™ç±¤æ”¾åœ¨é€™è£¡ï¼Œå› ç‚ºç›£æ§å¾Œç«¯éœ€è¦å°é€™äº›æ¨™ç±¤å»ºç«‹ç´¢å¼•ä»¥ä¾¿å¿«é€ŸæŸ¥è©¢å’Œåˆ†çµ„ã€‚
  - **åƒè¬ä¸è¦**å°‡é«˜åŸºæ•¸çš„å€¼ï¼ˆå¦‚ `book_id`, `user_id`, `trace_id`ï¼‰æ”¾åœ¨é€™è£¡ï¼Œå¦å‰‡æœƒå°è‡´ç›£æ§ç³»çµ±çš„ç´¢å¼•çˆ†ç‚¸ï¼Œé€ æˆæ•ˆèƒ½å•é¡Œã€‚
  - **å¦‚ä½•ä½¿ç”¨**: ä»¥ `{ "key1", "value1", "key2", "value2" }` çš„å½¢å¼æä¾›ã€‚

### å¾æŠ€è¡“ç›£æ§åˆ°æ¥­å‹™æ´å¯Ÿ

é€éé€™ç¨®å¸¶æœ‰æ¥­å‹™èªç¾©çš„æª¢æ¸¬æ–¹å¼ï¼Œé™æ¸¬æ•¸æ“šèƒ½æä¾›é™¤äº†æŠ€è¡“æŒ‡æ¨™å¤–çš„æ¥­å‹™æ´å¯Ÿã€‚  
ä»¥æˆ‘å€‘æ–°çš„è¨»è§£ç‚ºä¾‹ï¼Œä½ ç¾åœ¨å¯ä»¥ç›´æ¥åœ¨ Grafana ç­‰ç›£æ§ç³»çµ±ä¸­æå‡ºé€™æ¨£çš„å•é¡Œï¼š  

- **åˆ†æé¡§å®¢è¡Œç‚º**:
  - `getAllBooks` è¢«æ¨™è¨˜ç‚º `book.catalog.browse`ï¼Œæˆ‘å€‘å¯ä»¥çµ±è¨ˆã€Œé¡§å®¢ç€è¦½å•†å“ç›®éŒ„çš„é »ç‡æœ‰å¤šé«˜ï¼Ÿã€
  - `getBookById` è¢«æ¨™è¨˜ç‚º `book.details.view`ï¼Œæˆ‘å€‘å¯ä»¥åˆ†æã€Œé¡§å®¢å¹³å‡æœƒé»é–‹å¤šå°‘æœ¬æ›¸çš„è©³æƒ…é ï¼Ÿã€
- **è©•ä¼°åº«å­˜ç®¡ç†æ•ˆç‡**:
  - é€éç¯©é¸ `operation` æ¨™ç±¤ (`create`, `update`, `remove`)ï¼Œæˆ‘å€‘å¯ä»¥å»ºç«‹å„€è¡¨æ¿ï¼Œåˆ†åˆ¥é¡¯ç¤ºã€Œæ¯æ—¥æ–°æ›¸ä¸Šæ¶æ•¸é‡ã€ã€ã€Œè³‡è¨Šæ›´æ–°é »æ¬¡ã€å’Œã€Œå•†å“ä¸‹æ¶æ•¸é‡ã€ã€‚
- **é‡åŒ–æ¥­å‹™å½±éŸ¿åŠ›**:
  - æˆ‘å€‘ç‚ºä¸åŒçš„æ“ä½œå®šç¾©äº† `business_impact` æ¨™ç±¤ï¼ˆå¦‚ `high`, `medium`ï¼‰ã€‚ç¾åœ¨ï¼Œæˆ‘å€‘å¯ä»¥è¨­å®šæ›´æ™ºæ…§çš„è­¦å ±è¦å‰‡ï¼Œä¾‹å¦‚ï¼šã€Œåªæœ‰ç•¶ `business_impact` ç‚º `high` çš„æ“ä½œï¼ˆå¦‚ä¸‹æ¶å•†å“ï¼‰éŒ¯èª¤ç‡è¶…é 1% æ™‚ï¼Œæ‰ç™¼é€ç·Šæ€¥è­¦å ±ã€ï¼Œå¾è€Œè®“åœ˜éšŠèƒ½å°ˆæ³¨æ–¼çœŸæ­£å½±éŸ¿æ ¸å¿ƒæ¥­å‹™çš„å•é¡Œã€‚
- **å„ªåŒ–ç³»çµ±æ•ˆèƒ½**:
  - é€é `cache_enabled` å’Œ `cache_evict` æ¨™ç±¤ï¼Œæˆ‘å€‘å¯ä»¥ç²¾ç¢ºæ¯”è¼ƒã€Œæœ‰å¿«å–å’Œç„¡å¿«å–æ“ä½œçš„å»¶é²å·®ç•°ã€ï¼Œæˆ–è€…åˆ†æã€Œæ¸…é™¤å–®ä¸€å¿«å–å°ç³»çµ±æ•ˆèƒ½çš„å½±éŸ¿ã€ï¼Œç‚ºæœªä¾†çš„æ¶æ§‹å„ªåŒ–æä¾›æ•¸æ“šæ”¯æŒã€‚

ç¸½çµä¾†èªªï¼Œé€™ç¨® `@Observed` çš„ç”¨æ³•ï¼Œæœ‰åŠ©æ–¼æ·±åŒ–å¯è§€æ¸¬æ€§çš„æ‡‰ç”¨ï¼Œè®“é–‹ç™¼è€…èƒ½å¤ ç”¨æ¥­å‹™çš„èªè¨€ä¾†åº¦é‡å’Œåˆ†æè‡ªå·±çš„ç³»çµ±ï¼Œä½¿å¾—ç›£æ§æ•¸æ“šå°æ•´å€‹åœ˜éšŠï¼ˆåŒ…æ‹¬ç”¢å“ã€ç‡Ÿé‹å’Œç®¡ç†å±¤ï¼‰éƒ½ç”¢ç”Ÿåƒ¹å€¼ã€‚

---

## ğŸ”¬ ç¾ä»£åŒ–å¯è§€æ¸¬æ€§ (Observability) - ç¬¬äºŒéƒ¨åˆ†ï¼šèˆ‡ OpenTelemetry çš„å”åŒé‹ä½œ

åœ¨ç¬¬ä¸€éƒ¨åˆ†ï¼Œæˆ‘å€‘å­¸æœƒäº†å¦‚ä½•é€é `@Observed` è¨»è§£ä¾†ç‚ºæ¥­å‹™é‚è¼¯åŠ ä¸Šè§€æ¸¬èƒ½åŠ›ã€‚ç¾åœ¨ï¼Œæˆ‘å€‘å°‡æ·±å…¥å¹•å¾Œï¼Œæ­ç¤ºæ”¯æ’é€™ä¸€åˆ‡çš„å„å€‹æŠ€è¡“å¥—ä»¶æ˜¯å¦‚ä½•åœ¨ Spring Boot çš„ç”Ÿæ…‹ç³»çµ±ä¸­åˆ†å·¥åˆä½œï¼Œæœ€çµ‚å°‡é™æ¸¬æ•¸æ“šè½‰æ›ç‚º OpenTelemetry æ ¼å¼ä¸¦ç™¼é€å‡ºå»çš„ã€‚

### æ•´ç†æ¶æ§‹

```mermaid
graph TD
    subgraph "åŸ·è¡Œç’°å¢ƒ"
        User[ğŸ‘¨â€ğŸ’» ä½¿ç”¨è€…]
        App
        DB
        Cache
    end

    subgraph "otel-lgtm å…§éƒ¨"
        Developer[ğŸ‘¨â€ğŸ’» é–‹ç™¼è€…]
        Grafana[ğŸ“Š Grafana]
        Tempo
        Mimir[ğŸ“‰ Mimir - Metrics]
        Loki[ğŸ“œ Loki - Logs]
        Collector
    end

    User -->|HTTP API è«‹æ±‚| App
    App -->|JDBC| DB
    App -->|Redis Commands| Cache
    App -->|OTLP - gRPC/HTTP| Collector
    Collector --> Tempo
    Collector --> Mimir
    Collector --> Loki
    Grafana -->|æŸ¥è©¢| Tempo
    Grafana -->|æŸ¥è©¢| Mimir
    Grafana -->|æŸ¥è©¢| Loki
    Developer -->|ç€è¦½| Grafana
```

### åˆ†å±¤æ¶æ§‹ï¼šè§£è€¦èˆ‡å”ä½œ

ç†è§£é€™äº›å¥—ä»¶é—œä¿‚çš„é—œéµï¼Œåœ¨æ–¼æŒæ¡ Spring Boot 3 çš„è§€æ¸¬æ€§åˆ†å±¤æ¶æ§‹ï¼š

1. **æª¢æ¸¬å±¤ (Instrumentation API)**: æˆ‘å€‘é–‹ç™¼è€…äº’å‹•çš„åœ°æ–¹ï¼Œä¸»è¦ä½¿ç”¨ `@Observed`ã€‚
2. **é–€é¢å±¤ (Facade API)**: ç”± Micrometer æä¾›ã€‚å®ƒå®šç¾©äº†ä¸€å¥—ä¸­ç«‹çš„ã€æ¨™æº–åŒ–çš„ APIã€‚
3. **å¯¦ç¾å±¤ (Implementation)**: ç”± OpenTelemetry æ“”ä»»ã€‚å®ƒæ˜¯å¯¦ç¾ Micrometer API èƒŒå¾Œçš„å¼•æ“ã€‚
4. **åŒ¯å‡ºå±¤ (Export)**: ç”±å„ç¨® Exporter çµ„æˆï¼Œè² è²¬å°‡é™æ¸¬æ•¸æ“šæ‰“åŒ…æˆ OTLP æ ¼å¼ä¸¦ç™¼é€åˆ°ç›£æ§å¾Œç«¯ã€‚

### é—œéµå¥—ä»¶çš„è·è²¬èˆ‡æ•¸æ“šæµ

ä¸‹åœ–æ¸…æ™°åœ°å±•ç¤ºäº†ç•¶ä¸€å€‹å¸¶æœ‰ `@Observed` çš„æ–¹æ³•è¢«å‘¼å«æ™‚ï¼ŒæŒ‡æ¨™ (Metrics) è¿½è¹¤ (Traces) å’Œ Log (ç´€éŒ„) æ•¸æ“šæœƒå„è‡ªç¶“æ­·ä¸åŒçš„è™•ç†æµç¨‹ã€‚

```mermaid
graph TD
    subgraph APP["æ‡‰ç”¨ç¨‹å¼å…§éƒ¨"]
        A["æ¥­å‹™æ–¹æ³•<br/>åŸ·è¡Œ log.info"] -->|"@Observed"| B["Micrometer Observation<br/>çµ±ä¸€é–€é¢ API"]

        subgraph TRACES["è¿½è¹¤æ•¸æ“šæµ"]
            B -.->|"å‰µå»º Span"| C_T["micrometer-tracing<br/>æ ¸å¿ƒè¿½è¹¤ API"]
            C_T --> D_T["micrometer-tracing-bridge-otel<br/>æ©‹æ¥åˆ° OTel"]
            D_T --> F_T["OpenTelemetry SDK<br/>é™æ¸¬æ•¸æ“šè™•ç†æ ¸å¿ƒ"]
        end

        subgraph LOGS["æ—¥èªŒæ•¸æ“šæµ"]
            F_T -.->|"TraceId & SpanId æ³¨å…¥ MDC"| H_L["æ—¥èªŒæ¡†æ¶<br/>SLF4J + Logback + MDC"]
            A -->|"log.info å¯«å…¥æ—¥èªŒ"| H_L
            H_L -->|"Logback Appender æ””æˆª"| I_L["opentelemetry-spring-boot-starter<br/>å« Logback æ•´åˆ"]
            I_L -->|"è½‰æ›ç‚º OTLP LogRecord"| F_T
        end

        subgraph METRICS["æŒ‡æ¨™æ•¸æ“šæµ"]
            B -.->|"è‡ªå‹•ç”Ÿæˆè¨ˆæ™‚å™¨èˆ‡è¨ˆæ•¸å™¨"| C_M["micrometer-core<br/>æŒ‡æ¨™æ”¶é›†æ ¸å¿ƒ"]
            C_M --> D_M1["micrometer-registry-otlp<br/>æŒ‡æ¨™ OTLP åŒ¯å‡ºå™¨"]
            C_M --> D_M2["micrometer-registry-prometheus<br/>Prometheus ç«¯é»åŒ¯å‡º"]
        end

        subgraph EXPORT["æ•¸æ“šåŒ¯å‡ºå±¤"]
            F_T --> G_T["opentelemetry-exporter-otlp<br/>çµ±ä¸€ OTLP åŒ¯å‡ºå™¨"]
        end
    end

    subgraph BACKEND["å¤–éƒ¨ç›£æ§å¾Œç«¯"]
        L["Grafana LGTM Stack<br/>Loki + Grafana + Tempo + Mimir"]
        P["Prometheus<br/>å¯é¸æ‹‰å–æ¨¡å¼"]
    end
    
    G_T -->|"Traces & Logs via OTLP"| L
    D_M1 -->|"Metrics via OTLP"| L
    D_M2 -.->|"Prometheus Pull"| P
    P -.->|"è¯é‚¦æˆ–é ç«¯è®€å–"| L
```

| å¥—ä»¶ (Dependency)                                                        | å®šä½               | åŠŸèƒ½èªªæ˜                                                                                                                                                            |
| ------------------------------------------------------------------------ | ------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **`spring-boot-starter-actuator`**                                       | æ¡†æ¶åŸºç¤           | å¯è§€æ¸¬åŠŸèƒ½çš„åŸºçŸ³ã€‚å¼•å…¥ Micrometer æ ¸å¿ƒï¼Œä¸¦æä¾› `/actuator` ç³»åˆ—ç«¯é»ï¼Œæ˜¯æ•´å€‹é«”ç³»çš„å…¥å£ã€‚ Â³âµ                                                                          |
| **`spring-boot-starter-aop`**                                            | `@Observed` çš„å‹•åŠ› | æä¾› AOP èƒ½åŠ›ï¼Œè®“ `ObservedAspect` å¯ä»¥æ””æˆªè¢« `@Observed` æ¨™è¨˜çš„æ–¹æ³•ï¼Œä¸¦åœ¨å…¶å‰å¾Œè‡ªå‹•åŠ å…¥ç”¢ç”ŸæŒ‡æ¨™å’Œè¿½è¹¤çš„é‚è¼¯ã€‚                                                      |
| **`io.micrometer:micrometer-tracing-bridge-otel`**                       | API æ©‹æ¥å™¨         | ä½œç‚º Micrometer API å’Œ OpenTelemetry SDK ä¹‹é–“çš„ç¿»è­¯å®˜ã€‚å®ƒå°‡ Micrometer Tracing çš„æ¨™æº–å‘¼å«è½‰è­¯ç‚º OTel å¼•æ“èƒ½ç†è§£çš„å…·é«”æŒ‡ä»¤ã€‚ Â³âµ                                      |
| **`io.opentelemetry.instrumentation:opentelemetry-spring-boot-starter`** | è‡ªå‹•è¨­å®šå¥—ä»¶       | ç°¡åŒ–äº†æ•´åˆã€‚å®ƒåœ¨å¹•å¾Œè‡ªå‹•å®Œæˆ OpenTelemetry SDK çš„åˆå§‹åŒ–ã€é…ç½®å’Œç”Ÿå‘½é€±æœŸç®¡ç†ï¼Œè®“æˆ‘å€‘èƒ½é€é Spring çš„æ–¹å¼ (`application.yml`) ä¾†ç®¡ç† OTelã€‚ Â³â´                        |
| **`io.opentelemetry:opentelemetry-exporter-otlp`**                       | è¿½è¹¤ & æ—¥èªŒåŒ¯å‡ºå™¨  | OpenTelemetry SDK çš„å®˜æ–¹åŒ¯å‡ºå™¨ã€‚è² è²¬å°‡å·²ç”¢ç”Ÿçš„è¿½è¹¤å’Œæ—¥èªŒæ•¸æ“šæ‰“åŒ…æˆ OTLP æ ¼å¼ä¸¦é€éç¶²è·¯ç™¼é€åˆ°ç›£æ§å¾Œç«¯ã€‚ Â³âµ                                                           |
| **`micrometer-registry-otlp`**                                           | æŒ‡æ¨™åŒ¯å‡ºå™¨         | Micrometer çš„ä¸€å€‹è¨»å†Šè¡¨å¯¦ç¾ã€‚å®ƒçš„è·è²¬å¾ˆæ˜ç¢ºï¼šå°‡ Micrometer æ”¶é›†åˆ°çš„æŒ‡æ¨™æ•¸æ“šè½‰æ›ç‚º OTLP æ ¼å¼ä¸¦æ¨é€åˆ°å¾Œç«¯ã€‚                                                           |
| **`micrometer-registry-prometheus`**                                     | æŒ‡æ¨™æœ¬åœ°ç«¯é»       | æä¾›å¦ä¸€ç¨®æŒ‡æ¨™æš´éœ²æ–¹å¼ã€‚å®ƒæœƒåœ¨æ‡‰ç”¨ç¨‹å¼ä¸Šé–‹å•Ÿä¸€å€‹ `/actuator/prometheus` HTTP ç«¯é»ï¼Œè®“ Prometheus æˆ–é–‹ç™¼è€…å¯ä»¥å¾æ­¤ç«¯é»æ‹‰å– (pull) æŒ‡æ¨™æ•¸æ“šï¼Œéå¸¸é©åˆæœ¬åœ°é–‹ç™¼å’Œé™¤éŒ¯ã€‚ |

æˆ‘å€‘çš„æ‡‰ç”¨ç¨‹å¼é€éçµ±ä¸€çš„ Micrometer API (`@Observed`) é€²è¡Œæª¢æ¸¬ï¼Œç”± OpenTelemetry åœ¨å¹•å¾Œå¯¦ç¾è¿½è¹¤é‚è¼¯ï¼Œå†ç”±å„å¸å…¶è·çš„ Exporter å°‡é™æ¸¬æ•¸æ“šä»¥ OTLP æ ¼å¼ç™¼é€åˆ°ç›£æ§å¾Œç«¯ã€‚è€Œé€™ä¸€åˆ‡è¤‡é›œçš„çµ„è£å·¥ä½œï¼Œéƒ½ç”± Spring Boot Starter è‡ªå‹•åŒ–å®Œæˆï¼Œæœ€çµ‚æ§‹æˆäº†ä¸€å€‹è§£è€¦ã€æ˜“æ–¼ç¶­è­·çš„å¯è§€æ¸¬æ€§é«”ç³»ã€‚

### é‹è¡Œæ™‚è¦–åœ– (Runtime View)

#### ä¸€æ¬¡ API è«‹æ±‚çš„æ—…ç¨‹

è®“æˆ‘å€‘çœ‹çœ‹ç•¶ä¸€å€‹ã€Œæ–°å¢æ›¸æœ¬ã€çš„è«‹æ±‚ (`POST /books`) é€²ä¾†æ™‚ï¼Œç³»çµ±å…§éƒ¨ç™¼ç”Ÿäº†ä»€éº¼äº‹ã€‚

```mermaid
sequenceDiagram
    participant Client as ğŸ‘¨â€ğŸ’» API å®¢æˆ¶ç«¯
    participant App as ğŸš€ Demo æ‡‰ç”¨ç¨‹å¼
    participant SVC as ğŸ“– BookService
    participant DB as ğŸ˜ PostgreSQL
    participant Cache as âš¡ Redis
    participant LGTM as ğŸ“ˆ otel-lgtm

    Client ->> App: POST /books (Request)
    Note over App: Spring MVC æ¥æ”¶è«‹æ±‚ï¼Œè‡ªå‹•ç”¢ç”Ÿ Trace

    App ->> SVC: createBook(book)
    Note over SVC: @Observed è¨»è§£ç”Ÿæ•ˆï¼Œå»ºç«‹ä¸€å€‹æ–°çš„ Span

    SVC ->> DB: æª¢æŸ¥ ISBN æ˜¯å¦å­˜åœ¨
    SVC ->> DB: å„²å­˜æ–°æ›¸æœ¬
    Note over SVC,DB: JPA è‡ªå‹•ç”¢ç”Ÿè³‡æ–™åº«æ“ä½œçš„ Span

    SVC ->> Cache: @CacheEvict æ¸…é™¤å¿«å–
    Note over Cache: Redis æ“ä½œä¹Ÿæœƒè¢«è‡ªå‹•è§€æ¸¬

    SVC -->> App: å›å‚³æ–°å¢çš„æ›¸æœ¬
    App -->> Client: 201 Created (Response)

    Note over App,LGTM: åœ¨æ•´å€‹éç¨‹ä¸­ï¼Œ<br/>æ‡‰ç”¨ç¨‹å¼æŒçºŒå°‡ Logs, Traces, Metrics<br/>é€é OTLP å‚³é€åˆ° otel-lgtm
```

---

## ç’°å¢ƒèˆ‡çµ„æ…‹è¨­å®š

### å®¹å™¨åŒ–ç’°å¢ƒ (`compose.yaml`)

æˆ‘å€‘ä½¿ç”¨ Docker Compose ä¾†ä¸€éµå•Ÿå‹•æ‰€æœ‰å¤–éƒ¨ä¾è³´æœå‹™ï¼ŒåŒ…å« `postgres`, `redis` å’Œ `otel-lgtm`ã€‚é€™ä½¿å¾—ä»»ä½•é–‹ç™¼è€…éƒ½èƒ½å¿«é€Ÿåœ°åœ¨æœ¬åœ°å»ºç«‹èµ·ä¸€å€‹å®Œæ•´çš„é–‹ç™¼èˆ‡æ¸¬è©¦ç’°å¢ƒã€‚

### æ‡‰ç”¨ç¨‹å¼çµ„æ…‹ (`application.yml`)

é€™æ˜¯å°ˆæ¡ˆçš„æ§åˆ¶ä¸­å¿ƒï¼Œå®šç¾©äº†æ‡‰ç”¨ç¨‹å¼çš„è¡Œç‚ºã€‚è®€åˆ°é€™è£¡ï¼Œæ‚¨æ‡‰è©²æ›´èƒ½ç†è§£æ¯ä¸€é …è¨­å®šå¦‚ä½•å°æ‡‰åˆ°å‰é¢ç« ç¯€è¨è«–åˆ°çš„æŠ€è¡“ï¼š

- **`spring.application.name: demo`**: å¾ˆé‡è¦ã€‚é€™å€‹åç¨±æœƒæˆç‚º OpenTelemetry ä¸­çš„ `service.name`ï¼Œæ˜¯ä½ åœ¨ Grafana ä¸­ç¯©é¸æœå‹™çš„ä¾æ“šã€‚
- **`spring.threads.virtual.enabled: true`**: å•Ÿç”¨ Java 21 çš„è™›æ“¬åŸ·è¡Œç·’ï¼Œæå‡ I/O å¯†é›†å‹æ‡‰ç”¨çš„ååé‡ã€‚è©³è¦‹ä¸Šæ–¹ ğŸš€ æ•ˆèƒ½æå‡ ç« ç¯€ã€‚
- **`management.observations.annotations.enabled: true`**: å•Ÿç”¨ `@Observed` è¨»è§£çš„ç¸½é–‹é—œã€‚è©³è¦‹ä¸Šæ–¹ ğŸ“œ å¯è§€æ¸¬æ€§ ç« ç¯€ã€‚
- **`management.opentelemetry.resource-attributes`**: ç‚ºæ‰€æœ‰é™æ¸¬æ•¸æ“šé™„åŠ çš„é¡å¤–æ¨™ç±¤ï¼Œä¾‹å¦‚æœå‹™ç‰ˆæœ¬å’Œéƒ¨ç½²ç’°å¢ƒï¼Œä¾¿æ–¼åœ¨å¾Œç«¯é€²è¡Œåˆ†é¡å’Œç¯©é¸ã€‚
- **`management.tracing.sampling.probability: 1.0`**: æ¡æ¨£ç‡è¨­ç‚º 1.0 (å³ 100%)ã€‚é€™åœ¨é–‹ç™¼å’Œæ¸¬è©¦æ™‚å¾ˆå¯¦ç”¨ï¼Œå¯ä»¥ç¢ºä¿ä¸æœƒéºæ¼ä»»ä½•è«‹æ±‚çš„è¿½è¹¤ã€‚åœ¨ç”Ÿç”¢ç’°å¢ƒä¸­ï¼Œç‚ºäº†æ•ˆèƒ½å’Œæˆæœ¬è€ƒé‡ï¼Œé€šå¸¸æœƒè¨­å®šä¸€å€‹è¼ƒä½çš„å€¼ï¼ˆä¾‹å¦‚ 0.1ï¼‰ã€‚
- **`management.otlp.*.endpoint`**: æ˜ç¢ºæŒ‡å®šå°‡ Metrics, Traces, Logs ç™¼é€åˆ°å“ªè£¡ã€‚é€™è£¡æˆ‘å€‘éƒ½æŒ‡å‘ `otel-lgtm` å®¹å™¨æš´éœ²çš„ 4318 HTTP åŸ ã€‚
- **`spring.jpa.hibernate.ddl-auto`** (æœªè¨­å®šç‚º `update` æˆ– `create`): æˆ‘å€‘å°‡å…¶äº¤çµ¦ Liquibase ç®¡ç†ï¼Œä»¥ç¢ºä¿è³‡æ–™åº«ç‰ˆæœ¬æ§åˆ¶çš„åš´è¬¹æ€§ã€‚

---

æœ¬æ‰‹å†Šå±•ç¤ºäº†å¦‚ä½•æ•´åˆä¸€ç³»åˆ—ç¾ä»£åŒ–çš„å·¥å…·èˆ‡å¯¦è¸ï¼Œä¾†å»ºæ§‹ä¸€å€‹ä¸åƒ…å®ŒæˆåŠŸèƒ½ï¼ŒåŒæ™‚ä¹Ÿå…¼é¡§æ•ˆèƒ½ã€å¯ç¶­è­·æ€§å’Œå¯è§€æ¸¬æ€§çš„ Spring Boot å°ˆæ¡ˆã€‚
å°æ–¼é–‹ç™¼è€…è€Œè¨€ï¼Œå¾ã€Œå®ŒæˆåŠŸèƒ½ã€åˆ°ã€Œæå‡å“è³ªã€çš„é—œéµï¼Œåœ¨æ–¼æœ‰æ„è­˜åœ°æ¡ç”¨é€™äº›ç¾ä»£åŒ–å¯¦è¸ï¼š

- æ“æŠ± Java 21 è™›æ“¬åŸ·è¡Œç·’ï¼Œä»¥æ›´ç°¡å–®çš„ç¨‹å¼ç¢¼å¯¦ç¾æ›´é«˜çš„ I/O ååé‡ã€‚
- é€é Liquibase é€²è¡Œè³‡æ–™åº«ç‰ˆæœ¬æ§åˆ¶ï¼Œç¢ºä¿åœ˜éšŠå”ä½œå’Œå¤šç’°å¢ƒéƒ¨ç½²çš„ä¸€è‡´æ€§èˆ‡å¯é æ€§ã€‚
- å¯¦è¸ API-First é–‹ç™¼æµç¨‹ï¼Œå»ºç«‹æ¸…æ™°çš„æœå‹™å¥‘ç´„ï¼ŒåŠ é€Ÿå¹³è¡Œé–‹ç™¼ã€‚
- åˆ©ç”¨ MapStruct å’Œ Spring Cache ç­‰å·¥å…·ï¼Œæ¶ˆé™¤æ¨£æ¿ç¨‹å¼ç¢¼ï¼Œä¸¦ä»¥åˆç†çš„æˆæœ¬æå‡æ‡‰ç”¨æ•ˆèƒ½ã€‚
- å»ºç«‹å…¨é¢çš„å¯è§€æ¸¬æ€§é«”ç³»ï¼Œé€é Micrometer å’Œ OpenTelemetry æ·±å…¥æ´å¯Ÿç³»çµ±å…§éƒ¨è¡Œç‚ºï¼Œå°‡è¢«å‹•çš„ã€Œå•é¡Œæ’æŸ¥ã€è½‰è®Šç‚ºä¸»å‹•çš„æ•ˆèƒ½å„ªåŒ–èˆ‡å•é¡Œé é˜²ã€‚

å°‡é€™äº›å¯¦è¸èå…¥æ—¥å¸¸é–‹ç™¼æµç¨‹ï¼Œæœ‰åŠ©æ–¼æå‡æœ€çµ‚ç”¢å“çš„å“è³ªèˆ‡é–‹ç™¼åœ˜éšŠçš„ç”Ÿç”¢åŠ›ã€‚å¸Œæœ›é€™ä»½æ‰‹å†Šèƒ½ç‚ºæ‚¨åœ¨å»ºæ§‹ä¸‹ä¸€å€‹å°ˆæ¡ˆæ™‚æä¾›åƒè€ƒã€‚
