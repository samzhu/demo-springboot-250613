<a href="https://studio.firebase.google.com/import?url=https%3A%2F%2Fgithub.com%2Fsamzhu%2Fdemo-springboot-250613">
  <img
    height="32"
    alt="Try in Firebase Studio"
    src="https://cdn.firebasestudio.dev/btn/try_bright_32.svg">
</a>

# Spring Boot 3 ç¾ä»£åŒ–å°ˆæ¡ˆå¯¦æˆ°æ‰‹å†Š

## å°ˆæ¡ˆç°¡ä»‹

é€™ä»½æ‰‹å†Šå°‡å¸¶ä½ äº†è§£ä¸€å€‹ä½¿ç”¨ Java 21ã€Spring Boot 3 å’Œ Gradle å»ºæ§‹çš„å°ˆæ¡ˆã€‚æˆ‘å€‘çš„ç›®æ¨™ä¸åªæ˜¯å¯«å‡ºèƒ½å‹•çš„ç¨‹å¼ï¼Œæ›´è¦ç¢ºä¿å°ˆæ¡ˆå¤ å¼·å£¯ã€è·‘å¾—å¿«ï¼Œè€Œä¸”æœªä¾†å®¹æ˜“ç¶­è­·ã€‚  

æˆ‘å€‘æœƒå¾å°ˆæ¡ˆçš„åŸºç¤è¨­å®šé–‹å§‹ï¼Œä¸€æ­¥æ­¥ä»‹ç´¹è³‡æ–™åº« JPAã€ç‰ˆæœ¬æ§åˆ¶ Liquibaseã€å¿«å– Redis çš„ç”¨æ³•ã€‚æ¥è‘—ï¼Œæˆ‘å€‘æœƒæŠŠé‡é»æ”¾åœ¨ã€Œå¯è§€æ¸¬æ€§ã€ï¼Œå­¸ç¿’å¦‚ä½•ç”¨ Micrometer å’Œ OpenTelemetry (OTLP) ç›£æ§æ‡‰ç”¨ç¨‹å¼çš„å¥åº·ç‹€æ³ï¼Œä¸¦å°‡æ‰€æœ‰ç›£æ§æ•¸æ“šé€åˆ° Grafana å¹³å°é€²è¡Œåˆ†æã€‚  

é€™ä»½æ‰‹å†Šé©åˆè¦å­¸ç¿’ Spring Boot 3 ç¾ä»£åŒ–ä½œæ³•çš„é–‹ç™¼äººå“¡ã€‚  

---

## è»Ÿé«”åˆ†å±¤æ¶æ§‹

å°ˆæ¡ˆçš„é‹ä½œæ–¹å¼ï¼Œå¯ä»¥ç”¨ä¸‹é¢é€™å¼µåœ–ä¾†ç†è§£ï¼š

```mermaid
graph TB
    subgraph "æ›¸æœ¬ç®¡ç†ç³»çµ±"
        WebController
        AppService
        DomainModel
        Repository
        Cache
    end

    User["ç”¨æˆ¶"] --> WebController
    WebController --> AppService
    AppService --> DomainModel
    AppService --> Repository
    AppService --> Cache
    Repository --> PostgreSQL
    Cache --> Redis

    classDef container fill:#1168bd,stroke:#0b4884,color:#ffffff
    classDef external fill:#999999,stroke:#6b6b6b,color:#ffffff

    class WebController,AppService,DomainModel,Repository,Cache container
    class User,PostgreSQL,Redis external
```

- **WebController**: æ¥æ”¶ä½¿ç”¨è€…æ“ä½œï¼Œä¾‹å¦‚é»æ“Šç¶²é æŒ‰éˆ•ã€‚
- **AppService**: è™•ç†ä¸»è¦çš„æ¥­å‹™é‚è¼¯ï¼Œæ˜¯æ•´å€‹ç³»çµ±çš„æ ¸å¿ƒã€‚
- **Repository / CacheService**: è² è²¬è·Ÿè³‡æ–™åº« (PostgreSQL) å’Œå¿«å– (Redis) æ‰“äº¤é“ï¼Œå­˜å–è³‡æ–™ã€‚
- **DomainModel**: å®šç¾©äº†ç³»çµ±ä¸­çš„ç‰©ä»¶ï¼Œä¾‹å¦‚ä¸€æœ¬æ›¸è©²æœ‰å“ªäº›å±¬æ€§ã€‚

---

## ğŸ“ å°ˆæ¡ˆçµæ§‹æ¦‚è¦½

é€™å€‹å°ˆæ¡ˆæ¡ç”¨äº†å¸¸è¦‹çš„åˆ†å±¤æ¶æ§‹ã€‚æŠŠä¸åŒåŠŸèƒ½çš„ç¨‹å¼ç¢¼æ”¾åœ¨ä¸åŒçš„è³‡æ–™å¤¾ï¼Œå°±åƒæŠŠè¡£æœã€è¤²å­ã€è¥ªå­åˆ†é¡æ”¾å¥½ä¸€æ¨£ï¼Œæœªä¾†è¦æ‰¾æ±è¥¿æˆ–ä¿®æ”¹æœƒæ–¹ä¾¿å¾ˆå¤šã€‚

```text
.
â”œâ”€â”€ build.gradle                # Gradle å»ºç½®è…³æœ¬ï¼Œå®šç¾©å°ˆæ¡ˆéœ€è¦å“ªäº›å·¥å…·å’Œå¥—ä»¶
â”œâ”€â”€ config/                     # å­˜æ”¾ä¸åŒç’°å¢ƒçš„è¨­å®šæª”ï¼Œé€™äº›æª”æ¡ˆä¸æœƒè¢«æ‰“åŒ…åˆ°æœ€çµ‚çš„ç¨‹å¼è£¡
â”‚   â”œâ”€â”€ application-local.yml   # "local" ç’°å¢ƒ (è‡ªå·±é›»è…¦) å°ˆç”¨çš„è¨­å®šæª”
â”‚   â”œâ”€â”€ application-ut.yml      # "ut" ç’°å¢ƒ (å–®å…ƒæ¸¬è©¦) å°ˆç”¨çš„è¨­å®šæª”
â”‚   â”œâ”€â”€ application-sit.yml     # "sit" ç’°å¢ƒ (æ•´åˆæ¸¬è©¦) å°ˆç”¨çš„è¨­å®šæª”
â”‚   â””â”€â”€ application-prod-example.yml # "prod" ç’°å¢ƒ (æ­£å¼ä¸Šç·š) çš„è¨­å®šæª”ç¯„æœ¬ (é‡è¦å¯†ç¢¼æœƒå­˜åœ¨åˆ¥çš„åœ°æ–¹)
â”œâ”€â”€ compose.yaml                # Docker è¨­å®šæª”ï¼ŒæŒ‰ä¸€å€‹éµå°±èƒ½åœ¨æœ¬æ©Ÿæ¶èµ·æ‰€æœ‰éœ€è¦çš„æœå‹™ (è³‡æ–™åº«ã€Redisç­‰)
â”œâ”€â”€ dev-resources/
â”‚   â””â”€â”€ openapi.yaml            # API è¦æ ¼æª”æ¡ˆ (æ‰€æœ‰ API è¨­è¨ˆçš„å”¯ä¸€æ¨™æº–)
â””â”€â”€ src/
    â”œâ”€â”€ main/
    â”‚   â”œâ”€â”€ java/com/example/demo/
    â”‚   â”‚   â”œâ”€â”€ applications/        # æ‡‰ç”¨å±¤ (Service): å­˜æ”¾æ ¸å¿ƒå•†æ¥­é‚è¼¯çš„åœ°æ–¹
    â”‚   â”‚   â”œâ”€â”€ config/              # è¨­å®šå±¤: å­˜æ”¾ Spring éœ€è¦çš„å„ç¨®è¨­å®š
    â”‚   â”‚   â”œâ”€â”€ infrastructure/      # åŸºç¤è¨­æ–½å±¤: å®šç¾©å¦‚ä½•è·Ÿè³‡æ–™åº«æºé€šçš„ä»‹é¢
    â”‚   â”‚   â”œâ”€â”€ interfaces/          # ä»‹é¢å±¤: æ‰€æœ‰è·Ÿå¤–éƒ¨ç³»çµ±äº’å‹•çš„ç¨‹å¼ç¢¼éƒ½æ”¾é€™è£¡
    â”‚   â”‚   â”‚   â”œâ”€â”€ api/             # - (è‡ªå‹•ç”¢ç”Ÿ) æ ¹æ“š openapi.yaml ç”¢ç”Ÿçš„ API ä»‹é¢
    â”‚   â”‚   â”‚   â”œâ”€â”€ dto/             # - (è‡ªå‹•ç”¢ç”Ÿ) æ ¹æ“š openapi.yaml ç”¢ç”Ÿçš„è³‡æ–™å‚³è¼¸ç‰©ä»¶
    â”‚   â”‚   â”‚   â”œâ”€â”€ mapper/          # - DTO å’Œè³‡æ–™åº« Entity ä¹‹é–“çš„è½‰æ›å·¥å…·
    â”‚   â”‚   â”‚   â””â”€â”€ rest/            # - API çš„å…·é«”å¯¦ä½œç¨‹å¼ç¢¼ (Controller)
    â”‚   â”‚   â”œâ”€â”€ models/              # æ¨¡å‹å±¤: å®šç¾©è³‡æ–™åº«è¡¨æ ¼é•·ç›¸çš„ç¨‹å¼ç¢¼ (JPA Entity)
    â”‚   â”‚   â””â”€â”€ DemoApplication.java # Spring Boot å°ˆæ¡ˆçš„å•Ÿå‹•å…¥å£
    â”‚   â””â”€â”€ resources/
    â”‚       â”œâ”€â”€ application.yml      # æœ€åŸºç¤ã€é€šç”¨çš„ Spring Boot è¨­å®šæª”
    â”‚       â”œâ”€â”€ application-gcp.yml  # çµ¦ Google Cloud Platform (GCP) ç’°å¢ƒç”¨çš„è¨­å®šæª”
    â”‚       â”œâ”€â”€ application-aws.yml  # çµ¦ Amazon Web Services (AWS) ç’°å¢ƒç”¨çš„è¨­å®šæª”
    â”‚       â””â”€â”€ db/changelog/        # Liquibase è³‡æ–™åº«è®Šæ›´è…³æœ¬
    â”‚           â”œâ”€â”€ db.changelog-master.yaml # ä¸»è¦çš„è®Šæ›´ç´€éŒ„æª”
    â”‚           â””â”€â”€ history/         # å­˜æ”¾æ‰€æœ‰æ­·å²è®Šæ›´ç´€éŒ„
    â””â”€â”€ test/                        # æ¸¬è©¦ç¨‹å¼ç¢¼
        â””â”€â”€ java/com/example/demo/
            â”œâ”€â”€ TestDemoApplication.java
            â”œâ”€â”€ TestcontainersConfiguration.java # Testcontainers (ä¸€ç¨®æ¸¬è©¦å·¥å…·) çš„è¨­å®š
            â””â”€â”€ DemoApplicationTests.java        # æ•´åˆæ¸¬è©¦
```

---

## ğŸ§© æ ¸å¿ƒæŠ€è¡“èˆ‡é—œéµå¥—ä»¶ä¸€è¦½

é€™å€‹å°ˆæ¡ˆä½¿ç”¨äº†ä¸€ç³»åˆ—åœ¨æ¥­ç•Œå»£æ³›æ‡‰ç”¨çš„æŠ€è¡“ä¾†æ‰“é€ ã€‚

### èªè¨€/æ¡†æ¶

- Java 21, Spring Boot 3.5.0

### å»ºç½®èˆ‡å·¥å…·å¤–æ› (Plugins)

é€™äº›æ˜¯å¹«åŠ©æˆ‘å€‘å»ºç½®å’Œç®¡ç†å°ˆæ¡ˆçš„å·¥å…·ã€‚

- **`org.springframework.boot`** Spring Boot çš„æ ¸å¿ƒå·¥å…·ã€‚å®ƒè®“æˆ‘å€‘èƒ½è¼•é¬†å•Ÿå‹•å°ˆæ¡ˆï¼Œä¸¦å°‡æ•´å€‹å°ˆæ¡ˆæ‰“åŒ…æˆä¸€å€‹å¯ä»¥ç¨ç«‹é‹è¡Œçš„æª”æ¡ˆã€‚
- **`io.spring.dependency-management`** Spring çš„ä¾è³´ç®¡ç†å·¥å…·ã€‚å®ƒå¹«æˆ‘å€‘çµ±ä¸€ç®¡ç†å°ˆæ¡ˆä¸­ç”¨åˆ°çš„å„ç¨®å¥—ä»¶ç‰ˆæœ¬ï¼Œæˆ‘å€‘å°±ä¸éœ€è¦æ‰‹å‹•æŒ‡å®šæ¯å€‹å¥—ä»¶çš„ç‰ˆæœ¬è™Ÿäº†ã€‚
- **`org.openapi.generator`** å¯¦è¸ã€ŒAPI Firstã€çš„æ ¸å¿ƒå·¥å…·ã€‚å®ƒæœƒè®€å– `openapi.yaml` é€™å€‹è¦æ ¼æª”ï¼Œè‡ªå‹•å¹«æˆ‘å€‘ç”¢ç”Ÿ API çš„ Java ä»‹é¢å’Œè³‡æ–™æ¨¡å‹(DTO)ï¼Œç¢ºä¿ç¨‹å¼ç¢¼å’Œ API æ–‡ä»¶æ°¸é åŒæ­¥ã€‚
- **`com.gorylenko.gradle-git-properties`** é€™å€‹å·¥å…·æœƒç”¢ç”Ÿä¸€å€‹ `git.properties` æª”æ¡ˆï¼Œè£¡é¢è¨˜éŒ„äº†ç•¶å‰ç¨‹å¼ç¢¼çš„ Git ç‰ˆæœ¬è³‡è¨Š (ä¾‹å¦‚æ˜¯å“ªå€‹åˆ†æ”¯ã€å“ªæ¬¡ commit)ã€‚é€™æ¨£æˆ‘å€‘å°±èƒ½æ¸…æ¥šçŸ¥é“ç·šä¸Šé‹è¡Œçš„ç¨‹å¼ï¼Œåˆ°åº•æ˜¯å“ªä¸€å€‹ç‰ˆæœ¬ã€‚
- **`org.cyclonedx.bom`** è»Ÿé«”ç‰©æ–™æ¸…å–® (SBOM) ç”¢ç”Ÿå™¨ã€‚å®ƒæœƒæƒæå°ˆæ¡ˆï¼Œåˆ—å‡ºä¸€å¼µè©³ç´°æ¸…å–®ï¼Œèªªæ˜å°ˆæ¡ˆç”¨åˆ°äº†å“ªäº›ç¬¬ä¸‰æ–¹å¥—ä»¶ã€‚é€™å°æ–¼æª¢æŸ¥å·²çŸ¥çš„å®‰å…¨æ¼æ´å’Œè»Ÿé«”æˆæ¬Šåˆè¦æ€§éå¸¸é‡è¦ã€‚
- **`jacoco`** è¨ˆç®—ç¨‹å¼ç¢¼æ¸¬è©¦è¦†è“‹ç‡çš„å·¥å…·ã€‚å®ƒèƒ½ç”¢ç”Ÿå ±å‘Šï¼Œè®“æˆ‘å€‘çŸ¥é“æ¸¬è©¦å¯«å¾—å¤ ä¸å¤ å®Œæ•´ã€‚

### é—œéµä¾è³´ (Dependencies)

é€™äº›æ˜¯å°ˆæ¡ˆåŸ·è¡Œæ™‚éœ€è¦çš„æ ¸å¿ƒå¥—ä»¶ã€‚

#### API èˆ‡ Web å±¤

- **`spring-boot-starter-web`** é–‹ç™¼ RESTful API çš„å¿…å‚™å¥—ä»¶ã€‚å®ƒåŒ…å«äº†å…§åµŒçš„ä¼ºæœå™¨ (Tomcat) å’Œ Spring MVC æ¡†æ¶ã€‚
- **`spring-boot-starter-validation`** è³‡æ–™é©—è­‰å·¥å…·ã€‚å®ƒè®“æˆ‘å€‘å¯ä»¥åœ¨ DTO ä¸Šç”¨ `@NotNull`, `@Size` é€™æ¨£çš„æ¨™ç±¤ï¼Œä¾†è¨­å®šè³‡æ–™è¦å‰‡ã€‚ç•¶ API æ”¶åˆ°è«‹æ±‚æ™‚ï¼ŒSpring æœƒè‡ªå‹•æª¢æŸ¥å‚³å…¥çš„è³‡æ–™æ˜¯å¦åˆæ³•ã€‚
- **`springdoc-openapi-starter-webmvc-ui`** è‡ªå‹•ç”¢ç”Ÿä¸€å€‹äº’å‹•å¼çš„ API æ–‡ä»¶ç¶²é  (Swagger UI)ã€‚é€™å€‹ç¶²é æœƒæ ¹æ“šæˆ‘å€‘çš„ç¨‹å¼ç¢¼å’Œ API è¦æ ¼ï¼Œè®“æˆ‘å€‘èƒ½ç›´æ¥åœ¨ç€è¦½å™¨ä¸Šæ¸¬è©¦ APIã€‚
- **`mapstruct`** å’Œ **`mapstruct-processor`** ä¸€å€‹ç‰©ä»¶è½‰æ›å·¥å…·ã€‚å®ƒèƒ½è‡ªå‹•ç”¢ç”Ÿ DTO å’Œè³‡æ–™åº« Entity äº’è½‰çš„ç¨‹å¼ç¢¼ï¼Œé¿å…æˆ‘å€‘æ‰‹å¯«å¤§é‡é‡è¤‡çš„ get/set ç¨‹å¼ã€‚
- **`jackson-databind-nullable`** ä¸€å€‹è¼”åŠ©å¥—ä»¶ï¼Œç”¨ä¾†è§£æ±º JSON è³‡æ–™ä¸­ `null` å’Œã€Œæœªæä¾› (undefined)ã€çš„å€åˆ¥ã€‚é€™åœ¨è™•ç†éƒ¨åˆ†æ›´æ–° (PATCH) çš„æƒ…å¢ƒä¸‹ç‰¹åˆ¥æœ‰ç”¨ï¼Œå¯ä»¥è®“æˆ‘å€‘ç²¾ç¢ºåˆ¤æ–·ï¼šä½¿ç”¨è€…æ˜¯æ•…æ„è¦æŠŠæŸå€‹æ¬„ä½è¨­æˆ `null`ï¼Œé‚„æ˜¯ä»–æ ¹æœ¬æ²’æ‰“ç®—å‹•é‚£å€‹æ¬„ä½ã€‚

#### è³‡æ–™å­˜å–èˆ‡å¿«å–å±¤

- **`spring-boot-starter-data-jpa`** ç°¡åŒ–è³‡æ–™åº«æ“ä½œçš„å·¥å…·ã€‚å®ƒè®“æˆ‘å€‘ç”¨ç°¡å–®çš„æ–¹å¼å°±èƒ½å®Œæˆå°è³‡æ–™åº«çš„æ–°å¢ã€è®€å–ã€æ›´æ–°å’Œåˆªé™¤ (CRUD)ã€‚
- **`liquibase-core`** è³‡æ–™åº«ç‰ˆæœ¬æ§åˆ¶å·¥å…·ã€‚å®ƒè®“æˆ‘å€‘èƒ½ç”¨æª”æ¡ˆä¾†ç®¡ç†è³‡æ–™åº«çµæ§‹çš„è®ŠåŒ–ï¼Œå°±åƒç”¨ Git ç®¡ç†ç¨‹å¼ç¢¼ä¸€æ¨£ï¼Œç¢ºä¿æ¯å€‹é–‹ç™¼ç’°å¢ƒçš„è³‡æ–™åº«çµæ§‹éƒ½ä¸€è‡´ã€‚
- **`spring-boot-starter-cache`** æä¾›äº†ä¸€å¥—æ¨™æº–çš„å¿«å– APIã€‚æˆ‘å€‘å¯ä»¥ç”¨ `@Cacheable` é€™æ¨£çš„æ¨™ç±¤è¼•é¬†åœ°ç‚ºç¨‹å¼åŠ ä¸Šå¿«å–åŠŸèƒ½ï¼Œè€Œä¸ç”¨å»ç®¡åº•å±¤æ˜¯ç”¨å“ªç¨®å¿«å–æŠ€è¡“ã€‚
- **`spring-boot-starter-data-redis`** æ•´åˆ Redis çš„å¥—ä»¶ã€‚ç•¶å®ƒå’Œ `spring-boot-starter-cache` ä¸€èµ·ç”¨æ™‚ï¼ŒSpring Boot å°±æœƒè‡ªå‹•æŠŠ Redis ç•¶ä½œæˆ‘å€‘çš„å¿«å–å„²å­˜åº«ã€‚

#### å¯è§€æ¸¬æ€§ (Observability) å±¤

- **`spring-boot-starter-actuator`** å¯è§€æ¸¬æ€§çš„åŸºç¤ã€‚å®ƒæä¾›äº†ä¸€ç³»åˆ—ç”¨æ–¼ç›£æ§å’Œç®¡ç†æ‡‰ç”¨ç¨‹å¼çš„ç«¯é»ï¼Œä¾‹å¦‚æª¢æŸ¥å¥åº·ç‹€æ³çš„ `/actuator/health`ã€‚
- **`spring-boot-starter-aop`** å•Ÿç”¨ `@Observed` è¨»è§£çš„é—œéµã€‚å®ƒæä¾›äº†ä¸€ç¨®å«åšã€Œé¢å‘åˆ‡é¢ç·¨ç¨‹ (AOP)ã€çš„æŠ€è¡“ï¼Œè®“ç›£æ§å·¥å…·å¯ä»¥åœ¨æˆ‘å€‘æŒ‡å®šçš„ç¨‹å¼ç¢¼å‰å¾Œï¼Œè‡ªå‹•åŠ ä¸Šç´€éŒ„æŒ‡æ¨™å’Œè¿½è¹¤çš„é‚è¼¯ã€‚
- **`io.micrometer:micrometer-tracing-bridge-otel`** ä¸€å€‹æ©‹æ¥å™¨ã€‚å®ƒçš„ä½œç”¨æ˜¯æŠŠ Micrometer çš„è¿½è¹¤æŒ‡ä»¤ï¼Œç¿»è­¯æˆ OpenTelemetry é€™å€‹ç›£æ§æ¨™æº–èƒ½è½å¾—æ‡‚çš„æ ¼å¼ã€‚
- **`io.opentelemetry:opentelemetry-exporter-otlp`** ä¸€å€‹åŒ¯å‡ºå™¨ã€‚å®ƒè² è²¬æŠŠè¿½è¹¤ (Traces) å’Œæ—¥èªŒ (Logs) æ•¸æ“šï¼Œæ‰“åŒ…æˆ OTLP é€™ç¨®æ¨™æº–æ ¼å¼ï¼Œç„¶å¾Œå‚³é€åˆ°å¾Œç«¯çš„ç›£æ§ç³»çµ±ã€‚
- **`io.opentelemetry.instrumentation:opentelemetry-spring-boot-starter`** OpenTelemetry çš„è‡ªå‹•è¨­å®šå·¥å…·ã€‚å®ƒç°¡åŒ–äº†æ•´åˆçš„è¤‡é›œåº¦ï¼Œèƒ½è‡ªå‹•æŠŠ OTel çš„åŠŸèƒ½ï¼ˆä¾‹å¦‚å‚³é€æ—¥èªŒï¼‰æ•´åˆé€² Spring Boot å°ˆæ¡ˆä¸­ã€‚
- **`io.micrometer:micrometer-registry-otlp`** æŒ‡æ¨™åŒ¯å‡ºå™¨ã€‚å®ƒè² è²¬æŠŠ Micrometer æ”¶é›†åˆ°çš„å„ç¨®æŒ‡æ¨™ (Metrics)ï¼Œè½‰æ›æˆ OTLP æ ¼å¼ä¸¦å‚³é€å‡ºå»ã€‚
- **`io.micrometer:micrometer-registry-prometheus`** Prometheus æŒ‡æ¨™ç«¯é»ã€‚å®ƒæä¾›å¦ä¸€ç¨®æŸ¥çœ‹æŒ‡æ¨™çš„æ–¹å¼ï¼Œæœƒåœ¨ `/actuator/prometheus` é€™å€‹ç¶²å€ä¸Šï¼Œç”¢ç”Ÿä¸€å€‹çµ¦ Prometheus ç³»çµ±è®€å–çš„æŒ‡æ¨™é é¢ã€‚é€™åœ¨è‡ªå·±é›»è…¦ä¸Šé–‹ç™¼æ™‚ç‰¹åˆ¥å¥½ç”¨ã€‚

---

## âš™ï¸ ç’°å¢ƒé…ç½®èˆ‡è¨­å®šæª”ç®¡ç†

### é…ç½®æª”æ¡ˆè¼‰å…¥å„ªå…ˆç´š

Spring Boot æœƒæŒ‰ç…§ä»¥ä¸‹å„ªå…ˆç´šè¼‰å…¥é…ç½®æª”æ¡ˆï¼š

1. **`application.yml`** - åŸºç¤å…±ç”¨é…ç½®
2. **`application-{profile}.yml`** - ç’°å¢ƒç‰¹å®šé…ç½®ï¼ˆæœƒè¦†è“‹åŸºç¤é…ç½®ï¼‰

Spring åœ¨é–‹ç™¼éšæ®µä¹Ÿæœƒè®€å– `config/` è³‡æ–™å¤¾ä¸‹çš„æª”æ¡ˆï¼Œä¾‹å¦‚ `application-local.yml` å°±æ˜¯å°ˆç‚ºæœ¬åœ°é–‹ç™¼è€Œè¨­è¨ˆçš„ã€‚

### é…ç½®æª”æ¡ˆæ¶æ§‹è¨­è¨ˆ

æˆ‘å€‘çš„é…ç½®æª”æ¡ˆæ¡ç”¨åˆ†å±¤è¨­è¨ˆï¼Œç¢ºä¿ä¸åŒç’°å¢ƒå’Œéƒ¨ç½²å¹³å°çš„éœ€æ±‚éƒ½èƒ½è¢«å¦¥å–„è™•ç†ã€‚

#### åŸºç¤è¨­å®šæª” (`src/main/resources/`)

é€™äº›æª”æ¡ˆæœƒè¢«æ‰“åŒ…é€² Docker Image ä¸­ï¼Œé©ç”¨æ–¼æ‰€æœ‰ç’°å¢ƒçš„å…±ç”¨è¨­å®šï¼Œæˆ–é‡å°ç‰¹å®šé›²ç«¯å¹³å°çš„å°ˆé–€å„ªåŒ–ã€‚

| æª”æ¡ˆ | ç”¨é€” | èªªæ˜ |
|------|------|------|
| `application.yml` | åŸºç¤å…±ç”¨è¨­å®š | æ‰€æœ‰ç’°å¢ƒå…±ç”¨çš„åŸºæœ¬é…ç½® |
| `application-gcp.yml` | Google Cloud Platform | å•Ÿç”¨ GCP ç‰¹æœ‰æœå‹™æ•´åˆ |
| `application-aws.yml` | Amazon Web Services | å•Ÿç”¨ AWS ç‰¹æœ‰æœå‹™æ•´åˆ |

**GCP ç’°å¢ƒç¯„ä¾‹**ï¼š
```yaml
# application-gcp.yml
spring:
  config:
    import: sm@  # å•Ÿç”¨ Google Secret Manager
  datasource:
    password: ${sm@project_db_password}  # å¾ Secret Manager è®€å–å¯†ç¢¼

management:
  opentelemetry:
    resource-attributes:
      cloud.provider: "gcp"
  endpoint:
    health:
      group:
        gcp:
          include: "db,pubsub,gcs,spanner"  # GCP æœå‹™å¥åº·æª¢æŸ¥
```

#### ç’°å¢ƒç‰¹å®šè¨­å®šæª” (`config/`)

é€™äº›æª”æ¡ˆ**ä¸æœƒ**è¢«æ‰“åŒ…é€² Docker Imageï¼Œéœ€è¦åœ¨éƒ¨ç½²æ™‚å¾å¤–éƒ¨æ›è¼‰ã€‚é€™ç¨®è¨­è¨ˆéµå¾ªäº† [12-Factor App Codebase](https://12factor.net/) çš„åŸå‰‡ï¼Œè®“åŒä¸€ä»½ç¨‹å¼ç¢¼å¯ä»¥åœ¨ä¸åŒç’°å¢ƒä¸­é‹è¡Œã€‚

| æª”æ¡ˆ | ç’°å¢ƒ | èªªæ˜ |
|------|------|------|
| `application-local.yml` | æœ¬åœ°é–‹ç™¼ | é–‹ç™¼è€…é›»è…¦ä¸Šçš„è¨­å®š |
| `application-ut.yml` | å–®å…ƒæ¸¬è©¦ | å–®å…ƒæ¸¬è©¦ç’°å¢ƒ |
| `application-sit.yml` | ç³»çµ±æ•´åˆæ¸¬è©¦ | SIT æ¸¬è©¦ç’°å¢ƒ |
| `application-uat.yml` | ä½¿ç”¨è€…é©—æ”¶æ¸¬è©¦ | UAT æ¸¬è©¦ç’°å¢ƒ |
| `application-prod.yml` | æ­£å¼ç’°å¢ƒ | ç”Ÿç”¢ç’°å¢ƒï¼ˆé€šå¸¸ä¸æœƒç›´æ¥å­˜åœ¨ç¨‹å¼ç¢¼åº«ä¸­ï¼‰ |
| `application-prod-example.yml` | æ­£å¼ç’°å¢ƒç¯„æœ¬ | ç”Ÿç”¢ç’°å¢ƒçš„é…ç½®åƒè€ƒç¯„æœ¬ |

### å¤šç’°å¢ƒå•Ÿå‹•ç¯„ä¾‹

#### æœ¬åœ°é–‹ç™¼

```bash
# ç´”æœ¬åœ°ç’°å¢ƒ
./gradlew bootRun --args='--spring.profiles.active=local'

# æœ¬åœ°ç’°å¢ƒ + æ¨¡æ“¬ GCP æœå‹™
./gradlew bootRun --args='--spring.profiles.active=local,gcp'
```

#### æ¸¬è©¦ç’°å¢ƒ

```bash
# SIT ç’°å¢ƒåœ¨ GCP ä¸Š
./gradlew bootRun --args='--spring.profiles.active=sit,gcp'

# UAT ç’°å¢ƒåœ¨ AWS ä¸Š
./gradlew bootRun --args='--spring.profiles.active=uat,aws'
```

#### å®¹å™¨åŒ–éƒ¨ç½²

```bash
# Docker å®¹å™¨å•Ÿå‹•ï¼ˆé€éç’°å¢ƒè®Šæ•¸ï¼‰
docker run -e SPRING_PROFILES_ACTIVE=sit,gcp my-app:latest

# Kubernetes éƒ¨ç½²ï¼ˆé€é ConfigMap å’Œ Secretï¼‰
kubectl apply -f k8s-configs/
```

### é…ç½®å®‰å…¨æ€§æœ€ä½³å¯¦è¸

#### ğŸ” æ©Ÿå¯†è³‡è¨Šè™•ç†

**çµ•å°ä¸è¦** å°‡æ•æ„Ÿè³‡è¨Šï¼ˆå¯†ç¢¼ã€API Keyã€Tokenï¼‰ç›´æ¥å¯«åœ¨é…ç½®æª”æ¡ˆä¸­ã€‚å»ºè­°çš„è™•ç†æ–¹å¼ï¼š

1. **ç’°å¢ƒè®Šæ•¸**ï¼š

   ```yaml
   spring:
     datasource:
       password: ${DB_PASSWORD}
   ```

2. **é›²ç«¯ Secret Manager**ï¼š

   ```yaml
   # GCP
   spring:
     datasource:
       password: ${sm@project_db_password}
   
   # AWS
   spring:
     datasource:
       password: ${ssm@/myapp/db/password}
   ```

3. **Kubernetes Secret**ï¼š

   ```yaml
   # é€é volumeMounts æ›è¼‰
   spring:
     datasource:
       password: ${file@/etc/secrets/db-password}
   ```

#### ğŸ“Š ç’°å¢ƒç‰¹å®šèª¿å„ª

ä¸åŒç’°å¢ƒæ‡‰è©²æœ‰ä¸åŒçš„æ•ˆèƒ½èª¿å„ªè¨­å®šï¼š

```yaml
# application-local.yml (é–‹ç™¼ç’°å¢ƒ)
management:
  tracing:
    sampling:
      probability: 1.0  # 100% æ¡æ¨£ï¼Œæ–¹ä¾¿é™¤éŒ¯

# application-prod.yml (æ­£å¼ç’°å¢ƒ)
management:
  tracing:
    sampling:
      probability: 0.1  # 10% æ¡æ¨£ï¼Œæ¸›å°‘æ•ˆèƒ½å½±éŸ¿
```

### VSCode é–‹ç™¼ç’°å¢ƒè¨­å®š

å»ºè­°å»ºç«‹ `.vscode/launch.json` ä¾†ç°¡åŒ–é–‹ç™¼æµç¨‹ï¼š

```json
{
    "version": "0.2.0",
    "configurations": [
        {
            "type": "java",
            "name": "æœ¬åœ°é–‹ç™¼ç’°å¢ƒ",
            "request": "launch",
            "mainClass": "com.example.demo.DemoApplication",
            "projectName": "demo-springboot-250613",
            "env": {
                "spring.profiles.active": "local"
            }
        },
        {
            "type": "java",
            "name": "æœ¬åœ° + GCP æ¨¡æ“¬",
            "request": "launch",
            "mainClass": "com.example.demo.DemoApplication",
            "projectName": "demo-springboot-250613",
            "env": {
                "spring.profiles.active": "local,gcp"
            }
        }
    ]
}
```

---

## ğŸ› ï¸ é–‹ç™¼èˆ‡è¨­å®š

### é–‹ç™¼æŒ‡å—

- ç•¶ `openapi.yaml` æª”æ¡ˆæœ‰è®Šå‹•æ™‚ï¼Œéœ€è¦æ‰‹å‹•åŸ·è¡Œ `./gradlew clean openApiGenerate` æŒ‡ä»¤ï¼Œä¾†é‡æ–°ç”¢ç”Ÿ API ç›¸é—œçš„ç¨‹å¼ç¢¼ã€‚
- ä½¿ç”¨ `./gradlew bootRun --args='--spring.profiles.active=local'` æŒ‡ä»¤ï¼Œå¯ä»¥ç”¨ `local` è¨­å®šæª”ä¾†å•Ÿå‹•å°ˆæ¡ˆã€‚
- åœ¨æœ¬æ©Ÿé–‹ç™¼æ™‚ï¼Œå¯ä»¥åˆ° `http://localhost:8080/swagger-ui.html` æŸ¥çœ‹å’Œæ¸¬è©¦ APIã€‚

### IDE æ•´åˆ

é—œæ–¼ VSCode å’Œå…¶ä»– IDE çš„é–‹ç™¼ç’°å¢ƒè¨­å®šï¼Œè«‹åƒè€ƒä¸Šä¸€ç« ç¯€ **âš™ï¸ ç’°å¢ƒé…ç½®èˆ‡è¨­å®šæª”ç®¡ç†** ä¸­çš„è©³ç´°èªªæ˜ã€‚

---

## ğŸ¤ API First é–‹ç™¼æµç¨‹

é€™å€‹å°ˆæ¡ˆæ¡ç”¨ **API First** é–‹ç™¼æ¨¡å¼ã€‚ç°¡å–®ä¾†èªªï¼Œå°±æ˜¯ã€Œå…ˆå®šç¾©å¥½ API è¦æ ¼ï¼Œå†é–‹å§‹å¯«ç¨‹å¼ã€ã€‚

æˆ‘å€‘æœƒå…ˆæŠŠ API çš„æ‰€æœ‰ç´°ç¯€ï¼ˆåƒæ˜¯è·¯å¾‘ã€åƒæ•¸ã€å›å‚³æ ¼å¼ï¼‰éƒ½å¯«åœ¨ `openapi.yaml` é€™å€‹æª”æ¡ˆè£¡ã€‚é€™ä»½æª”æ¡ˆå°±æ˜¯æˆ‘å€‘å”¯ä¸€çš„ã€æœ€çµ‚çš„æ¨™æº–ï¼Œç¨±ç‚º**ã€Œå–®ä¸€äº‹å¯¦ä¾†æº (Single Source of Truth)ã€**ã€‚é€™æ¨£å¯ä»¥ç¢ºä¿ API æ–‡ä»¶å’Œå¯¦éš›ç¨‹å¼ç¢¼æ°¸é ä¿æŒä¸€è‡´ã€‚

### é‹ä½œæ–¹å¼

æˆ‘å€‘é€é `org.openapi.generator` é€™å€‹ Gradle å·¥å…·ä¾†å¯¦ç¾è‡ªå‹•åŒ–ã€‚ç•¶ä½ ç·¨è­¯å°ˆæ¡ˆæ™‚ï¼Œå®ƒæœƒåšå¹¾ä»¶äº‹ï¼š

1. **è®€å–è¦æ ¼**ï¼šè®€å– `dev-resources/openapi.yaml` æª”æ¡ˆçš„å…§å®¹ã€‚
2. **ç”¢ç”Ÿç¨‹å¼ç¢¼**ï¼šæ ¹æ“šè¦æ ¼ï¼Œè‡ªå‹•ç”¢ç”Ÿå°æ‡‰çš„ Java ä»‹é¢ (Interface) å’Œè³‡æ–™å‚³è¼¸ç‰©ä»¶ (DTO)ã€‚
3. **ç´å…¥ç·¨è­¯**ï¼šå°ˆæ¡ˆæœƒæŠŠé€™äº›è‡ªå‹•ç”¢ç”Ÿçš„ç¨‹å¼ç¢¼ç•¶ä½œåŸå§‹ç¢¼çš„ä¸€éƒ¨åˆ†ã€‚
4. **é–‹ç™¼è€…å¯¦ä½œ**ï¼šé–‹ç™¼äººå“¡åªéœ€è¦å°ˆå¿ƒå¯«å•†æ¥­é‚è¼¯ï¼Œå»å¯¦ä½œ (implement) é€™äº›è‡ªå‹•ç”¢ç”Ÿçš„ä»‹é¢ã€‚

### build.gradle ä¸­çš„é—œéµè¨­å®š

ä¾†çœ‹çœ‹ `openApiGenerate` é€™å€‹ä»»å‹™çš„è©³ç´°è¨­å®šï¼š

```groovy
tasks.named('openApiGenerate') {
    generatorName.set("spring")
    library.set("spring-cloud")
    inputSpec.set(layout.projectDirectory.file("dev-resources/openapi.yaml").asFile.path) // API è¦æ ¼æª”åœ¨å“ª
    outputDir.set(layout.buildDirectory.dir("generated/openapi").get().asFile.path)      // ç”¢ç”Ÿçš„ç¨‹å¼ç¢¼è¦æ”¾å“ª
    apiPackage.set("com.example.demo.interfaces.api")   // ç”¢ç”Ÿçš„ API ä»‹é¢è¦æ”¾åœ¨å“ªå€‹ package
    modelPackage.set("com.example.demo.interfaces.dto") // ç”¢ç”Ÿçš„ DTO æ¨¡å‹è¦æ”¾åœ¨å“ªå€‹ package
    configOptions.set([
        hateoas: "false",
        interfaceOnly: "true",        // âœ¨ åªç”¢ç”Ÿä»‹é¢ï¼Œä¸ç”¢ç”Ÿå¯¦ä½œé¡
        useResponseEntity: "true",    // âœ¨ API å›æ‡‰æ™‚ä½¿ç”¨ Spring çš„ ResponseEntity<T>
        useSpringBoot3: "true",       // âœ¨ ç¢ºä¿ç”¢ç”Ÿçš„ç¨‹å¼ç¢¼ç›¸å®¹ Spring Boot 3
        useTags: "true",              // âœ¨ æ ¹æ“š YAML ä¸­çš„ "tags" å±¬æ€§ä¾†åˆ†çµ„ API
        unhandledException: "true"    // âœ¨ å¼·åˆ¶é–‹ç™¼è€…è™•ç†æ‰€æœ‰å¯èƒ½çš„éŒ¯èª¤
    ])
}
```

**é‡è¦åƒæ•¸è§£æï¼š**

- `interfaceOnly: "true"`
  - **ä½œç”¨**ï¼šåªç”¢ç”Ÿ Java çš„ `interface` (ä»‹é¢)ï¼Œä¸æœƒç”¢ç”Ÿå¯¦éš›çš„ `Controller` å¯¦ä½œé¡åˆ¥ã€‚
  - **å¥½è™•**ï¼šè®“é–‹ç™¼è€…å¯ä»¥ä¿æœ‰å½ˆæ€§ï¼Œè‡ªç”±åœ°å»å¯¦ä½œèƒŒå¾Œçš„å•†æ¥­é‚è¼¯ã€‚

- `useSpringBoot3: "true"`
  - **ä½œç”¨**ï¼šç¢ºä¿ç”¢ç”Ÿçš„ç¨‹å¼ç¢¼è·Ÿ Spring Boot 3 ç›¸å®¹ã€‚
  - **å½±éŸ¿**ï¼šæœƒä½¿ç”¨æœ€æ–°çš„ Jakarta EE è¦ç¯„ï¼Œè€Œä¸æ˜¯èˆŠçš„ `javax`ã€‚

- `useTags: "true"`
  - **ä½œç”¨**ï¼šåœ¨ `openapi.yaml` è£¡ï¼Œå¯ä»¥å¹« API åŠ ä¸Š `tags` æ¨™ç±¤ã€‚é€™å€‹è¨­å®šæœƒæ ¹æ“šä¸åŒçš„æ¨™ç±¤ï¼Œç”¢ç”Ÿä¸åŒçš„ API ä»‹é¢æª”æ¡ˆã€‚
  - **å¥½è™•**ï¼šå¯ä»¥é¿å…æ‰€æœ‰ API éƒ½æ“ åœ¨ä¸€å€‹å·¨å¤§çš„æª”æ¡ˆè£¡ï¼Œè®“ç¨‹å¼ç¢¼æ›´å¥½ç¶­è­·ã€‚

- `useResponseEntity: "true"`
  - **ä½œç”¨**ï¼šè®“ API æ–¹æ³•çš„å›å‚³å‹åˆ¥è®Šæˆ Spring çš„ `ResponseEntity<T>`ã€‚
  - **å¥½è™•**ï¼šè®“æˆ‘å€‘å¯ä»¥æ›´ç²¾æº–åœ°æ§åˆ¶ HTTP å›æ‡‰çš„ç‹€æ…‹ç¢¼ (ä¾‹å¦‚ 200, 201, 404) å’Œ Headersã€‚

- `unhandledException: "true"`
  - **ä½œç”¨**ï¼šåœ¨ç”¢ç”Ÿçš„ä»‹é¢æ–¹æ³•ä¸ŠåŠ ä¸Š `throws Exception`ã€‚
  - **ç›®çš„**ï¼šå¼·åˆ¶é–‹ç™¼è€…å¿…é ˆå»æ€è€ƒå’Œè™•ç†å¯èƒ½ç™¼ç”Ÿçš„éŒ¯èª¤ï¼Œä¸èƒ½å‡è£æ²’çœ‹åˆ°ã€‚

- `hateoas: "false"`
  - **ä½œç”¨**ï¼šé—œé–‰ HATEOAS åŠŸèƒ½ã€‚é€™æ˜¯ä¸€ç¨®è®“ API å›æ‡‰åŒ…å«ç›¸é—œæ“ä½œé€£çµçš„é¢¨æ ¼ï¼Œä½†æˆ‘å€‘ä¸€èˆ¬çš„ RESTful API é€šå¸¸ç”¨ä¸åˆ°ã€‚

å…¶ä¸­ `interfaceOnly: "true"` é€™å€‹è¨­å®šï¼Œè®“å·¥å…·åªç”¢ç”Ÿ API çš„ã€Œè¦æ ¼ã€å’Œè³‡æ–™æ¨¡å‹ï¼Œè€Œ Controller çš„ã€Œå¯¦ä½œã€ç”±é–‹ç™¼è€…è‡ªå·±å®Œæˆã€‚é€™æœ‰åŠ©æ–¼æŠŠã€ŒAPI çš„å®šç¾©ã€å’Œã€Œå•†æ¥­é‚è¼¯çš„å¯¦ç¾ã€æ¼‚äº®åœ°åˆ†é–‹ã€‚

### API First çš„å„ªé»

- **å¥‘ç´„å³æ–‡ä»¶**ï¼š`openapi.yaml` æœ¬èº«å°±æ˜¯æœ€æº–ç¢ºã€æœ€æ–°çš„ API æ–‡ä»¶ã€‚
- **å¼·åˆ¶ä¸€è‡´æ€§**ï¼šå› ç‚ºæˆ‘å€‘çš„ `BookController` å¿…é ˆå¯¦ä½œ `BooksApi` é€™å€‹ä»‹é¢ï¼Œæ‰€ä»¥ä»»ä½•è·Ÿè¦æ ¼ä¸ç¬¦çš„ä¿®æ”¹ï¼Œåœ¨ç·¨è­¯éšæ®µå°±æœƒç›´æ¥å ±éŒ¯ï¼Œç„¡æ³•é€šéã€‚
- **å¹³è¡Œé–‹ç™¼**ï¼šå¾Œç«¯å·¥ç¨‹å¸«åœ¨é–‹ç™¼ API åŠŸèƒ½çš„åŒæ™‚ï¼Œå‰ç«¯å·¥ç¨‹å¸«æˆ–å…¶ä»–åœ˜éšŠï¼Œå¯ä»¥ç›´æ¥æ‹¿ `openapi.yaml` å»ç”¢ç”Ÿå‡çš„å®¢æˆ¶ç«¯ç¨‹å¼ (Client Stub) æˆ– Mock Server ä¾†é€²è¡Œé–‹ç™¼æ¸¬è©¦ï¼Œå®Œå…¨ä¸ç”¨ç­‰å¾…å¾Œç«¯å®Œæˆã€‚

---

## ğŸ—ºï¸ ç‰©ä»¶æ˜ å°„ (MapStruct)

åœ¨å°ˆæ¡ˆè£¡ï¼Œæˆ‘å€‘ç”¨åˆ°äº†é€™å…©å€‹å¥—ä»¶ï¼š

- `org.mapstruct:mapstruct`
- `org.mapstruct:mapstruct-processor`

### ç”¨é€”

åœ¨åˆ†å±¤æ¶æ§‹ä¸­ï¼Œæˆ‘å€‘é€šå¸¸ä¸å¸Œæœ›æŠŠä»£è¡¨è³‡æ–™åº«è¡¨æ ¼çš„ç‰©ä»¶ (Entity) ç›´æ¥å‚³çµ¦å‰ç«¯æˆ–å¤–éƒ¨ä½¿ç”¨è€…ã€‚å› æ­¤ï¼Œæˆ‘å€‘æœƒå»ºç«‹ä¸€ç¨®å°ˆé–€ç”¨ä¾†å‚³è¼¸è³‡æ–™çš„ç‰©ä»¶ (DTO)ã€‚

MapStruct æ˜¯ä¸€å€‹å°ˆé–€è™•ç†ã€Œç‰©ä»¶è½‰æ›ã€çš„å·¥å…·ã€‚å®ƒèƒ½è‡ªå‹•å¹«æˆ‘å€‘ç”¢ç”Ÿ Entity å’Œ DTO ä¹‹é–“äº’ç›¸è½‰æ›çš„ç¨‹å¼ç¢¼ã€‚

### å„ªé»

- **æ•ˆèƒ½å¥½**ï¼šå®ƒåœ¨ç·¨è­¯ç¨‹å¼ç¢¼çš„æ™‚å€™å°±ç”¢ç”Ÿäº†å¯¦éš›çš„ Java è½‰æ›ç¨‹å¼ï¼ŒåŸ·è¡Œæ™‚ä¸éœ€è¦é åå°„ï¼Œæ‰€ä»¥é€Ÿåº¦éå¸¸å¿«ã€‚
- **å‹åˆ¥å®‰å…¨**ï¼šå¦‚æœåœ¨è½‰æ›æ™‚ï¼Œå…©å€‹ç‰©ä»¶çš„æ¬„ä½åç¨±æˆ–å‹åˆ¥å°ä¸ä¸Šï¼Œç·¨è­¯å°±æœƒç›´æ¥å¤±æ•—ï¼Œèƒ½ææ—©ç™¼ç¾éŒ¯èª¤ã€‚
- **æ¸›å°‘æ¨£æ¿ç¨‹å¼ç¢¼**ï¼šé–‹ç™¼è€…åªéœ€è¦å®šç¾©ä¸€å€‹è½‰æ›çš„ä»‹é¢ï¼ŒMapStruct å°±æœƒè‡ªå‹•ç”¢ç”Ÿæ‰€æœ‰ get/set çš„å°æ‡‰ç¨‹å¼ç¢¼ï¼Œéå¸¸çœäº‹ã€‚

### build.gradleä¸­çš„é—œéµè¨­å®š

```groovy
tasks.withType(JavaCompile) {
    options.compilerArgs = [
        // å‘Šè¨´ MapStructï¼Œç”¢ç”Ÿçš„è½‰æ›å™¨è¦æ˜¯ä¸€å€‹ Spring Beanï¼Œæ–¹ä¾¿æ³¨å…¥
        '-Amapstruct.defaultComponentModel=spring',
        // ç”¢ç”Ÿçš„ç¨‹å¼ç¢¼ä¸­ä¸åŒ…å«æ™‚é–“æˆ³ï¼Œé€™èƒ½ç¢ºä¿æ¯æ¬¡å»ºç½®çš„çµæœéƒ½å®Œå…¨ç›¸åŒ
        '-Amapstruct.suppressGeneratorTimestamp=true',
        // åœ¨å»ºç½®éç¨‹ä¸­å•Ÿç”¨è©³ç´°æ—¥èªŒï¼Œæ–¹ä¾¿é™¤éŒ¯
        '-Amapstruct.verbose=true',
        // ä¿ç•™æ–¹æ³•çš„åƒæ•¸åç¨±ï¼Œé€™å°æ–¼ Spring Cache è§£æ SpEL è¡¨é”å¼ (å¦‚ #id) è‡³é—œé‡è¦
        '-parameters'
    ]
}
```

### Mapper ä»‹é¢å®šç¾© (`BookMapper.java`)

æˆ‘å€‘å®šç¾©ä¸€å€‹ `BookMapper` ä»‹é¢ï¼Œä¸¦ç”¨ `@Mapper` æ¨™ç±¤å‘Šè¨´ MapStruct é€™æ˜¯å€‹è½‰æ›å™¨ã€‚è¨­å®š `componentModel = "spring"` å¾Œï¼ŒMapStruct ç”¢ç”Ÿçš„ `BookMapperImpl` é¡åˆ¥æœƒè‡ªå‹•åŠ ä¸Š `@Component` æ¨™ç±¤ï¼Œé€™æ¨£å®ƒå°±èƒ½åƒä¸€å€‹ Spring Bean ä¸€æ¨£ï¼Œè¢«æ³¨å…¥åˆ°å…¶ä»–åœ°æ–¹ä½¿ç”¨ã€‚

```java
@Mapper(
    unmappedTargetPolicy = ReportingPolicy.IGNORE,  // å¿½ç•¥ç›®æ¨™ç‰©ä»¶ä¸­æœªè¢«æ˜ å°„çš„å±¬æ€§ï¼Œé¿å…ç·¨è­¯æ™‚ç”¢ç”Ÿè­¦å‘Š
    nullValuePropertyMappingStrategy = NullValuePropertyMappingStrategy.IGNORE // ç•¶ä¾†æºç‰©ä»¶å±¬æ€§ç‚º null æ™‚ï¼Œä¸æ›´æ–°ç›®æ¨™ç‰©ä»¶çš„å°æ‡‰å±¬æ€§
)
public interface BookMapper {
    // å°‡ BookDto (DTO) è½‰æ›ç‚º Book (Entity)
    Book toEntity(BookDto dto);

    // å°‡ Book (Entity) è½‰æ›ç‚º BookDto (DTO)
    BookDto toDto(Book entity);
}
```

### ä½¿ç”¨ç¯„ä¾‹

```java
@RestController
@RequiredArgsConstructor // Lombok çš„è¨»è§£ï¼Œæœƒè‡ªå‹•ç‚º final æ¬„ä½å»ºç«‹å»ºæ§‹å­ä¸¦æ³¨å…¥
public class BookController implements BooksApi {

    private final BookService bookService;
    private final BookMapper bookMapper; // âœ¨ MapStruct ç”¢ç”Ÿçš„è½‰æ›å™¨è¢«æ³¨å…¥é€²ä¾†

    @Override
    public ResponseEntity<BookDto> booksPost(@Valid BookRequest bookRequest) {
        // å‘¼å« mapperï¼Œå°‡å‰ç«¯å‚³ä¾†çš„ Request DTO è½‰æˆè³‡æ–™åº«ç”¨çš„ Entity
        Book bookEntity = bookMapper.toEntity(bookRequest);

        Book createdBook = bookService.createBook(bookEntity);

        // å‘¼å« mapperï¼Œå°‡è³‡æ–™åº«å›å‚³çš„ Entity è½‰æˆè¦å›çµ¦å‰ç«¯çš„ Response DTO
        BookDto responseDto = bookMapper.toDto(createdBook);

        return ResponseEntity.status(HttpStatus.CREATED).body(responseDto);
    }
}
```

---

## ğŸ“œ è³‡æ–™åº«ç‰ˆæœ¬æ§åˆ¶ (Liquibase)

åœ¨åœ˜éšŠé–‹ç™¼ä¸­ï¼Œç®¡ç†è³‡æ–™åº«çµæ§‹ (Schema) çš„è®Šæ›´æ˜¯ä¸€å¤§æŒ‘æˆ°ã€‚å¦‚æœæ¯å€‹äººéƒ½éš¨æ„åœ¨è‡ªå·±çš„é›»è…¦ä¸Šä¿®æ”¹è³‡æ–™åº«ï¼Œæˆ–æ˜¯ä¾è³´ JPA çš„ `ddl-auto: update` åŠŸèƒ½ï¼Œå¾ˆå®¹æ˜“é€ æˆæ¯å€‹äººçš„è³‡æ–™åº«é•·å¾—ä¸ä¸€æ¨£ï¼Œæœ€å¾Œå¼•ç™¼å„ç¨®å¥‡æ€ªçš„éŒ¯èª¤ã€‚

é€™å€‹å°ˆæ¡ˆä½¿ç”¨ Liquibaseï¼ŒæŠŠè³‡æ–™åº«çš„çµæ§‹è®Šæ›´ç•¶ä½œç¨‹å¼ç¢¼ä¸€æ¨£ä¾†ç®¡ç†ã€‚é€™ç¢ºä¿äº†å¾é–‹ç™¼ã€æ¸¬è©¦åˆ°æ­£å¼ä¸Šç·šï¼Œæ‰€æœ‰ç’°å¢ƒçš„è³‡æ–™åº«çµæ§‹éƒ½æ˜¯ä¸€è‡´ä¸”å¯ä»¥è¿½è¹¤çš„ã€‚

### ç‚ºä»€éº¼ä¸ç”¨ ddl-auto?

é›–ç„¶ `spring.jpa.hibernate.ddl-auto = update` åœ¨é–‹ç™¼åˆæœŸå¾ˆæ–¹ä¾¿ï¼Œä½†å®ƒæœ‰å¹¾å€‹åš´é‡çš„å•é¡Œï¼š

- **ç„¡æ³•ç²¾ç¢ºæ§åˆ¶**ï¼šä½ æ²’è¾¦æ³•æ§åˆ¶å®ƒå…·é«”æœƒç”¢ç”Ÿä»€éº¼æ¨£çš„ SQL æŒ‡ä»¤ã€‚
- **å¯èƒ½éºå¤±è³‡æ–™**ï¼šåœ¨æŸäº›æƒ…æ³ä¸‹ï¼Œå®ƒå¯èƒ½æœƒèª¤åˆ¤è€Œåˆªé™¤æ¬„ä½æˆ–è¡¨æ ¼ï¼Œå°è‡´è³‡æ–™éºå¤±ã€‚
- **æ²’æœ‰ç‰ˆæœ¬ç´€éŒ„**ï¼šä½ å®Œå…¨ä¸çŸ¥é“è³‡æ–™åº«åœ¨ä»€éº¼æ™‚å€™ã€è¢«èª°ã€æ”¹äº†ä»€éº¼æ±è¥¿ã€‚
- **ä¸é©ç”¨æ–¼æ­£å¼ç’°å¢ƒ**ï¼šåœ¨æ­£å¼ç’°å¢ƒä¸­ï¼Œçµ•å°ä¸èƒ½ä½¿ç”¨ `update`ã€‚

Liquibase ç”¨ä¸€å€‹æ›´åš´è¬¹çš„æµç¨‹è§£æ±ºäº†é€™äº›å•é¡Œã€‚

### Liquibase å¦‚ä½•é‹ä½œï¼Ÿ

- **è‡ªå‹•åŸ·è¡Œ**ï¼šç•¶ Spring Boot å°ˆæ¡ˆå•Ÿå‹•æ™‚ï¼Œå®ƒæœƒåµæ¸¬åˆ° Liquibase çš„å­˜åœ¨ï¼Œä¸¦è‡ªå‹•åŸ·è¡Œè³‡æ–™åº«çš„æ›´æ–°ã€‚
- **è®Šæ›´æ—¥èªŒ (Changelog)**ï¼šé–‹ç™¼è€…æŠŠæ‰€æœ‰å°è³‡æ–™åº«çš„ä¿®æ”¹ï¼ˆä¾‹å¦‚æ–°å¢è¡¨æ ¼ã€å¢åŠ æ¬„ä½ï¼‰ï¼Œéƒ½å¯«åœ¨ã€Œè®Šæ›´æ—¥èªŒã€æª”æ¡ˆè£¡ã€‚æˆ‘å€‘é€™è£¡ç”¨çš„æ˜¯ YAML æ ¼å¼ã€‚
- **è¿½è¹¤è¡¨**ï¼šLiquibase æœƒåœ¨ä½ çš„è³‡æ–™åº«è£¡å»ºç«‹å…©å¼µç®¡ç†ç”¨çš„è¡¨æ ¼ï¼š`DATABASECHANGELOG` å’Œ `DATABASECHANGELOGLOCK`ã€‚
  - `DATABASECHANGELOGLOCK`ï¼šé€™æ˜¯ä¸€æŠŠé–ã€‚å®ƒç¢ºä¿åœ¨åŒä¸€æ™‚é–“ï¼Œåªæœ‰ä¸€å€‹ç¨‹å¼å¯¦ä¾‹åœ¨åŸ·è¡Œè³‡æ–™åº«è®Šæ›´ï¼Œé¿å…å¤§å®¶æ¶è‘—ä¿®æ”¹é€ æˆè¡çªã€‚
  - `DATABASECHANGELOG`ï¼šé€™æ˜¯ä¸€å¼µç´€éŒ„è¡¨ã€‚æ¯ä¸€å€‹è¢«æˆåŠŸåŸ·è¡Œçš„è®Šæ›´éƒ½æœƒè¢«è¨˜åœ¨è£¡é¢ã€‚æ¯æ¬¡å°ˆæ¡ˆå•Ÿå‹•ï¼ŒLiquibase å°±æœƒæ¯”å°æ—¥èªŒæª”å’Œé€™å¼µè¡¨ï¼ŒåªåŸ·è¡Œé‚£äº›é‚„æ²’è¢«è¨˜éŒ„éçš„ã€æ–°çš„è®Šæ›´ã€‚

### å°ˆæ¡ˆå¯¦è¸

#### ä¸»è®Šæ›´æ—¥èªŒ (Master Changelog)

é€™æ˜¯ Liquibase çš„å…¥å£æª”æ¡ˆï¼Œæ”¾åœ¨ `src/main/resources/db/changelog/db.changelog-master.yaml`ã€‚å®ƒæœ¬èº«ä¸å¯«å…·é«”çš„ SQL è®Šæ›´ï¼Œè€Œæ˜¯åƒä¸€æœ¬æ›¸çš„ç›®éŒ„ï¼Œè² è²¬å¼•ç”¨å…¶ä»–è®Šæ›´æª”æ¡ˆã€‚

```yaml
# db.changelog-master.yaml
databaseChangeLog:
  - include:
      file: history/20250614.yaml
      relativeToChangelogFile: true # è·¯å¾‘æ˜¯ç›¸å°æ–¼é€™å€‹ä¸»æª”æ¡ˆ
      description: åˆå§‹åŒ–è¡¨æ ¼
  # âœ¨ ç•¶æœ‰æ–°çš„è®Šæ›´æ™‚ï¼Œå°±åœ¨ä¸‹é¢æ–°å¢ä¸€è¡Œ include
  # - include:
  #     file: history/20250615.yaml
  #     relativeToChangelogFile: true
  #     description: æ–°å¢ä½¿ç”¨è€…è¡¨æ ¼
```

#### è®Šæ›´é›†æª”æ¡ˆ (Changeset File)

æ‰€æœ‰å¯¦éš›çš„è³‡æ–™åº«çµæ§‹è®Šæ›´éƒ½å®šç¾©åœ¨é€™äº›æª”æ¡ˆè£¡ã€‚æˆ‘å€‘æŠŠå®ƒå€‘æ”¾åœ¨ `history/` è³‡æ–™å¤¾ï¼Œä¸¦ç”¨æ—¥æœŸå‘½åï¼Œæ–¹ä¾¿è¿½è¹¤ã€‚ä¸€å€‹æª”æ¡ˆå¯ä»¥åŒ…å«å¤šå€‹ `changeSet`ã€‚æ¯å€‹ `changeSet` éƒ½æ˜¯ä¸€å€‹ç¨ç«‹çš„ã€ä¸å¯è®Šæ›´çš„è³‡æ–™åº«æ“ä½œå–®ä½ï¼Œç”± `id` å’Œ `author` å”¯ä¸€æ¨™è­˜ã€‚

`history/20250614.yaml` çš„å…§å®¹ç¯„ä¾‹ï¼š

```yaml
# history/20250614.yaml
databaseChangeLog:
- changeSet:
    id: 1749857749130-1 # å”¯ä¸€çš„ IDï¼Œå¯ä»¥æ˜¯æ•¸å­—ã€å­—ä¸²æˆ–è‡ªå‹•ç”¢ç”Ÿ
    author: samzhu (generated)
    changes:
    - createTable:
        tableName: book
        remarks: æ›¸æœ¬è³‡æ–™è¡¨ï¼Œç”¨æ–¼å„²å­˜æ›¸æœ¬çš„åŸºæœ¬è³‡è¨Š
        columns:
        - column:
            name: id
            type: INTEGER
            autoIncrement: true
            constraints:
              primaryKey: true
              nullable: false
        - column:
            name: title
            type: VARCHAR(255)
            constraints:
              nullable: false
        #... å…¶ä»–æ¬„ä½...
```

#### é–‹ç™¼æµç¨‹ï¼šå¦‚ä½•æ–°å¢ä¸€ç­†è³‡æ–™åº«è®Šæ›´ï¼Ÿ

å‡è¨­ä½ éœ€è¦ç‚º `book` è¡¨æ ¼å¢åŠ ä¸€å€‹ `stock_quantity` (åº«å­˜æ•¸é‡) æ¬„ä½ã€‚

1. **å»ºç«‹æ–°æª”æ¡ˆ**ï¼šåœ¨ `src/main/resources/db/changelog/history/` ç›®éŒ„ä¸‹å»ºç«‹ä¸€å€‹æ–°çš„ YAML æª”ï¼Œä¾‹å¦‚ `20250616-add-stock-to-book.yaml`ã€‚
2. **å®šç¾© ChangeSet**ï¼šåœ¨æ–°æª”æ¡ˆè£¡ï¼Œå¯«ä¸‹ä½ çš„è®Šæ›´å…§å®¹ã€‚è¨˜å¾— `id` å¿…é ˆæ˜¯ç¨ä¸€ç„¡äºŒçš„ã€‚
3. **æ›´æ–°ä¸»æª”æ¡ˆ**ï¼šå›åˆ° `db.changelog-master.yaml`ï¼ŒæŠŠå‰›å‰›å»ºç«‹çš„æ–°æª”æ¡ˆ `include` é€²ä¾†ã€‚

    ```yaml
    databaseChangeLog:
      - include:
          file: history/20250614.yaml
          relativeToChangelogFile: true
          description: åˆå§‹åŒ–è¡¨æ ¼
      - include: # âœ¨ æ–°å¢é€™ä¸€æ®µ
          file: history/20250616-add-stock-to-book.yaml
          relativeToChangelogFile: true
          description: ç‚ºæ›¸æœ¬æ–°å¢åº«å­˜æ¬„ä½
    ```

4. **å•Ÿå‹•æ‡‰ç”¨**ï¼šé‡æ–°å•Ÿå‹• Spring Boot å°ˆæ¡ˆã€‚Liquibase æœƒæª¢æŸ¥ `DATABASECHANGELOG` è¡¨ï¼Œç™¼ç¾é€™å€‹æ–°çš„ `changeSet` é‚„æ²’è¢«åŸ·è¡Œéï¼Œæ–¼æ˜¯å®ƒå°±æœƒåŸ·è¡Œå°æ‡‰çš„ `ALTER TABLE` SQL æŒ‡ä»¤ï¼Œå¹«ä½ çš„è³‡æ–™åº«åŠ ä¸Šæ–°æ¬„ä½ã€‚

é€™å€‹æµç¨‹ç¢ºä¿äº†æ¯ä¸€æ¬¡è³‡æ–™åº«è®Šæ›´éƒ½æœ‰ç´€éŒ„ã€å¯è¿½è¹¤ï¼Œä¸¦ä¸”èƒ½åœ¨åœ˜éšŠæ‰€æœ‰æˆå“¡å’Œæ‰€æœ‰ç’°å¢ƒä¸­è‡ªå‹•ä¸”ä¸€è‡´åœ°è¢«æ‡‰ç”¨ã€‚

---

## âš¡ï¸ å¿«å–æ©Ÿåˆ¶ (Spring Cache + Redis)

ç‚ºäº†åŠ å¿«æ‡‰ç”¨ç¨‹å¼çš„å›æ‡‰é€Ÿåº¦ï¼Œä¸¦æ¸›è¼•è³‡æ–™åº«çš„å£“åŠ›ï¼Œæˆ‘å€‘å°å…¥äº†å¿«å–æ©Ÿåˆ¶ã€‚å°æ–¼é‚£äº›ä¸å¸¸è®Šå‹•ä½†åˆç¶“å¸¸è¢«è®€å–çš„è³‡æ–™ï¼Œå¿«å–å¯ä»¥å¤§å¹…æå‡æ•ˆèƒ½ã€‚

é€™å€‹å°ˆæ¡ˆä½¿ç”¨ **Spring Cache** ä½œç‚ºçµ±ä¸€çš„å¿«å–æ¨™æº–ï¼Œä¸¦ä»¥ **Redis** ä½œç‚ºå¯¦éš›çš„å¿«å–å·¥å…·ã€‚

### Spring Cache: ä¸€è‡´çš„å¿«å–æŠ½è±¡

`spring-boot-starter-cache` æä¾›äº†ä¸€å¥—æ¨™æº–çš„å¿«å– APIã€‚å®ƒçš„æœ€å¤§å¥½è™•æ˜¯è®“æˆ‘å€‘çš„å•†æ¥­é‚è¼¯ç¨‹å¼ç¢¼ï¼Œä¸ç”¨å»ç®¡åº•å±¤åˆ°åº•æ˜¯ç”¨ä»€éº¼æŠ€è¡“ä¾†åšå¿«å–ã€‚é–‹ç™¼è€…åªéœ€è¦å­¸æœƒç”¨å¹¾å€‹æ¨™æº–çš„è¨»è§£ï¼Œå°±èƒ½å¹«ç¨‹å¼åŠ ä¸Šå¿«å–åŠŸèƒ½ã€‚

- `@EnableCaching`ï¼šåœ¨è¨­å®šé¡åˆ¥ä¸Šä½¿ç”¨ï¼Œæ˜¯æ‰“é–‹ Spring Cache åŠŸèƒ½çš„ç¸½é–‹é—œã€‚
- `@Cacheable`ï¼šç”¨åœ¨è®€å–è³‡æ–™çš„æ–¹æ³•ä¸Šã€‚ç•¶ç¨‹å¼åŸ·è¡Œåˆ°é€™å€‹æ–¹æ³•æ™‚ï¼ŒSpring æœƒå…ˆå»å¿«å–è£¡æ‰¾çœ‹çœ‹æœ‰æ²’æœ‰è³‡æ–™ã€‚å¦‚æœæœ‰ï¼Œå°±ç›´æ¥å¾å¿«å–å›å‚³ï¼Œä¸æœƒåŸ·è¡Œæ–¹æ³•æœ¬èº«ã€‚å¦‚æœæ²’æœ‰ï¼Œå®ƒæ‰æœƒå»åŸ·è¡Œæ–¹æ³•ï¼Œä¸¦æŠŠæ–¹æ³•çš„åŸ·è¡Œçµæœå­˜é€²å¿«å–ï¼Œç„¶å¾Œå†å›å‚³ã€‚
- `@CacheEvict`ï¼šç”¨åœ¨ä¿®æ”¹æˆ–åˆªé™¤è³‡æ–™çš„æ–¹æ³•ä¸Šã€‚ç•¶è³‡æ–™è¢«è®Šæ›´æ™‚ï¼Œç”¨é€™å€‹è¨»è§£ä¾†æ¸…é™¤å¿«å–è£¡çš„èˆŠè³‡æ–™ï¼Œé¿å…ä½¿ç”¨è€…è®€åˆ°éæœŸçš„å…§å®¹ã€‚

### Redis: é«˜æ•ˆèƒ½çš„å¿«å–å¯¦ç¾

æˆ‘å€‘é¸æ“‡ Redis ä½œç‚ºå¿«å–ä¼ºæœå™¨ã€‚å› ç‚º Spring Boot å¼·å¤§çš„è‡ªå‹•è¨­å®šåŠŸèƒ½ï¼Œæ•´åˆ Redis éå¸¸ç°¡å–®ï¼š

1. åœ¨ `build.gradle` ä¸­åŠ å…¥ `spring-boot-starter-data-redis` é€™å€‹ä¾è³´ã€‚
2. åœ¨ `application.yml` ä¸­è¨­å®šå¥½ Redis çš„é€£ç·šä½å€ã€‚

åªè¦å®Œæˆé€™å…©æ­¥ï¼ŒSpring Boot å°±æœƒè‡ªå‹•æŠŠ Redis è¨­å®šæˆæˆ‘å€‘é è¨­çš„å¿«å–å·¥å…·ã€‚

### å¿«å–å¯¦è¸

æˆ‘å€‘å¯ä»¥åƒè€ƒ `BookService` è£¡çš„å¿«å–è¨­è¨ˆã€‚

#### ç­–ç•¥ï¼šåªå¿«å–é«˜é »è®€å–çš„å–®ä¸€é …ç›®

åœ¨å°ˆæ¡ˆä¸­ï¼Œæˆ‘å€‘æ¡ç”¨äº†æ›´ç²¾æº–çš„å¿«å–ç­–ç•¥ã€‚æˆ‘å€‘ç™¼ç¾ã€Œç²å–æ‰€æœ‰æ›¸æœ¬ã€(`getAllBooks()`) é€™å€‹æ“ä½œï¼Œå¯èƒ½æœƒå›å‚³å¤§é‡è³‡æ–™ï¼Œè€Œä¸”åªè¦ä»»ä½•ä¸€æœ¬æ›¸æœ‰è®Šå‹•ï¼Œæ•´å€‹åˆ—è¡¨å¿«å–å°±å¾—ä½œå»¢ï¼Œæ•ˆç›Šä¸é«˜ã€‚

å› æ­¤ï¼Œæˆ‘å€‘çš„ç­–ç•¥æ˜¯ï¼š**åªå¿«å– `getBookById(id)` é€™ç¨®è®€å–å–®ä¸€é …ç›®ã€ä¸”ä½¿ç”¨é »ç‡é«˜çš„æ“ä½œ**ã€‚

#### 1. å•Ÿç”¨å¿«å–åŠŸèƒ½

æˆ‘å€‘åœ¨ `CacheConfig.java` æª”æ¡ˆä¸­å•Ÿç”¨å¿«å–ï¼Œä¸¦å®šç¾©å¿«å–ç©ºé–“çš„åç¨±ã€‚

```java
// src/main/java/com/example/demo/config/CacheConfig.java
@Configuration
@EnableCaching // âœ¨ å•Ÿç”¨å¿«å–åŠŸèƒ½çš„ç¸½é–‹é—œ
public class CacheConfig {
    /**
     * å®šç¾©ä¸€å€‹å«åš "books" çš„å¿«å–ç©ºé–“åç¨±
     */
    public static final String BOOKS_CACHE = "books";
}
```

#### 2. å¿«å–å–®ä¸€æ›¸æœ¬çš„è®€å–æ“ä½œ

æˆ‘å€‘åªåœ¨ `getBookById` é€™å€‹æ–¹æ³•ä¸ŠåŠ ä¸Š `@Cacheable` è¨»è§£ã€‚æ³¨æ„ `key` çš„å¯«æ³•ï¼Œæˆ‘å€‘ç”¨äº†ä¸€é»å°æŠ€å·§ä¾†çµ„åˆå‡ºæ›´æœ‰æ„ç¾©çš„éµå€¼ã€‚

```java
// src/main/java/com/example/demo/applications/BookService.java
@Service
public class BookService {
    //...

    /**
     * æ ¹æ“š ID ç²å–æ›¸æœ¬ã€‚
     * @Cacheable æœƒå°‡çµæœå­˜å…¥åç‚º 'books' çš„å¿«å–ç©ºé–“ï¼Œ
     * ä¸¦ä»¥ 'book_{id}' ä½œç‚º keyã€‚
     */
    @Cacheable(cacheNames = CacheConfig.BOOKS_CACHE, key = "'book_' + #id")
    public Book getBookById(Integer id) {
        // âœ¨ é€™è¡Œ log åªæœƒåœ¨å¿«å–è£¡æ‰¾ä¸åˆ°è³‡æ–™ (cache miss) æ™‚æ‰æœƒå°å‡º
        log.info("å¾è³‡æ–™åº«ç²å–æ›¸æœ¬ ID: {}", id);
        return bookRepository.findById(id)
           .orElseThrow(() -> new ResponseStatusException(HttpStatus.NOT_FOUND, "æ‰¾ä¸åˆ°æŒ‡å®šçš„æ›¸æœ¬"));
    }
}
```

`key = "'book_' + #id"`ï¼šé€™æ˜¯ä¸€å€‹å¾ˆå¥½çš„å¯¦è¸ã€‚å®ƒå¹«æ‰€æœ‰è·Ÿæ›¸æœ¬ç›¸é—œçš„å¿«å–éµéƒ½åŠ ä¸Šäº† `book_` é€™å€‹å‰ç¶´ã€‚ç•¶ `id` æ˜¯ `123` æ™‚ï¼Œå­˜åœ¨ Redis è£¡çš„éµå°±æœƒæ˜¯ `book_123`ï¼Œè€Œä¸æ˜¯å–®ç´”çš„ `123`ã€‚é€™å¤§å¤§æé«˜äº†å¯è®€æ€§ï¼Œä¹Ÿé¿å…äº†å’Œå…¶ä»–ä¹Ÿç”¨æ•¸å­—ç•¶ ID çš„å¿«å–ï¼ˆä¾‹å¦‚ `user_123`ï¼‰ææ··ã€‚

#### 3. ç²¾ç¢ºåœ°æ¸…é™¤å–®ä¸€å¿«å–

å› ç‚ºæˆ‘å€‘ä¸å†å¿«å–æ•´å€‹æ›¸æœ¬åˆ—è¡¨ï¼Œæ‰€ä»¥åœ¨æ›´æ–°æˆ–åˆªé™¤ä¸€æœ¬æ›¸æ™‚ï¼Œæˆ‘å€‘ä¹Ÿä¸éœ€è¦æ¸…ç©ºæ‰€æœ‰æ›¸æœ¬çš„å¿«å–ã€‚æˆ‘å€‘åªéœ€è¦ç²¾ç¢ºåœ°æ¸…é™¤é‚£ä¸€æœ¬è¢«ä¿®æ”¹æˆ–åˆªé™¤çš„æ›¸çš„å¿«å–ã€‚

```java
// src/main/java/com/example/demo/applications/BookService.java
@Service
public class BookService {
    //...

    /**
     * æ›´æ–°æ›¸æœ¬ã€‚
     * @CacheEvict åªæœƒæ¸…é™¤ 'books' å¿«å–ä¸­ï¼Œkey ç‚º 'book_{id}' çš„é‚£ç­†è³‡æ–™ã€‚
     */
    @Transactional
    @CacheEvict(cacheNames = CacheConfig.BOOKS_CACHE, key = "'book_' + #id")
    public Book updateBook(Integer id, Book book) {
        //...
    }

    /**
     * åˆªé™¤æ›¸æœ¬ã€‚
     * åŒæ¨£åœ°ï¼Œåªæ¸…é™¤è¢«åˆªé™¤çš„é‚£æœ¬æ›¸çš„å¿«å–ã€‚
     */
    @Async
    @Transactional
    @CacheEvict(cacheNames = CacheConfig.BOOKS_CACHE, key = "'book_' + #id")
    public void deleteBook(Integer id) {
        //...
    }
}
```

`createBook` (æ–°å¢æ›¸æœ¬) çš„æ–¹æ³•ç¾åœ¨ä¸éœ€è¦ä»»ä½• `@CacheEvict` è¨»è§£ã€‚å› ç‚ºæ–°å¢ä¸€æœ¬æ›¸ï¼Œä¸¦ä¸æœƒè®“ä»»ä½•å·²ç¶“å­˜åœ¨çš„å¿«å–è³‡æ–™è®Šæˆã€ŒèˆŠçš„ã€æˆ–ã€ŒéŒ¯çš„ã€ã€‚

#### 4. é—œéµè¨­å®šï¼šè®“ `#id` è¡¨é”å¼ç”Ÿæ•ˆ

ç•¶æˆ‘å€‘åœ¨ `@Cacheable` æˆ– `@CacheEvict` ä¸­ä½¿ç”¨åƒ `key = "#id"` é€™æ¨£çš„ SpEL è¡¨é”å¼æ™‚ï¼Œæˆ‘å€‘å…¶å¯¦æ˜¯åœ¨å‘Šè¨´ Springï¼šã€Œè«‹ä½¿ç”¨é€™å€‹æ–¹æ³•çš„ `id` åƒæ•¸ä½œç‚ºå¿«å–çš„éµã€ã€‚

ä½† Spring è¦æ€éº¼çŸ¥é“é‚£å€‹åƒæ•¸å°±å«åš `id` å‘¢ï¼Ÿåœ¨é è¨­æƒ…æ³ä¸‹ï¼ŒJava ç·¨è­¯å™¨ç‚ºäº†ç¯€çœç©ºé–“ï¼Œä¸¦ä¸æœƒæŠŠæ–¹æ³•çš„åƒæ•¸åç¨±ï¼ˆä¾‹å¦‚ `id`, `book`ï¼‰ä¿ç•™åœ¨ç·¨è­¯å¾Œçš„ `.class` æª”æ¡ˆä¸­ã€‚é€™æœƒå°è‡´ Spring Cache åœ¨è§£æ `#id` æ™‚æ‰¾ä¸åˆ°å°æ‡‰çš„åƒæ•¸ï¼Œé€²è€Œå¼•ç™¼éŒ¯èª¤ã€‚

ç‚ºäº†è§£æ±ºé€™å€‹å•é¡Œï¼Œæˆ‘å€‘å¿…é ˆæ˜ç¢ºåœ°å‘Šè¨´ç·¨è­¯å™¨ï¼Œè«‹å®ƒä¿ç•™é€™äº›åƒæ•¸åç¨±ã€‚é€™åªéœ€è¦åœ¨ `build.gradle` ä¸­åŠ ä¸Šä¸€å€‹è¨­å®šï¼š

```groovy
// build.gradle
tasks.withType(JavaCompile) {
    options.compilerArgs = [
        '-Amapstruct.defaultComponentModel=spring',
        '-Amapstruct.suppressGeneratorTimestamp=true',
        '-Amapstruct.verbose=true',
        '-parameters' // âœ¨ é—œéµå°±åœ¨é€™è£¡ï¼
    ]
}
```

åŠ ä¸Šäº† `-parameters` é€™å€‹ç·¨è­¯å™¨æ——æ¨™å¾Œï¼ŒSpring Cache å°±èƒ½å–å¾—è¶³å¤ çš„è³‡è¨Šï¼Œæ­£ç¢ºåœ°å°‡ `#id` è§£æç‚º `getBookById(Integer id)` æ–¹æ³•ä¸­çš„ `id` åƒæ•¸å€¼ï¼Œè®“æˆ‘å€‘çš„å‹•æ…‹å¿«å–éµèƒ½å¤ é †åˆ©é‹ä½œã€‚é€™å€‹è¨­å®šæ˜¯å°ˆæ¡ˆä¸­æ‰€æœ‰ä¾è³´åƒæ•¸åç¨±çš„å·¥å…·ï¼ˆåŒ…æ‹¬ MapStructï¼‰å…±äº«çš„ã€‚

#### ç­–ç•¥çš„å„ªå‹¢

é€™ç¨®ã€Œåªå¿«å–å–®ä¸€é …ç›®ã€çš„ç­–ç•¥æ›´ç°¡å–®ï¼Œä¹Ÿæ›´æœ‰æ•ˆç‡ï¼š

- **é‚è¼¯ç°¡å–®**ï¼šä¸ç”¨å†ç…©æƒ±åˆ—è¡¨å¿«å–ä»€éº¼æ™‚å€™è©²æ¸…ã€ä»€éº¼æ™‚å€™ä¸ç”¨æ¸…çš„å•é¡Œã€‚
- **æ•ˆèƒ½æå‡**ï¼šé‡å°æœ€å¸¸è¦‹çš„ã€Œæ ¹æ“š ID æŸ¥è©³æƒ…ã€å ´æ™¯ï¼Œæä¾›äº†æœ€ç›´æ¥çš„æ•ˆèƒ½å¹«åŠ©ã€‚
- **å¯«å…¥å½±éŸ¿å°**ï¼šæ›´æ–°æˆ–åˆªé™¤æ“ä½œå°å¿«å–çš„å½±éŸ¿é™åˆ°æœ€ä½ï¼Œåªå‹•ä¸€å€‹éµï¼Œä¸æœƒå½±éŸ¿åˆ°å…¶ä»–æœ‰æ•ˆçš„å¿«å–è³‡æ–™ã€‚

---

## ğŸš€ å¯¦éš›æ“ä½œï¼šAPI æ¸¬è©¦ç¯„ä¾‹

ç•¶å°ˆæ¡ˆæˆåŠŸå•Ÿå‹•å¾Œï¼Œä½ å¯ä»¥ä½¿ç”¨ `curl` æˆ–ä»»ä½• API æ¸¬è©¦å·¥å…·ï¼ˆå¦‚ Postmanï¼‰ä¾†èˆ‡æ‡‰ç”¨ç¨‹å¼äº’å‹•ã€‚ä»¥ä¸‹æ˜¯å…©å€‹åŸºæœ¬çš„æ“ä½œç¯„ä¾‹ã€‚

### 1\. æ–°å¢ä¸€æœ¬æ›¸ (POST /books)

é€™å€‹æŒ‡ä»¤æœƒå‘ `/books` ç«¯é»ç™¼é€ä¸€å€‹ POST è«‹æ±‚ï¼Œæ–°å¢ä¸€æœ¬æ›¸çš„è³‡æ–™ã€‚

**æŒ‡ä»¤ï¼š**

```bash
curl --location 'http://localhost:8080/books' \
--header 'Content-Type: application/json' \
--data '{
    "title": "The Hobbit",
    "author": "J.R.R. Tolkien",
    "isbn": "9780345339686",
    "price": 15.99,
    "publishYear": 1937
}'
```

**é æœŸå›æ‡‰ï¼š**
å¦‚æœæˆåŠŸï¼Œä¼ºæœå™¨æœƒå›å‚³ `201 Created` ç‹€æ…‹ç¢¼ï¼Œä»¥åŠå‰›å‰›å»ºç«‹çš„æ›¸æœ¬è³‡æ–™ï¼ˆåŒ…å«ç”±è³‡æ–™åº«ç”¢ç”Ÿçš„ `id`ï¼‰ã€‚

```json
{
    "id": 1,
    "title": "The Hobbit",
    "author": "J.R.R. Tolkien",
    "isbn": "9780345339686",
    "price": 15.99,
    "publishYear": 1937
}
```

### 2\. æŸ¥è©¢ä¸€æœ¬æ›¸ (GET /books/{id})

é€™å€‹æŒ‡ä»¤æœƒå‘ `/books/1` ç«¯é»ç™¼é€ä¸€å€‹ GET è«‹æ±‚ï¼ŒæŸ¥è©¢ `id` ç‚º 1 çš„æ›¸æœ¬è³‡æ–™ã€‚

**æŒ‡ä»¤ï¼š**

```bash
curl --location 'http://localhost:8080/books/1'
```

**é æœŸå›æ‡‰ï¼š**
ä¼ºæœå™¨æœƒå›å‚³ `200 OK` ç‹€æ…‹ç¢¼ï¼Œä»¥åŠå°æ‡‰çš„æ›¸æœ¬è³‡æ–™ã€‚

```json
{
    "id": 1,
    "title": "The Hobbit",
    "author": "J.R.R. Tolkien",
    "isbn": "9780345339686",
    "price": 15.99,
    "publishYear": 1937
}
```

**è§€å¯Ÿå¿«å–æ•ˆæœï¼š**
ä½ å¯ä»¥å˜—è©¦é€£çºŒåŸ·è¡Œé€™å€‹æŸ¥è©¢æŒ‡ä»¤å…©æ¬¡ã€‚

- **ç¬¬ä¸€æ¬¡åŸ·è¡Œ**ï¼šåœ¨æ‡‰ç”¨ç¨‹å¼çš„æ—¥èªŒä¸­ï¼Œä½ æœƒçœ‹åˆ°ä¸€è¡Œé¡ä¼¼ `å¾è³‡æ–™åº«ç²å–æ›¸æœ¬ ID: 1` çš„è¨Šæ¯ï¼Œè¡¨ç¤ºé€™æ¬¡æŸ¥è©¢æœ‰å¯¦éš›è¨ªå•è³‡æ–™åº«ã€‚
- **ç¬¬äºŒæ¬¡åŸ·è¡Œ**ï¼šé€™è¡Œæ—¥èªŒå°‡ä¸æœƒå‡ºç¾ã€‚é€™æ˜¯å› ç‚ºæŸ¥è©¢çµæœå·²ç¶“è¢«å­˜åœ¨ Redis å¿«å–ä¸­ï¼Œæ‡‰ç”¨ç¨‹å¼ç›´æ¥å¾å¿«å–å›å‚³è³‡æ–™ï¼Œå¤§å¹…æå‡äº†å›æ‡‰é€Ÿåº¦ã€‚ä½ ä¹Ÿå¯ä»¥åœ¨ Grafana çš„ Tempo è¿½è¹¤è¦–åœ–ä¸­ï¼Œæ¸…æ¥šåœ°çœ‹åˆ°ç¬¬äºŒæ¬¡è«‹æ±‚çš„è¿½è¹¤éˆè®ŠçŸ­äº†ã€‚

--

## ğŸš€ æ•ˆèƒ½æå‡ï¼šJava 21 è™›æ“¬åŸ·è¡Œç·’

é€™å€‹å°ˆæ¡ˆå•Ÿç”¨äº†ä¸€å€‹ Java 21 çš„é‡é‡ç´šæ–°åŠŸèƒ½ï¼š**è™›æ“¬åŸ·è¡Œç·’ (Virtual Threads)**ã€‚

### å‚³çµ±åŸ·è¡Œç·’çš„å•é¡Œ

åœ¨å‚³çµ±çš„ Java æ‡‰ç”¨ä¸­ï¼Œæ¯ä¸€å€‹åŸ·è¡Œç·’ (Thread) éƒ½æœƒå°æ‡‰åˆ°ä¸€å€‹ä½œæ¥­ç³»çµ±çš„åŸ·è¡Œç·’ã€‚å°æ–¼ç¶²è·¯æœå‹™é€™ç¨®éœ€è¦å¤§é‡ç­‰å¾…ï¼ˆä¾‹å¦‚ç­‰å¾…è³‡æ–™åº«å›æ‡‰ã€ç­‰å¾…å¤–éƒ¨ API å›æ‡‰ï¼‰çš„æ‡‰ç”¨ä¾†èªªï¼Œé€™å¾ˆæµªè²»è³‡æºã€‚ç•¶ä¸€å€‹åŸ·è¡Œç·’åœ¨ç­‰å¾…æ™‚ï¼Œå®ƒé›–ç„¶æ²’åœ¨åšäº‹ï¼Œä½†ä»ç„¶ä½”è‘—ä¸€å€‹å¯¶è²´çš„ç³»çµ±åŸ·è¡Œç·’åé¡ï¼Œé€™é™åˆ¶äº†ç³»çµ±èƒ½åŒæ™‚è™•ç†çš„è«‹æ±‚æ•¸é‡ã€‚

### è™›æ“¬åŸ·è¡Œç·’çš„å„ªå‹¢

è™›æ“¬åŸ·è¡Œç·’æ˜¯ç”± JVM è‡ªå·±ç®¡ç†çš„è¶…è¼•é‡ç´šåŸ·è¡Œç·’ã€‚æˆåƒä¸Šè¬å€‹è™›æ“¬åŸ·è¡Œç·’ï¼Œå¯ä»¥è·‘åœ¨å°‘æ•¸å¹¾å€‹å‚³çµ±çš„ç³»çµ±åŸ·è¡Œç·’ä¸Šã€‚ç•¶ä¸€å€‹è™›æ“¬åŸ·è¡Œç·’éœ€è¦ç­‰å¾… I/O æ“ä½œæ™‚ï¼š

1. å®ƒä¸æœƒå¡ä½åº•å±¤çš„ç³»çµ±åŸ·è¡Œç·’ã€‚
2. JVM æœƒæŠŠå®ƒã€Œæš«åœã€ï¼Œç„¶å¾Œè®“é‚£å€‹ç³»çµ±åŸ·è¡Œç·’å»è·‘å¦ä¸€å€‹ä¸éœ€è¦ç­‰å¾…çš„è™›Tæ“¬åŸ·è¡Œç·’çš„ä»»å‹™ã€‚
3. ç­‰åˆ° I/O æ“ä½œå®Œæˆå¾Œï¼ŒJVM å†æŠŠåŸä¾†çš„è™›æ“¬åŸ·è¡Œç·’ã€Œå–šé†’ã€ï¼Œè®“å®ƒç¹¼çºŒå¾€ä¸‹åŸ·è¡Œã€‚

é€™å€‹æ©Ÿåˆ¶å¯ä»¥å¤§å¹…æå‡æ‡‰ç”¨çš„ååé‡ï¼Œè®“æˆ‘å€‘ç”¨æ›´å°‘çš„ç¡¬é«”è³‡æºï¼Œå°±èƒ½è™•ç†æ›´å¤šçš„åŒæ™‚è«‹æ±‚ã€‚

### å¦‚ä½•å•Ÿç”¨ï¼Ÿ

åœ¨ Spring Boot 3.2 ä»¥ä¸Šçš„ç‰ˆæœ¬ï¼Œå•Ÿç”¨è™›æ“¬åŸ·è¡Œç·’éå¸¸ç°¡å–®ï¼Œåªéœ€è¦åœ¨ `application.yml` åŠ ä¸Šä¸€è¡Œè¨­å®šï¼š

```yaml
spring:
  threads:
    virtual:
      enabled: true
```

é€™è¡Œè¨­å®šæœƒå‘Šè¨´ Spring Bootï¼Œç”¨è™›æ“¬åŸ·è¡Œç·’ä¾†è™•ç†æ‰€æœ‰é€²ä¾†çš„ HTTP è«‹æ±‚ã€‚

---

## ğŸ”¬ ç¾ä»£åŒ–å¯è§€æ¸¬æ€§ (Observability) - ç¬¬ä¸€éƒ¨åˆ†ï¼šSpring çš„å¯¦è¸

ã€Œå¯è§€æ¸¬æ€§ã€æ˜¯ç‚ºäº†è§£æ±ºä¸€å€‹æ ¸å¿ƒå•é¡Œï¼šç•¶æˆ‘å€‘çš„ç¨‹å¼ä¸Šç·šé‹è¡Œå¾Œï¼Œè¦å¦‚ä½•æ‰èƒ½çŸ¥é“å®ƒå…§éƒ¨åˆ°åº•ç™¼ç”Ÿäº†ä»€éº¼äº‹ï¼Ÿé€™æ¨£æˆ‘å€‘æ‰èƒ½å¿«é€Ÿæ‰¾åˆ°å•é¡Œã€å„ªåŒ–æ•ˆèƒ½ã€‚é€™å¥—ç³»çµ±é€šå¸¸å»ºç«‹åœ¨ä¸‰å¤§æ”¯æŸ±ä¸Šï¼š**æŒ‡æ¨™ (Metrics)**ã€**è¿½è¹¤ (Traces)** å’Œ **æ—¥èªŒ (Logs)**ã€‚

- **æ—¥èªŒ (Logs)**ï¼šè¨˜éŒ„äº†ç³»çµ±ä¸­ç™¼ç”Ÿçš„ä¸€å€‹å€‹ç¨ç«‹äº‹ä»¶ã€‚å®ƒå›ç­”çš„æ˜¯ã€Œ**ç™¼ç”Ÿäº†ä»€éº¼ï¼Ÿ**ã€é€™å€‹å•é¡Œã€‚
- **æŒ‡æ¨™ (Metrics)**ï¼šæ˜¯åœ¨ä¸€æ®µæ™‚é–“å…§ï¼Œå°æ•¸æ“šé€²è¡Œçµ±è¨ˆèšåˆçš„æ•¸å€¼ã€‚å®ƒå›ç­”çš„æ˜¯ã€Œ**ç³»çµ±è¡¨ç¾å¦‚ä½•ï¼Ÿ**ã€é€™å€‹å•é¡Œï¼Œä¾‹å¦‚æ¯ç§’è«‹æ±‚æ•¸ã€éŒ¯èª¤ç‡ã€åæ‡‰æ™‚é–“ç­‰ã€‚
- **è¿½è¹¤ (Traces)**ï¼šæç¹ªäº†ä¸€å€‹è«‹æ±‚ï¼Œå¾é€²å…¥ç³»çµ±é–‹å§‹ï¼Œåˆ°ç¶“éå„å€‹ä¸åŒæœå‹™ï¼Œæœ€å¾Œå›å‚³çµæœçš„å®Œæ•´æ—…ç¨‹ã€‚å®ƒå›ç­”çš„æ˜¯ã€Œ**è«‹æ±‚å»äº†å“ªè£¡ï¼Ÿ**ã€ä»¥åŠã€Œ**ç‚ºä»€éº¼é€™éº¼æ…¢ï¼Ÿ**ã€é€™é¡å•é¡Œã€‚

### Spring çš„ç¾ä»£è§€æ¸¬å“²å­¸

åœ¨å¯«ä»»ä½•ç›£æ§ç¨‹å¼ç¢¼ä¹‹å‰ï¼Œæˆ‘å€‘éœ€è¦å…ˆç†è§£ Spring Boot 3 çš„è§€æ¸¬å“²å­¸ã€‚Micrometer çš„æ ¸å¿ƒé–‹ç™¼è€… Jonatan Ivanov èªªéï¼š

> â€œIn these apps I don't create any Observations manually because basically everything that I would need is automatically instrumentedâ€¦"  
> "åœ¨é€™äº›æ‡‰ç”¨ç¨‹å¼ä¸­ï¼Œæˆ‘æ²’æœ‰æ‰‹å‹•å»ºç«‹ä»»ä½•è§€æ¸¬ï¼Œå› ç‚ºæˆ‘æ‰€éœ€è¦çš„åŸºæœ¬ä¸Šéƒ½å·²ç¶“è¢«æˆ‘ä½¿ç”¨çš„æ¡†æ¶/å‡½å¼åº«è‡ªå‹•æª¢æ¸¬äº†â€¦"  

é€™å¥è©±æ­ç¤ºäº†ä¸€å€‹æ ¸å¿ƒæ€æƒ³ï¼š**å„ªå…ˆä¾è³´è‡ªå‹•åŒ–æª¢æ¸¬ (Rely on Automatic Instrumentation First)**ã€‚

ç•¶æˆ‘å€‘åœ¨å°ˆæ¡ˆä¸­åŠ å…¥ `spring-boot-starter-actuator` ç­‰ç›¸é—œå¥—ä»¶æ™‚ï¼ŒSpring Boot ç”Ÿæ…‹ç³»å·²ç¶“è‡ªå‹•å¹«æˆ‘å€‘ç›£æ§äº†å¤§é‡å¸¸è¦‹çš„æ“ä½œï¼ŒåŒ…æ‹¬ï¼š

- æ”¶åˆ°çš„ HTTP è«‹æ±‚
- ç™¼å‡ºçš„ RestTemplate è«‹æ±‚
- è³‡æ–™åº« JDBC æŸ¥è©¢
- Redis æ“ä½œ
- â€¦ç­‰ç­‰

é€™ä»£è¡¨æˆ‘å€‘ä»€éº¼éƒ½ä¸ç”¨åšï¼Œå°±èƒ½åœ¨ç›£æ§å¾Œå°çœ‹åˆ°é€™äº›åŸºç¤è¨­æ–½å±¤é¢çš„æŒ‡æ¨™å’Œè¿½è¹¤ã€‚

é‚£éº¼ï¼Œæˆ‘å€‘ä»€éº¼æ™‚å€™æ‰éœ€è¦è‡ªå·±å‹•æ‰‹ï¼Ÿ
**ç­”æ¡ˆæ˜¯ï¼šç•¶è‡ªå‹•åŒ–æª¢æ¸¬ç„¡æ³•è§¸åŠï¼Œè€Œæˆ‘å€‘åˆæƒ³æ·±å…¥è§€å¯Ÿçš„ã€Œè‡ªè¨‚æ ¸å¿ƒæ¥­å‹™é‚è¼¯ã€æ™‚ã€‚**

ä¾‹å¦‚ï¼Œåœ¨æˆ‘å€‘çš„ `BookService` ä¸­ï¼Œ`createBook` é€™å€‹æ–¹æ³•åŒ…å«äº†ã€Œæª¢æŸ¥ ISBNã€è¨­å®šæ™‚é–“æˆ³ã€å„²å­˜åˆ°è³‡æ–™åº«ã€ç­‰å¤šå€‹æ­¥é©Ÿã€‚æˆ‘å€‘å¸Œæœ›æŠŠæ•´å€‹ `createBook` æ“ä½œï¼Œçœ‹ä½œä¸€å€‹æœ‰å•†æ¥­æ„ç¾©çš„ç¨ç«‹å–®å…ƒä¾†é€²è¡Œç›£æ§ã€‚é€™å°±æ˜¯ `@Observed` è¨»è§£ç™¼æ®ä½œç”¨çš„åœ°æ–¹ã€‚

### `@Observed`: è§€æ¸¬æ ¸å¿ƒæ¥­å‹™é‚è¼¯çš„åˆ©å™¨

Micrometer æ˜¯ Spring å®˜æ–¹æŒ‡å®šçš„è§€æ¸¬é–€é¢ï¼Œå®ƒæä¾›äº†ä¸€å¥—æ¨™æº– APIï¼Œè®“æˆ‘å€‘çš„ç¨‹å¼ç¢¼å¯ä»¥å°ˆæ³¨åœ¨ã€Œæƒ³è¦è§€æ¸¬ä»€éº¼ã€ï¼Œè€Œä¸ç”¨å»ç®¡åº•å±¤çš„æŠ€è¡“ç´°ç¯€ã€‚

`@Observed` è¨»è§£ï¼Œæ­£æ˜¯ç”¨ä¾†å¹«æˆ‘å€‘çš„è‡ªè¨‚æ¥­å‹™é‚è¼¯åŠ ä¸Šè§€æ¸¬èƒ½åŠ›çš„æœ€ä½³å¯¦è¸ã€‚å¦‚åŒ Jonatan Ivanov æ‰€èªªï¼š

> "The idea... was that we want the users to instrument their code once using a single API and have multiple benefits out of it (e.g. metrics, tracing, logging)."
> "æˆ‘å€‘çš„åˆè¡·æ˜¯ï¼Œå¸Œæœ›ä½¿ç”¨è€…èƒ½ç”¨ä¸€å¥— API ä¾†æª¢æ¸¬ä»–å€‘çš„ç¨‹å¼ç¢¼ä¸€æ¬¡ï¼Œä¸¦å¾ä¸­ç²å¾—å¤šé‡æ•ˆç›Šï¼Œä¾‹å¦‚ï¼šæŒ‡æ¨™ã€è¿½è¹¤ã€æ—¥èªŒã€‚"

é€™å°±æ˜¯ `@Observed` çš„æ ¸å¿ƒç†å¿µï¼š**ã€Œä¸€æ¬¡æª¢æ¸¬ï¼Œå¤šé‡æ•ˆç›Šã€**ã€‚

#### ç‚ºä½•ä¸ç›´æ¥ç”¨ SDK æˆ– Java Agentï¼Ÿ

- **ç›¸è¼ƒæ–¼ç›´æ¥ç”¨ OpenTelemetry SDK**ï¼šå¦‚æœç›´æ¥ç”¨ SDKï¼Œä½ éœ€è¦æ‰‹å‹•å¯«å¾ˆå¤šç¨‹å¼ç¢¼ä¾†é–‹å§‹/çµæŸä¸€å€‹è¿½è¹¤ã€è¨­å®šå±¬æ€§ç­‰ç­‰ï¼Œå¾ˆç¹ç‘£ä¹Ÿå®¹æ˜“å‡ºéŒ¯ã€‚`@Observed` ç”¨ä¸€å€‹ç°¡å–®çš„è¨»è§£å°±å¹«ä½ æå®šäº†é€™ä¸€åˆ‡ã€‚
- **ç›¸è¼ƒæ–¼ä½¿ç”¨ OpenTelemetry Java Agent**ï¼šAgent å°æ–¼è‡ªå‹•ç›£æ§å·²çŸ¥çš„ç¬¬ä¸‰æ–¹å¥—ä»¶ï¼ˆåƒè³‡æ–™åº«é©…å‹•ï¼‰å¾ˆæœ‰æ•ˆï¼Œä½†å®ƒçœ‹ä¸æ‡‚ä½ è‡ªå·±å¯«çš„æ¥­å‹™æ–¹æ³•ï¼ˆä¾‹å¦‚ `createBook`ï¼‰ä»£è¡¨ä»€éº¼å•†æ¥­æ„ç¾©ã€‚`@Observed` è®“ä½ å¯ä»¥ç‚ºé€™å€‹æ“ä½œå–ä¸€å€‹æœ‰æ„ç¾©çš„åå­—ï¼Œè®“ç›£æ§åœ–è¡¨æ›´å®¹æ˜“ç†è§£ã€‚

`@Observed` è¨»è§£åœ¨ã€Œç°¡å–®æ–¹ä¾¿ã€å’Œã€ŒåŠŸèƒ½å¼·å¤§ã€ä¹‹é–“å–å¾—äº†ä¸€å€‹å¾ˆå¥½çš„å¹³è¡¡ã€‚å®ƒæ¯”ç›´æ¥ç”¨ SDK ç°¡æ½”ï¼Œåˆæ¯” Java Agent åœ¨ç›£æ§è‡ªè¨‚æ¥­å‹™é‚è¼¯æ™‚æ›´æœ‰å½ˆæ€§ã€‚

### `@Observed` å•Ÿç”¨èˆ‡å¯¦è¸æŒ‡å—

åœ¨ Spring Boot 3 ä¸­ï¼Œå•Ÿç”¨ `@Observed` çš„è¨­å®šå·²ç¶“éå¸¸ç°¡å–®ã€‚

#### æ­¥é©Ÿ 1ï¼šåŠ å…¥æ ¸å¿ƒä¾è³´

åœ¨ `build.gradle` æª”æ¡ˆä¸­ï¼Œç¢ºä¿æœ‰é€™å…©å€‹é—œéµä¾è³´ï¼š

```groovy
// build.gradle
dependencies {
    // æä¾› Micrometer è§€æ¸¬åŠŸèƒ½çš„åŸºç¤ï¼Œæ˜¯æ‰€æœ‰è§€æ¸¬åŠŸèƒ½çš„åŸºçŸ³
    implementation 'org.springframework.boot:spring-boot-starter-actuator'

    // æä¾› AOP (é¢å‘åˆ‡é¢ç·¨ç¨‹) çš„èƒ½åŠ›ï¼Œé€™æ˜¯ @Observed èƒ½é‹ä½œçš„æŠ€è¡“åŸºç¤
    implementation 'org.springframework.boot:spring-boot-starter-aop'
}
```

#### æ­¥é©Ÿ 2ï¼šé–‹å•Ÿå…¨åŸŸé–‹é—œ

åœ¨ `application.yml` ä¸­ï¼Œæ‰“é–‹åŸºæ–¼è¨»è§£çš„è§€æ¸¬åŠŸèƒ½ï¼š

```yaml
# src/main/resources/application.yml
management:
  observations:
    annotations:
      enabled: true  # @Observed åŠŸèƒ½çš„ç¸½é–‹é—œ
```

#### æ­¥é©Ÿ 3ï¼šè¨­å®šéåŒæ­¥è¿½è¹¤ (å¦‚æœä½ çš„å°ˆæ¡ˆæœ‰ç”¨åˆ°)

Spring Boot 3.2 ä¹‹å¾Œï¼Œ`@Observed` æ‰€éœ€çš„æ ¸å¿ƒå…ƒä»¶ `ObservedAspect` å·²ç¶“æœƒè¢«è‡ªå‹•è¨­å®šäº†ï¼Œä½ ä¸éœ€è¦æ‰‹å‹•å»å®£å‘Šå®ƒã€‚

ç¾åœ¨ï¼Œåªæœ‰ç•¶ä½ çš„å°ˆæ¡ˆä¸­ä½¿ç”¨äº† `@Async` é€™ç¨®éåŒæ­¥æ“ä½œæ™‚ï¼Œç‚ºäº†ç¢ºä¿è¿½è¹¤è³‡è¨Šï¼ˆä¾‹å¦‚ `traceId`ï¼‰èƒ½å¤ åœ¨ä¸åŒåŸ·è¡Œç·’ä¹‹é–“æ­£ç¢ºå‚³éï¼Œä½ æ‰éœ€è¦å»ºç«‹ä¸‹é¢çš„è¨­å®šæª”ï¼š

```java
// src/main/java/com/example/demo/config/ObservabilityConfig.java
@Configuration(proxyBeanMethods = false)
public class ObservabilityConfig {

    /**
     * ç‚ºäº†è®“è¿½è¹¤è³‡è¨Šèƒ½åœ¨ @Async çš„éåŒæ­¥åŸ·è¡Œç·’ä¸­ä¹Ÿèƒ½æ­£ç¢ºå‚³éï¼Œ
     * æˆ‘å€‘éœ€è¦é…ç½®ä¸€å€‹ TaskExecutorã€‚
     * ContextPropagatingTaskDecorator æœƒè‡ªå‹•å°‡ç•¶å‰åŸ·è¡Œç·’çš„è¿½è¹¤ä¸Šä¸‹æ–‡(å¦‚ traceId)ï¼Œ
     * è¤‡è£½åˆ°å³å°‡åŸ·è¡Œ @Async ä»»å‹™çš„æ–°åŸ·è¡Œç·’ä¸­ï¼Œç¢ºä¿è¿½è¹¤éˆçš„å®Œæ•´æ€§ã€‚
     */
    @Bean
    public TaskExecutor taskExecutor() {
        ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor();
        executor.setTaskDecorator(new ContextPropagatingTaskDecorator());
        return executor;
    }
}
```

**æ³¨æ„**ï¼šå¦‚æœä½ çš„å°ˆæ¡ˆè£¡å®Œå…¨æ²’æœ‰ç”¨åˆ° `@Async`ï¼Œé‚£ä½ ç”šè‡³å¯ä»¥ä¸ç”¨å»ºç«‹ `ObservabilityConfig.java` é€™å€‹æª”æ¡ˆã€‚

#### æ­¥é©Ÿ 4ï¼šåœ¨æ¥­å‹™é‚è¼¯ä¸­æ‡‰ç”¨è¨»è§£

åœ¨ `BookService` ä¸­ï¼Œæˆ‘å€‘ä½¿ç”¨äº† `@Observed` çš„é€²éšåŠŸèƒ½ï¼Œç‚ºç›£æ§åŠ ä¸Šäº†æ›´æœ‰æ„ç¾©çš„æ¥­å‹™åç¨±å’Œè‡ªè¨‚æ¨™ç±¤ã€‚

```java
// src/main/java/com/example/demo/applications/BookService.java
@Service
public class BookService {

    @Cacheable(cacheNames = CacheConfig.BOOKS_CACHE, key = "'book_' + #id")
    @Observed(
        name = "book.details.view",
        contextualName = "æ›¸æœ¬è©³æƒ…æŸ¥çœ‹",
        lowCardinalityKeyValues = {
            "operation", "get_by_id",
            "cache_enabled", "true"
        }
    )
    public Book getBookById(Integer id) {
        //... æ¥­å‹™é‚è¼¯...
    }

    @Transactional
    @CacheEvict(cacheNames = CacheConfig.BOOKS_CACHE, key = "'book_' + #id")
    @Observed(
        name = "book.inventory.update",
        contextualName = "æ›¸æœ¬è³‡è¨Šæ›´æ–°",
        lowCardinalityKeyValues = {
            "operation", "update",
            "cache_evict", "single",
            "business_impact", "medium"
        }
    )
    public Book updateBook(Integer id, Book book) {
        //... æ¥­å‹™é‚è¼¯...
    }
}
```

`@Observed` è¨»è§£è£¡çš„åƒæ•¸èªªæ˜ï¼š

- **`name`**: æŒ‡æ¨™çš„åç¨± (`book.details.view`)ã€‚æˆ‘å€‘æ¡ç”¨ã€Œé ˜åŸŸ.å­åŸŸ.å‹•ä½œã€çš„å‘½åé¢¨æ ¼ï¼Œé€™åœ¨ç›£æ§ç³»çµ±ä¸­æ›´å®¹æ˜“åˆ†é¡å’Œç¯©é¸ã€‚
- **`contextualName`**: è¿½è¹¤ Span çš„åç¨± (`æ›¸æœ¬è©³æƒ…æŸ¥çœ‹`)ã€‚æˆ‘å€‘ç›´æ¥ç”¨ä¸­æ–‡æ¥­å‹™è¡“èªï¼Œé€™æ¨£å°±ç®—ä¸æ˜¯å·¥ç¨‹å¸«ï¼Œä¹Ÿèƒ½çœ‹æ‡‚è¿½è¹¤åœ–è¡¨ä¸Šæ¯å€‹æ­¥é©Ÿçš„æ„ç¾©ã€‚
- **`lowCardinalityKeyValues`**: é€™å€‹åŠŸèƒ½éå¸¸å¯¦ç”¨ã€‚å®ƒè®“æˆ‘å€‘å¯ä»¥ç‚ºæŒ‡æ¨™å’Œè¿½è¹¤åŠ ä¸Šè‡ªè¨‚çš„ Key-Value æ¨™ç±¤ (Tags)ã€‚
  - **ä»€éº¼æ˜¯ä½åŸºæ•¸ (Low Cardinality)ï¼Ÿ** ã€ŒåŸºæ•¸ã€æŒ‡çš„æ˜¯ä¸€å€‹æ¨™ç±¤å¯èƒ½å‡ºç¾çš„ä¸åŒå€¼çš„æ•¸é‡ã€‚ã€Œä½åŸºæ•¸ã€ä»£è¡¨å€¼çš„ç¨®é¡æ˜¯æœ‰é™ä¸”å¯é æ¸¬çš„ï¼ˆä¾‹å¦‚ `operation` çš„å€¼åªå¯èƒ½æ˜¯ `create`, `update`, `delete` é€™å¹¾ç¨®ï¼‰ã€‚æˆ‘å€‘æ‡‰è©²åªæŠŠä½åŸºæ•¸çš„æ¨™ç±¤æ”¾åœ¨é€™è£¡ã€‚
  - **åƒè¬ä¸è¦**æŠŠé«˜åŸºæ•¸çš„å€¼ï¼ˆåƒæ˜¯ `book_id`, `user_id`ï¼‰æ”¾åœ¨é€™è£¡ï¼Œé€™æœƒå°è‡´ç›£æ§ç³»çµ±çš„ç´¢å¼•åº«çˆ†ç‚¸ï¼Œç”¢ç”Ÿæ•ˆèƒ½å•é¡Œã€‚
  - **å¦‚ä½•ä½¿ç”¨**ï¼šç”¨ `{ "key1", "value1", "key2", "value2" }` çš„æ ¼å¼æä¾›ã€‚

### é€²éšè¿½è¹¤ï¼šä½¿ç”¨ Baggage æ³¨å…¥é«˜åŸºæ•¸æ¥­å‹™å…§æ–‡ (é¸ç”¨)

æˆ‘å€‘å‰›å‰›æåˆ°ï¼Œ`lowCardinalityKeyValues` **ä¸æ‡‰è©²**è¢«ç”¨ä¾†å­˜æ”¾åƒ `book_id` æˆ– `user_id` é€™é¡é«˜åŸºæ•¸çš„è³‡æ–™ã€‚é‚£éº¼å•é¡Œä¾†äº†ï¼šå¦‚æœæˆ‘ä»Šå¤©å°±æ˜¯è¦è¿½è¹¤ä¸€å€‹ç‰¹å®š `book_id` çš„å®Œæ•´è«‹æ±‚éˆè·¯ï¼Œè©²æ€éº¼åšå‘¢ï¼Ÿ

ç­”æ¡ˆæ˜¯ä½¿ç”¨ **Baggage**ã€‚

Baggage æ˜¯ OpenTelemetry ä¸­ä¸€å€‹å¼·å¤§çš„æ¦‚å¿µï¼Œæ‚¨å¯ä»¥æŠŠå®ƒæƒ³åƒæˆä¸€å€‹è·Ÿéš¨è«‹æ±‚åœ¨ç³»çµ±ä¸­æ—…è¡Œçš„ã€Œéš¨èº«è¡Œæç®±ã€ã€‚æ‚¨å¯ä»¥åœ¨è«‹æ±‚çš„å…¥å£é»ï¼ˆä¾‹å¦‚ Controllerï¼‰å°‡ä¸€å€‹æ¥­å‹™ ID (å¦‚ `book-id: 123`) æ”¾å…¥é€™å€‹è¡Œæç®±ï¼Œä¹‹å¾Œé€™å€‹ ID å°±æœƒè‡ªå‹•åœ°åœ¨æ•´å€‹å‘¼å«éˆä¸­å‚³éï¼Œç”šè‡³å¯ä»¥è·¨è¶Šå¤šå€‹å¾®æœå‹™ã€‚

é€™æ˜¯ä¸€å€‹é¸ç”¨ä½†æ¥µç‚ºæœ‰ç”¨çš„æŠ€å·§ï¼Œèƒ½è®“é™¤éŒ¯å’Œå•é¡Œæ’æŸ¥çš„æ•ˆç‡æå‡ä¸€å€‹é‡ç´šã€‚

#### æ­¥é©Ÿ 1ï¼šåœ¨ `application.yml` ä¸­è¨­å®š Baggage æ¬„ä½

é¦–å…ˆï¼Œæˆ‘å€‘éœ€è¦æ˜ç¢ºå‘Šè¨´ Micrometer Tracingï¼Œæˆ‘å€‘æƒ³è¦è¿½è¹¤å“ªäº› Baggage æ¬„ä½ã€‚

```yaml
# src/main/resources/application.yml
management:
  tracing:
    baggage:
      enabled: true # ç¢ºä¿ Baggage åŠŸèƒ½å·²å•Ÿç”¨
      remote-fields:
        - book-id # 1. é ç«¯å‚³æ’­ï¼šè®“ 'book-id' å¯ä»¥é€é HTTP headers åœ¨å¾®æœå‹™é–“å‚³éã€‚
      tag-fields:
        - book-id # 2. è‡ªå‹•æ¨™ç±¤ï¼šè®“ Micrometer è‡ªå‹•å°‡é€™å€‹ Baggage çš„å€¼ï¼Œä½œç‚ºä¸€å€‹ Tag åŠ åˆ°æ‰€æœ‰å¾ŒçºŒçš„ Span ä¸Šã€‚é€™æ˜¯èƒ½åœ¨ Grafana çœ‹åˆ°å®ƒçš„é—œéµã€‚
      correlation:
        enabled: true # 3. æ—¥èªŒé—œè¯
        fields:
          - book-id # 4. å°‡ 'book-id' çš„å€¼ä¹Ÿæ”¾é€²æ—¥èªŒçš„ MDC ä¸­ï¼Œæ–¹ä¾¿åœ¨æ—¥èªŒè£¡ç›´æ¥çœ‹åˆ°å’Œæœå°‹ã€‚
```

#### æ­¥é©Ÿ 2ï¼šåœ¨ Controller ä¸­è¨­å®š Baggage çš„å€¼

è¨­å®šå¥½ä¹‹å¾Œï¼Œæˆ‘å€‘éœ€è¦åœ¨ç¨‹å¼çš„å…¥å£é»ï¼Œä¹Ÿå°±æ˜¯ `BookController` ä¸­ï¼Œæ³¨å…¥ `Tracer` ä¸¦å°‡å‚³å…¥çš„ `id` æ”¾å…¥ Baggageã€‚

```java
// src/main/java/com/example/demo/interfaces/rest/BookController.java

// ... å…¶ä»– import ...
import io.micrometer.tracing.Baggage;
import io.micrometer.tracing.Tracer;

@RestController
@RequiredArgsConstructor
public class BookController implements BooksApi {

    private final BookService bookService;
    private final BookMapper bookMapper;
    private final Tracer tracer; // Spring Boot æœƒè‡ªå‹•é…ç½®å¥½ Tracer

    // ... å…¶ä»– API æ–¹æ³• ...

    @Override
    public ResponseEntity<BookDto> booksIdGet(Integer id) throws Exception {
        log.info("ç²å–æ›¸æœ¬ï¼ŒID: {}", id);
        // åœ¨è™•ç†è«‹æ±‚çš„é–‹é ­ï¼Œå°‡ ID æ”¾å…¥ Baggage
        this.setBookIdInBaggage(id);
        Book book = bookService.getBookById(id);
        return ResponseEntity.ok(bookMapper.toDto(book));
    }

    // ... å…¶ä»–éœ€è¦ ID çš„æ–¹æ³•ä¹ŸåšåŒæ¨£çš„è™•ç† ...

    /**
     * å°‡æ›¸æœ¬ ID è¨­å®šåˆ°åˆ†æ•£å¼è¿½è¹¤çš„ Baggage ä¸­ã€‚
     * @param bookId è¦è¨­å®šçš„æ›¸æœ¬ ID
     */
    private void setBookIdInBaggage(Integer bookId) {
        if (bookId == null) {
            return;
        }
        try {
            // æ ¹æ“š application.yml ä¸­è¨­å®šçš„åç¨± "book-id" ç²å– BaggageField çš„å¥æŸ„
            Baggage baggage = tracer.getBaggage("book-id");
            if (baggage!= null) {
                // è¨­å®š Baggage çš„å€¼ï¼Œé€™å€‹å€¼å°‡åœ¨ç•¶å‰çš„è¿½è¹¤ä¸Šä¸‹æ–‡ä¸­ç”Ÿæ•ˆ
                baggage.makeCurrent(bookId.toString());
                log.info("Baggage 'book-id' å·²è¨­å®šç‚º: {}", baggage.get());
            } else {
                log.warn("Baggage æ¬„ä½ 'book-id' æœªè¨­å®šæˆ–æœªå•Ÿç”¨ã€‚");
            }
        } catch (Exception e) {
            log.error("è¨­å®š book-id åˆ° Baggage æ™‚ç™¼ç”ŸéŒ¯èª¤", e);
        }
    }
}
```

#### æ­¥é©Ÿ 3ï¼šåœ¨ Grafana Tempo ä¸­é©—è­‰çµæœ

å®Œæˆè¨­å®šä¸¦ç™¼é€ä¸€å€‹è«‹æ±‚å¾Œï¼ˆä¾‹å¦‚ `GET /books/2`ï¼‰ï¼Œæˆ‘å€‘å°±å¯ä»¥åœ¨ Grafana Tempo ä¸­çœ‹åˆ°é©šäººçš„æ•ˆæœã€‚åœ¨è¿½è¹¤çš„ç€‘å¸ƒåœ–ä¸­ï¼Œé»é–‹ä»»ä½•ä¸€å€‹ Spanï¼Œæ‚¨æœƒåœ¨ä¸‹æ–¹çš„ `Span Attributes` å€å¡Šä¸­ï¼Œæ¸…æ¥šåœ°çœ‹åˆ°æˆ‘å€‘å‰›å‰›è¨­å®šçš„ `book-id` æ¨™ç±¤ã€‚

![image](https://raw.githubusercontent.com/samzhu/demo-springboot-250613/refs/heads/main/dev-resources/images/tempo_query3.jpg)

æœ‰äº†é€™å€‹åŠŸèƒ½ï¼Œç•¶å®¢æœå›å ±ã€ŒID ç‚º 2 çš„æ›¸æœ¬é é¢è¼‰å…¥å¾ˆæ…¢ã€æ™‚ï¼Œç¶­é‹äººå“¡ä¸å†éœ€è¦å¤§æµ·æ’ˆé‡ã€‚ä»–å€‘å¯ä»¥ç›´æ¥åœ¨ Tempo ä¸­ä½¿ç”¨é¡ä¼¼ `{ resource.service.name="demo", book-id="2" }` çš„æŸ¥è©¢ï¼Œç«‹åˆ»å°±èƒ½ç¯©é¸å‡ºæ‰€æœ‰èˆ‡é€™æœ¬æ›¸ç›¸é—œçš„è«‹æ±‚éˆè·¯ï¼Œå¾è€Œç²¾æº–åœ°å®šä½å•é¡Œæ ¹æºã€‚

### å¾æŠ€è¡“ç›£æ§åˆ°æ¥­å‹™æ´å¯Ÿ

é€éé€™ç¨®å¸¶æœ‰æ¥­å‹™èªç¾©çš„ç›£æ§æ–¹å¼ï¼Œæˆ‘å€‘çš„ç›£æ§æ•¸æ“šå°‡ä¸å†åªæ˜¯å†·å†°å†°çš„æŠ€è¡“æŒ‡æ¨™ï¼Œè€Œæ˜¯èƒ½æä¾›æœ‰åƒ¹å€¼çš„å•†æ¥­æ´å¯Ÿã€‚

ä¾‹å¦‚ï¼Œæˆ‘å€‘ç¾åœ¨å¯ä»¥ç›´æ¥åœ¨ Grafana é€™æ¨£çš„ç›£æ§ç³»çµ±ä¸­ï¼Œå›ç­”ä¸‹é¢é€™äº›å•é¡Œï¼š

- **åˆ†æé¡§å®¢è¡Œç‚º**:
      - `getAllBooks` è¢«æ¨™è¨˜ç‚º `book.catalog.browse`ï¼Œæˆ‘å€‘å¯ä»¥çµ±è¨ˆã€Œé¡§å®¢ç€è¦½å•†å“ç›®éŒ„çš„é »ç‡æœ‰å¤šé«˜ï¼Ÿã€
      - `getBookById` è¢«æ¨™è¨˜ç‚º `book.details.view`ï¼Œæˆ‘å€‘å¯ä»¥åˆ†æã€Œé¡§å®¢å¹³å‡æœƒé»é–‹å¹¾æœ¬æ›¸çš„è©³æƒ…é ï¼Ÿã€
- **è©•ä¼°åº«å­˜ç®¡ç†æ•ˆç‡**:
      - é€éç¯©é¸ `operation` æ¨™ç±¤ (`create`, `update`, `remove`)ï¼Œæˆ‘å€‘å¯ä»¥å»ºç«‹å„€è¡¨æ¿ï¼Œåˆ†åˆ¥é¡¯ç¤ºã€Œæ¯æ—¥æ–°æ›¸ä¸Šæ¶æ•¸é‡ã€ã€ã€Œè³‡è¨Šæ›´æ–°é »æ¬¡ã€å’Œã€Œå•†å“ä¸‹æ¶æ•¸é‡ã€ã€‚
- **é‡åŒ–æ¥­å‹™å½±éŸ¿åŠ›**:
      - æˆ‘å€‘ç‚ºä¸åŒæ“ä½œå®šç¾©äº† `business_impact` æ¨™ç±¤ï¼ˆå¦‚ `high`, `medium`ï¼‰ã€‚ç¾åœ¨å¯ä»¥è¨­å®šæ›´è°æ˜çš„è­¦å ±ï¼Œä¾‹å¦‚ï¼šã€Œåªæœ‰ç•¶ `business_impact` ç‚º `high` çš„æ“ä½œï¼ˆå¦‚ä¸‹æ¶å•†å“ï¼‰éŒ¯èª¤ç‡è¶…é 1% æ™‚ï¼Œæ‰ç™¼é€ç·Šæ€¥è­¦å ±ã€ï¼Œè®“åœ˜éšŠèƒ½å°ˆæ³¨æ–¼çœŸæ­£é‡è¦çš„å•é¡Œã€‚

ç¸½ä¹‹ï¼Œ`@Observed` çš„é€™ç¨®ç”¨æ³•ï¼Œèƒ½è®“ç›£æ§æ•¸æ“šå°æ•´å€‹åœ˜éšŠï¼ˆåŒ…æ‹¬ç”¢å“ã€ç‡Ÿé‹å’Œç®¡ç†å±¤ï¼‰éƒ½ç”¢ç”Ÿåƒ¹å€¼ã€‚

---

## ğŸ”¬ ç¾ä»£åŒ–å¯è§€æ¸¬æ€§ (Observability) - ç¬¬äºŒéƒ¨åˆ†ï¼šèˆ‡ OpenTelemetry çš„å”åŒé‹ä½œ

æˆ‘å€‘å·²ç¶“å­¸æœƒç”¨ `@Observed` ç‚ºæ¥­å‹™é‚è¼¯åŠ ä¸Šè§€æ¸¬èƒ½åŠ›ã€‚ç¾åœ¨ï¼Œæˆ‘å€‘ä¾†æ­é–‹ç¥ç§˜çš„é¢ç´—ï¼Œçœ‹çœ‹èƒŒå¾Œé€™äº›æŠ€è¡“å¥—ä»¶æ˜¯å¦‚ä½•åˆ†å·¥åˆä½œï¼Œæœ€çµ‚å°‡ç›£æ§æ•¸æ“šè®Šæˆ OpenTelemetry æ ¼å¼ä¸¦å‚³é€å‡ºå»çš„ã€‚

### æ•´é«”æ¶æ§‹åœ–

```mermaid
graph TD
    subgraph "åŸ·è¡Œç’°å¢ƒ"
        User[ğŸ‘¨â€ğŸ’» ä½¿ç”¨è€…]
        App
        DB
        Cache
    end

    subgraph "otel-lgtm å…§éƒ¨"
        Developer[ğŸ‘¨â€ğŸ’» é–‹ç™¼è€…]
        Grafana[ğŸ“Š Grafana]
        Tempo
        Mimir[ğŸ“‰ Mimir - Metrics]
        Loki[ğŸ“œ Loki - Logs]
        Collector
    end

    User -->|HTTP API è«‹æ±‚| App
    App -->|JDBC| DB
    App -->|Redis Commands| Cache
    App -->|OTLP - gRPC/HTTP| Collector
    Collector --> Tempo
    Collector --> Mimir
    Collector --> Loki
    Grafana -->|æŸ¥è©¢| Tempo
    Grafana -->|æŸ¥è©¢| Mimir
    Grafana -->|æŸ¥è©¢| Loki
    Developer -->|ç€è¦½| Grafana
```

### åˆ†å±¤æ¶æ§‹ï¼šè§£è€¦èˆ‡å”ä½œ

è¦ç†è§£é€™äº›å¥—ä»¶çš„é—œä¿‚ï¼Œé—œéµåœ¨æ–¼æŒæ¡ Spring Boot 3 çš„è§€æ¸¬æ€§åˆ†å±¤æ¶æ§‹ï¼š

1. **æª¢æ¸¬å±¤ (Instrumentation API)**ï¼šæˆ‘å€‘é–‹ç™¼è€…äº’å‹•çš„åœ°æ–¹ï¼Œä¸»è¦å°±æ˜¯ç”¨ `@Observed`ã€‚
2. **é–€é¢å±¤ (Facade API)**ï¼šç”± Micrometer æä¾›ã€‚å®ƒå®šç¾©äº†ä¸€å¥—ä¸­ç«‹ã€æ¨™æº–çš„ APIã€‚
3. **å¯¦ç¾å±¤ (Implementation)**ï¼šç”± OpenTelemetry æ“”ä»»ã€‚å®ƒæ˜¯å¯¦ç¾ Micrometer API èƒŒå¾Œçš„å¯¦éš›å¼•æ“ã€‚
4. **åŒ¯å‡ºå±¤ (Export)**ï¼šç”±å„ç¨® Exporter çµ„æˆï¼Œè² è²¬æŠŠç›£æ§æ•¸æ“šæ‰“åŒ…æˆ OTLP æ ¼å¼ï¼Œç„¶å¾Œå‚³é€åˆ°å¾Œç«¯ç³»çµ±ã€‚

### é—œéµå¥—ä»¶çš„è·è²¬èˆ‡æ•¸æ“šæµ

ä¸‹åœ–æ¸…æ¥šåœ°å±•ç¤ºäº†ï¼Œç•¶ä¸€å€‹å¸¶æœ‰ `@Observed` çš„æ–¹æ³•è¢«å‘¼å«æ™‚ï¼ŒæŒ‡æ¨™ (Metrics)ã€è¿½è¹¤ (Traces) å’Œæ—¥èªŒ (Logs) æ˜¯å¦‚ä½•ç¶“éä¸åŒçš„è·¯å¾‘é€²è¡Œè™•ç†çš„ã€‚

```mermaid
graph TD
    subgraph APP["æ‡‰ç”¨ç¨‹å¼å…§éƒ¨"]
        A["æ¥­å‹™æ–¹æ³•<br/>åŸ·è¡Œ log.info"] -->|"@Observed"| B["Micrometer Observation<br/>çµ±ä¸€é–€é¢ API"]

        subgraph TRACES["è¿½è¹¤æ•¸æ“šæµ"]
            B -.->|"å‰µå»º Span"| C_T["micrometer-tracing<br/>æ ¸å¿ƒè¿½è¹¤ API"]
            C_T --> D_T["micrometer-tracing-bridge-otel<br/>æ©‹æ¥åˆ° OTel"]
            D_T --> F_T["OpenTelemetry SDK<br/>é™æ¸¬æ•¸æ“šè™•ç†æ ¸å¿ƒ"]
        end

        subgraph LOGS["æ—¥èªŒæ•¸æ“šæµ"]
            F_T -.->|"TraceId & SpanId æ³¨å…¥ MDC"| H_L["æ—¥èªŒæ¡†æ¶<br/>SLF4J + Logback + MDC"]
            A -->|"log.info å¯«å…¥æ—¥èªŒ"| H_L
            H_L -->|"Logback Appender æ””æˆª"| I_L["opentelemetry-spring-boot-starter<br/>å« Logback æ•´åˆ"]
            I_L -->|"è½‰æ›ç‚º OTLP LogRecord"| F_T
        end

        subgraph METRICS["æŒ‡æ¨™æ•¸æ“šæµ"]
            B -.->|"è‡ªå‹•ç”Ÿæˆè¨ˆæ™‚å™¨èˆ‡è¨ˆæ•¸å™¨"| C_M["micrometer-core<br/>æŒ‡æ¨™æ”¶é›†æ ¸å¿ƒ"]
            C_M --> D_M1["micrometer-registry-otlp<br/>æŒ‡æ¨™ OTLP åŒ¯å‡ºå™¨"]
            C_M --> D_M2["micrometer-registry-prometheus<br/>Prometheus ç«¯é»åŒ¯å‡º"]
        end

        subgraph EXPORT["æ•¸æ“šåŒ¯å‡ºå±¤"]
            F_T --> G_T["opentelemetry-exporter-otlp<br/>çµ±ä¸€ OTLP åŒ¯å‡ºå™¨"]
        end
    end

    subgraph BACKEND["å¤–éƒ¨ç›£æ§å¾Œç«¯"]
        L["Grafana LGTM Stack<br/>Loki + Grafana + Tempo + Mimir"]
        P["Prometheus<br/>å¯é¸æ‹‰å–æ¨¡å¼"]
    end

    G_T -->|"Traces & Logs via OTLP"| L
    D_M1 -->|"Metrics via OTLP"| L
    D_M2 -.->|"Prometheus Pull"| P
    P -.->|"è¯é‚¦æˆ–é ç«¯è®€å–"| L
```

| å¥—ä»¶ (Dependency)                                                        | å®šä½ | åŠŸèƒ½èªªæ˜ |
| ------------------------------------------------------------------------ | :--- | :--- |
| **`spring-boot-starter-actuator`** | æ¡†æ¶åŸºç¤ | å¯è§€æ¸¬æ€§çš„åŸºçŸ³ã€‚å®ƒå¼•å…¥äº† Micrometerï¼Œä¸¦æä¾›äº† `/actuator` ç³»åˆ—ç«¯é»ã€‚ |
| **`spring-boot-starter-aop`** | `@Observed` çš„å‹•åŠ› | æä¾› AOP æŠ€è¡“ï¼Œè®“ `@Observed` è¨»è§£å¯ä»¥è¢«æ””æˆªä¸¦è‡ªå‹•åŠ ä¸Šç›£æ§é‚è¼¯ã€‚ |
| **`io.micrometer:micrometer-tracing-bridge-otel`** | API æ©‹æ¥å™¨ | æ“”ä»»ç¿»è­¯å®˜ï¼ŒæŠŠ Micrometer çš„è¿½è¹¤æŒ‡ä»¤ï¼Œè½‰è­¯æˆ OpenTelemetry èƒ½è½æ‡‚çš„æŒ‡ä»¤ã€‚ |
| **`io.opentelemetry.instrumentation:opentelemetry-spring-boot-starter`** | è‡ªå‹•è¨­å®šå¥—ä»¶ | å¤§å¤§ç°¡åŒ–äº†æ•´åˆï¼Œåœ¨å¹•å¾Œè‡ªå‹•å®Œæˆ OpenTelemetry çš„åˆå§‹åŒ–å’Œè¨­å®šã€‚ |
| **`io.opentelemetry:opentelemetry-exporter-otlp`** | è¿½è¹¤ & æ—¥èªŒåŒ¯å‡ºå™¨ | è² è²¬æŠŠç”¢ç”Ÿçš„è¿½è¹¤å’Œæ—¥èªŒæ•¸æ“šï¼Œæ‰“åŒ…æˆ OTLP æ ¼å¼ä¸¦é€éç¶²è·¯å‚³é€å‡ºå»ã€‚ |
| **`micrometer-registry-otlp`** | æŒ‡æ¨™åŒ¯å‡ºå™¨ | è·è²¬å¾ˆæ˜ç¢ºï¼šæŠŠ Micrometer æ”¶é›†åˆ°çš„æŒ‡æ¨™æ•¸æ“šï¼Œè½‰æ›æˆ OTLP æ ¼å¼ä¸¦æ¨é€åˆ°å¾Œç«¯ã€‚ |
| **`micrometer-registry-prometheus`** | æŒ‡æ¨™æœ¬åœ°ç«¯é» | æä¾›å¦ä¸€ç¨®æŸ¥çœ‹æŒ‡æ¨™çš„æ–¹å¼ã€‚å®ƒæœƒåœ¨ `/actuator/prometheus` é–‹ä¸€å€‹ HTTP ç«¯é»ï¼Œæ–¹ä¾¿é–‹ç™¼å’Œé™¤éŒ¯æ™‚ç›´æ¥æŸ¥çœ‹æŒ‡æ¨™æ•¸æ“šã€‚ |

ç°¡å–®ä¾†èªªï¼Œæˆ‘å€‘çš„æ‡‰ç”¨ç¨‹å¼é€éçµ±ä¸€çš„ Micrometer API (`@Observed`) é€²è¡Œç›£æ§ï¼Œç”± OpenTelemetry åœ¨å¹•å¾Œå¯¦ç¾è¿½è¹¤ï¼Œå†ç”±å„å¸å…¶è·çš„åŒ¯å‡ºå™¨ï¼Œå°‡æ•¸æ“šä»¥ OTLP æ ¼å¼ç™¼é€åˆ°å¾Œç«¯ã€‚è€Œé€™ä¸€åˆ‡è¤‡é›œçš„çµ„è£å·¥ä½œï¼Œéƒ½ç”± Spring Boot è‡ªå‹•åŒ–å®Œæˆï¼Œæ§‹æˆäº†ä¸€å€‹åˆ†å·¥æ¸…æ™°ã€å®¹æ˜“ç¶­è­·çš„è§€æ¸¬é«”ç³»ã€‚

### é‹è¡Œæ™‚è¦–åœ– (Runtime View)

#### ä¸€æ¬¡ API è«‹æ±‚çš„æ—…ç¨‹

è®“æˆ‘å€‘çœ‹çœ‹ç•¶ä¸€å€‹ã€Œæ–°å¢æ›¸æœ¬ã€çš„è«‹æ±‚ (`POST /books`) é€²ä¾†æ™‚ï¼Œç³»çµ±å…§éƒ¨ç™¼ç”Ÿäº†ä»€éº¼äº‹ã€‚

```mermaid
sequenceDiagram
    participant Client as ğŸ‘¨â€ğŸ’» API å®¢æˆ¶ç«¯
    participant App as ğŸš€ Demo æ‡‰ç”¨ç¨‹å¼
    participant SVC as ğŸ“– BookService
    participant DB as ğŸ˜ PostgreSQL
    participant Cache as âš¡ Redis
    participant LGTM as ğŸ“ˆ otel-lgtm

    Client ->> App: POST /books (Request)
    Note over App: Spring MVC æ”¶åˆ°è«‹æ±‚ï¼Œè‡ªå‹•ç”¢ç”Ÿä¸€ç­† Trace

    App ->> SVC: createBook(book)
    Note over SVC: @Observed è¨»è§£ç”Ÿæ•ˆï¼Œå»ºç«‹ä¸€å€‹æ–°çš„ Span

    SVC ->> DB: æª¢æŸ¥ ISBN æ˜¯å¦å­˜åœ¨
    SVC ->> DB: å„²å­˜æ–°æ›¸æœ¬
    Note over SVC,DB: JPA æœƒè‡ªå‹•ç‚ºè³‡æ–™åº«æ“ä½œç”¢ç”Ÿå°æ‡‰çš„ Span

    SVC ->> Cache: @CacheEvict æ¸…é™¤å¿«å–
    Note over Cache: Redis æ“ä½œä¹Ÿæœƒè¢«è‡ªå‹•ç”¢ç”Ÿ Span

    SVC -->> App: å›å‚³æ–°å¢çš„æ›¸æœ¬
    App -->> Client: 201 Created (Response)

    Note over App,LGTM: åœ¨æ•´å€‹éç¨‹ä¸­ï¼Œ<br/>æ‡‰ç”¨ç¨‹å¼æœƒæŒçºŒå°‡ Logs, Traces, Metrics<br/>é€é OTLP æ ¼å¼å‚³é€åˆ° otel-lgtm ç›£æ§å¾Œç«¯
```

---

## ğŸ”¬ ç¾ä»£åŒ–å¯è§€æ¸¬æ€§ (Observability) - ç¬¬ä¸‰éƒ¨åˆ†ï¼šåœ¨ Grafana ä¸­æ¢ç´¢é™æ¸¬æ•¸æ“š

ç¾åœ¨ï¼Œæœ€æ¿€å‹•äººå¿ƒçš„éƒ¨åˆ†ä¾†äº†ï¼šå¯¦éš›çœ‹åˆ°æˆ‘å€‘è¾›è‹¦è¨­å®šå¾Œæ”¶é›†åˆ°çš„é™æ¸¬æ•¸æ“šã€‚æ‰“é–‹ç€è¦½å™¨ï¼Œè¨ªå• `http://localhost:3000` å³å¯é€²å…¥ Grafana çš„å„€è¡¨æ¿ã€‚

### Grafana å°è¦½èˆ‡æ•¸æ“šæº

åœ¨ Grafana çš„å·¦å´å°èˆªæ¬„ä¸­ï¼Œé»æ“Šã€ŒExploreã€ï¼ˆæŒ‡å—é‡åœ–æ¨™ï¼‰ã€‚åœ¨é é¢é ‚éƒ¨çš„ä¸‹æ‹‰èœå–®ä¸­ï¼Œæ‚¨æœƒçœ‹åˆ° `otel-lgtm` é€™å€‹ Docker æ˜ åƒæª”å·²ç¶“ç‚ºæˆ‘å€‘é å…ˆé…ç½®å¥½äº†ä¸‰å€‹æ ¸å¿ƒæ•¸æ“šæºï¼Œå°æ‡‰å¯è§€æ¸¬æ€§çš„ä¸‰å¤§æ”¯æŸ±ï¼š

- **`mimir`**: ç”¨æ–¼æŸ¥è©¢**æŒ‡æ¨™ (Metrics)**ã€‚
- **`loki`**: ç”¨æ–¼æŸ¥è©¢**æ—¥èªŒ (Logs)**ã€‚
- **`tempo`**: ç”¨æ–¼æŸ¥è©¢**è¿½è¹¤ (Traces)**ã€‚

### è¿½è¹¤ (Traces) çš„è—è¡“ï¼šä½¿ç”¨ Tempo å’Œ TraceQL

åœ¨ Grafana çš„ Explore é é¢ï¼Œé¸æ“‡ `tempo` æ•¸æ“šæºã€‚æˆ‘å€‘å¯ä»¥ä½¿ç”¨ TraceQL èªè¨€ä¾†æŸ¥è©¢è¿½è¹¤ã€‚

1. **æŒ‰æœå‹™åç¨±æŸ¥è©¢**:
    åœ¨ `application.yml` ä¸­ï¼Œæˆ‘å€‘å®šç¾©äº† `spring.application.name: demo`ã€‚é€™å€‹åç¨±æœƒè¢« OpenTelemetry ç•¶ä½œ `service.name`ã€‚å› æ­¤ï¼Œæœ€å¸¸ç”¨çš„æŸ¥è©¢å°±æ˜¯ç¯©é¸å‡ºæ‰€æœ‰ä¾†è‡ªæˆ‘å€‘æ‡‰ç”¨ç¨‹å¼çš„è¿½è¹¤ã€‚

    ```text
    {resource.service.name="demo"}
    ```

    ![image](https://raw.githubusercontent.com/samzhu/demo-springboot-250613/refs/heads/main/dev-resources/images/tempo_query1.jpg)

2. **æŒ‰è‡ªè¨‚çš„ Span åç¨±æŸ¥è©¢**:
    æˆ‘å€‘åœ¨ `BookService` ä¸­ç”¨ `@Observed(contextualName = "æ›¸æœ¬è©³æƒ…æŸ¥çœ‹")` ç‚ºæ–¹æ³•åŠ ä¸Šäº†æœ‰æ„ç¾©çš„åç¨±ã€‚é€™å€‹åç¨±æœƒè®Šæˆ Span çš„åå­—ã€‚é€™å¯ä»¥è®“æˆ‘å€‘ç²¾ç¢ºåœ°æ‰¾åˆ°ç‰¹å®šæ¥­å‹™é‚è¼¯çš„è¿½è¹¤ã€‚

    ```text
    {name="æ›¸æœ¬è©³æƒ…æŸ¥çœ‹"}
    ```

    ![image](https://raw.githubusercontent.com/samzhu/demo-springboot-250613/refs/heads/main/dev-resources/images/tempo_query2.jpg)

3. **åˆ†æè¿½è¹¤è¦–åœ– (Waterfall View)**:
    é»æ“Šä»»æ„ä¸€å€‹æŸ¥è©¢çµæœï¼Œæ‚¨æœƒçœ‹åˆ°ä¸€å€‹ç€‘å¸ƒåœ–ã€‚
    - **å¿«å–æœªå‘½ä¸­ (Cache Miss)**ï¼šç•¶æ‚¨ç¬¬ä¸€æ¬¡æŸ¥è©¢æŸæœ¬æ›¸çš„è©³æƒ…æ™‚ï¼Œæœƒçœ‹åˆ°ä¸€å€‹å±¤ç´šåˆ†æ˜çš„çµæ§‹ï¼šé ‚å±¤æ˜¯ `GET /books/{id}`ï¼Œå…¶ä¸‹æ˜¯ `æ›¸æœ¬è©³æƒ…æŸ¥çœ‹`ï¼Œå†ä¸‹é¢é‚„æœƒæœ‰ `SELECT` è³‡æ–™åº«æŸ¥è©¢çš„ Spanã€‚æ¯å€‹ Span çš„è€—æ™‚éƒ½æ¸…æ™°å¯è¦‹ã€‚
    - **å¿«å–å‘½ä¸­ (Cache Hit)**ï¼šç•¶æ‚¨å†æ¬¡æŸ¥è©¢åŒä¸€æœ¬æ›¸æ™‚ï¼Œæœƒç™¼ç¾ `SELECT` é€™å€‹ Span æ¶ˆå¤±äº†ï¼Œä¸¦ä¸”æ•´å€‹è¿½è¹¤çš„ç¸½è€—æ™‚é¡¯è‘—ç¸®çŸ­ã€‚é€™å°±æ˜¯å¿«å–ç™¼æ®ä½œç”¨çš„ç›´æ¥è­‰æ˜ã€‚

### æŒ‡æ¨™ (Metrics) çš„åŠ›é‡ï¼šä½¿ç”¨ Mimir å’Œ PromQL

åœ¨æ–°ç‰ˆæœ¬ä¸­ï¼Œå„˜ç®¡åº•å±¤å„²å­˜æŒ‡æ¨™çš„æŠ€è¡“æ˜¯ Mimirï¼Œä½†å®ƒæä¾›çš„æ˜¯èˆ‡ Prometheus å®Œå…¨ç›¸å®¹çš„æŸ¥è©¢ç«¯é»ã€‚å› æ­¤ï¼Œæ•¸æ“šæºè¢«ç›´æ¥å‘½åç‚º `prometheus`ï¼Œè®“ä½¿ç”¨è€…å¯ä»¥å°ˆæ³¨æ–¼ä½¿ç”¨æ¨™æº–çš„ PromQL (Prometheus Query Language) é€²è¡ŒæŸ¥è©¢ï¼Œé€™ä¹Ÿæ˜¯æ¥­ç•Œæœ€å»£æ³›ä½¿ç”¨çš„æŒ‡æ¨™æŸ¥è©¢èªè¨€ã€‚

#### OTLP åˆ° Prometheus çš„åç¨±è½‰æ›

ç†è§£ä¸€å€‹é—œéµçš„è½‰æ›è¦å‰‡è‡³é—œé‡è¦ï¼šMicrometer ç”¢ç”Ÿçš„æŒ‡æ¨™åç¨±ï¼Œåœ¨é€é OTLP åŒ¯å‡ºåˆ° Mimir/Prometheus æ™‚ï¼Œæ ¼å¼æœƒè¢«è½‰æ›ã€‚

- æŒ‡æ¨™åç¨±ä¸­çš„é» `.` æœƒè¢«è½‰æ›ç‚ºä¸‹åŠƒç·š `_`ã€‚
- `service.name` (`demo`) é€™å€‹è³‡æºå±¬æ€§æœƒè¢«æ˜ å°„ç‚º `job` æ¨™ç±¤ã€‚
- è¨ˆæ™‚å™¨ (`@Observed` æˆ– HTTP è«‹æ±‚) æœƒè‡ªå‹•ç”¢ç”Ÿä»¥ `_milliseconds` ç‚ºå–®ä½ï¼Œä¸¦å¸¶æœ‰ `_count` (è¨ˆæ•¸), `_sum` (ç¸½å’Œ), `_bucket` (ç›´æ–¹åœ–åˆ†æ¡¶) ç­‰å¾Œç¶´çš„æŒ‡æ¨™ã€‚é€™æ˜¯ç”±æ–¼è¼ƒæ–°ç‰ˆæœ¬çš„ Micrometer ç‚ºäº†æé«˜ç²¾ç¢ºåº¦ï¼Œé è¨­ä½¿ç”¨æ¯«ç§’ä½œç‚ºæ™‚é–“å–®ä½ã€‚

| åŸå§‹åç¨± (`@Observed` name) | è½‰æ›å¾Œçš„ PromQL æŒ‡æ¨™ (ç¯„ä¾‹) |
| :--- | :--- |
| `book.details.view` | `book_details_view_milliseconds_count`, `book_details_view_milliseconds_sum` |
| HTTP Server Requests | `http_server_requests_milliseconds_count` |

#### å¯¦ç”¨ PromQL æŸ¥è©¢

1. **æŸ¥è©¢ API æ¯ç§’è«‹æ±‚æ•¸ (RPS)**:

    ```promql
    rate(http_server_requests_milliseconds_count{job="demo"}[5m])
    ```

    é€™å€‹æŸ¥è©¢è¨ˆç®—äº†åœ¨éå» 5 åˆ†é˜çª—å£å…§ï¼Œ`demo` æœå‹™æ¯ç§’çš„å¹³å‡è«‹æ±‚æ•¸ã€‚

    ![image](https://raw.githubusercontent.com/samzhu/demo-springboot-250613/refs/heads/main/dev-resources/images/prometheus_query1.jpg)

2. **æŸ¥è©¢ã€ŒæŸ¥çœ‹æ›¸æœ¬è©³æƒ…ã€æ“ä½œçš„ P95 å»¶é² (å–®ä½ï¼šæ¯«ç§’)**:

    ```promql
    histogram_quantile(0.95, sum(rate(book_details_view_milliseconds_bucket{job="demo"}[5m])) by (le))
    ```

    é€™æ˜¯ä¸€å€‹æ›´é«˜ç´šçš„æŸ¥è©¢ï¼Œå®ƒåˆ©ç”¨ç›´æ–¹åœ– (`_bucket`) æ•¸æ“šï¼Œè¨ˆç®—å‡º 95% çš„ã€ŒæŸ¥çœ‹æ›¸æœ¬è©³æƒ…ã€æ“ä½œçš„å»¶é²æ™‚é–“ï¼Œçµæœä»¥æ¯«ç§’ç‚ºå–®ä½ã€‚

3. **åˆ©ç”¨è‡ªè¨‚æ¨™ç±¤åˆ†æ**:
    æˆ‘å€‘åœ¨ `@Observed` ä¸­å®šç¾©äº† `lowCardinalityKeyValues`ã€‚ä¾‹å¦‚ `operation="get_by_id"`ã€‚é€™å€‹æ¨™ç±¤å¯ä»¥ç”¨ä¾†åšæ›´ç²¾ç´°çš„åˆ†æã€‚

    ```promql
    // è¨ˆç®—æ‰€æœ‰ "get_by_id" æ“ä½œåœ¨éå»5åˆ†é˜å…§çš„ç¸½æ¬¡æ•¸
    sum(increase(book_details_view_milliseconds_count{job="demo", operation="get_by_id"}[5m]))
    ```

#### Exemplars çš„é­”æ³•

åœ¨ Grafana çš„åœ–è¡¨é¢æ¿ä¸­ï¼Œå¦‚æœæ‚¨çœ‹åˆ°æ•¸æ“šé»æ—é‚Šæœ‰ä¸€å€‹å½©è‰²çš„é‘½çŸ³åœ–æ¨™ï¼Œé€™å°±æ˜¯ä¸€å€‹ **Exemplar**ã€‚å®ƒæ˜¯ä¸€å€‹èˆ‡è©²æ™‚é–“é»çš„æŒ‡æ¨™æ•¸æ“šç›¸é—œè¯çš„**å…·é«”è¿½è¹¤æ¨£æœ¬**ã€‚ç•¶æ‚¨çœ‹åˆ°å»¶é²åœ–è¡¨ä¸Šå‡ºç¾ä¸€å€‹å°–å³°æ™‚ï¼Œå¯ä»¥ç›´æ¥é»æ“Šé‚£å€‹å°–å³°ä¸Šçš„é‘½çŸ³åœ–æ¨™ï¼ŒGrafana æœƒç«‹åˆ»å¸¶æ‚¨è·³è½‰åˆ°**å°è‡´é€™å€‹å»¶é²å°–å³°çš„é‚£å€‹è«‹æ±‚çš„å®Œæ•´è¿½è¹¤è¦–åœ–**ã€‚é€™å€‹åŠŸèƒ½æ¥µå¤§åœ°ç¸®çŸ­äº†å¾ã€Œç™¼ç¾å•é¡Œã€åˆ°ã€Œå®šä½å•é¡Œã€çš„è·¯å¾‘ã€‚

### æ—¥èªŒ (Logs) çš„é—œè¯ï¼šä½¿ç”¨ Loki å’Œ LogQL

æœ€å¾Œï¼Œé¸æ“‡ `loki` æ•¸æ“šæºã€‚æˆ‘å€‘ä½¿ç”¨ LogQL ä¾†æŸ¥è©¢æ—¥èªŒã€‚

è¦è®“æ—¥èªŒèƒ½å¤ è¢«å¾Œç«¯çš„ `otel-lgtm` æˆåŠŸæ”¶é›†èˆ‡è§£æï¼Œå‰ææ˜¯éœ€è¦**å•Ÿç”¨ Spring Boot çš„æª”æ¡ˆæ—¥èªŒåŠŸèƒ½ï¼Œä¸¦å°‡å…¶æ ¼å¼è¨­å®šç‚º `logstash` JSON**ã€‚é€™èƒ½ç¢ºä¿æ‰€æœ‰å¯«å…¥æª”æ¡ˆçš„æ—¥èªŒéƒ½å…·å‚™ Loki å–œæ„›çš„çµæ§‹åŒ–æ ¼å¼ã€‚æ‚¨å¯ä»¥é€éåœ¨ `application.yml` ä¸­åŠ å…¥é¡ä¼¼ä»¥ä¸‹çš„è¨­å®šä¾†é”æˆï¼š

```yaml
logging:
  structured:
    format:
      file: logstash     # å°‡æª”æ¡ˆæ—¥èªŒçš„æ ¼å¼è¨­ç‚º logstash (JSON)
```

è¨­å®šå®Œæˆå¾Œï¼Œå¾—ç›Šæ–¼ OpenTelemetry çš„è‡ªå‹•æ•´åˆï¼Œ`trace_id` å’Œ `span_id` ç­‰é—œéµè¿½è¹¤è³‡è¨Šæœƒè¢«è‡ªå‹•åŠ å…¥åˆ° JSON æ—¥èªŒä¸­ï¼Œé€™ä½¿å¾—æ—¥èªŒèˆ‡è¿½è¹¤çš„é—œè¯ç„¡æ¯”å¼·å¤§ã€‚

1. **æŸ¥è©¢æ‡‰ç”¨çš„æ‰€æœ‰æ—¥èªŒ**:
    åœ¨ `application.yml` ä¸­å®šç¾©çš„ `spring.application.name` æœƒè¢«è‡ªå‹•æ˜ å°„ç‚º Loki ä¸­çš„ `service_name` æ¨™ç±¤ã€‚é€™æ˜¯ç¯©é¸ç‰¹å®šæ‡‰ç”¨æ—¥èªŒæœ€ç›´æ¥çš„æ–¹æ³•ã€‚

    ```logql
    {service_name="demo"}
    ```

    ![image](https://raw.githubusercontent.com/samzhu/demo-springboot-250613/refs/heads/main/dev-resources/images/loki_query1.jpg)

2. **å¾è¿½è¹¤è·³è½‰åˆ°æ—¥èªŒ (Trace to Logs)**:
    é€™æ˜¯æœ€å¸¸ç”¨çš„åŠŸèƒ½ã€‚ç”±æ–¼ `trace_id` å·²ç¶“åŒ…å«åœ¨æˆ‘å€‘è¼¸å‡ºçš„ JSON æ—¥èªŒä¸­ï¼Œ`otel-lgtm` ä¸­çš„æ—¥èªŒä»£ç†æœƒæ™ºèƒ½åœ°å°‡å…¶æå–ç‚ºå¯ä¾›ç´¢å¼•çš„æ¨™ç±¤ã€‚å› æ­¤ï¼Œåœ¨ Tempo çš„è¿½è¹¤ç€‘å¸ƒåœ–ä¸­ï¼Œé»æ“Šä»»ä¸€å€‹ Spanï¼Œå†é»æ“Šã€ŒLogs for this spanã€æŒ‰éˆ•ï¼ŒGrafana ä¾ç„¶å¯ä»¥ç²¾æº–åœ°ç‚ºæ‚¨ç¯©é¸å‡ºæ‰€æœ‰ç›¸é—œçš„æ—¥èªŒã€‚

3. **æ‰‹å‹•é€šé Trace ID æŸ¥è©¢æ—¥èªŒ**:
    æ‚¨ä¹Ÿå¯ä»¥å¾ Tempo è¤‡è£½ä¸€å€‹ `trace_id`ï¼Œç„¶å¾Œåœ¨ Loki ä¸­ç›´æ¥ä½¿ç”¨é€™å€‹æ¨™ç±¤ä¾†æŸ¥è©¢ï¼Œé€™æ¯”è§£æå…¨æ–‡æ›´é«˜æ•ˆã€‚

    ```logql
    {service_name="demo", trace_id="è¤‡è£½éä¾†çš„_trace_id"}
    ```

    å¦‚æœæ‚¨é‚„æƒ³é€²ä¸€æ­¥è™•ç†æ—¥èªŒçš„ JSON å…§å®¹ï¼ˆä¾‹å¦‚ï¼Œåªé¡¯ç¤º `message` æ¬„ä½ï¼‰ï¼Œå¯ä»¥åŠ ä¸Š `json` å’Œ `line_format` éæ¿¾å™¨ï¼š

    ```logql
    {service_name="demo", trace_id="è¤‡è£½éä¾†çš„_trace_id"} | json | line_format "{{.message}}"
    ```

---

## ğŸ”¬ ç¾ä»£åŒ–å¯è§€æ¸¬æ€§ (Observability) - ç¬¬å››éƒ¨åˆ†ï¼šå…¨æ£§è¿½è¹¤èˆ‡ Grafana Faro æ•´åˆ (é¸ç”¨)

åœ¨ç¾ä»£åŒ–çš„ Web æ‡‰ç”¨ä¸­ï¼Œåƒ…åƒ…ç›£æ§å¾Œç«¯æœå‹™æ˜¯ä¸å¤ çš„ã€‚å®Œæ•´çš„å¯è§€æ¸¬æ€§éœ€è¦æ¶µè“‹å¾ç”¨æˆ¶ç€è¦½å™¨åˆ°å¾Œç«¯è³‡æ–™åº«çš„å…¨éˆè·¯è¿½è¹¤ã€‚æœ¬å°ˆæ¡ˆå±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨ **Grafana Faro** å¯¦ç¾å‰ç«¯å¯è§€æ¸¬æ€§ï¼Œä¸¦èˆ‡å¾Œç«¯ OpenTelemetry è¿½è¹¤ç„¡ç¸«æ•´åˆã€‚

### Grafana Faro æ•´åˆå¯¦ç¾

#### å‰ç«¯è¿½è¹¤é…ç½® (`src/main/resources/static/index.html`)

æˆ‘å€‘åœ¨å‰ç«¯é é¢ä¸­æ•´åˆäº† Grafana Faroï¼Œå¯¦ç¾äº†å®Œæ•´çš„å‰ç«¯å¯è§€æ¸¬æ€§ï¼š

```html
<!-- è¼‰å…¥ Grafana Faro ç›¸é—œ CDN å¥—ä»¶ -->
<script src="https://cdn.jsdelivr.net/npm/@grafana/faro-web-sdk@^1/dist/bundle/faro-web-sdk.iife.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@grafana/faro-web-tracing@^1/dist/bundle/faro-web-tracing.iife.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@grafana/faro-transport-otlp-http@^1/dist/bundle/faro-transport-otlp-http.iife.js"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const { initializeFaro, getWebInstrumentations } = window.GrafanaFaroWebSdk;
    const { TracingInstrumentation } = window.GrafanaFaroWebTracing;
    const { OtlpHttpTransport } = window.GrafanaFaroTransportOtlpHttp;

    const faro = initializeFaro({
        // æ‡‰ç”¨ç¨‹å¼æ¨™è­˜
        app: {
            name: 'my-app-frontend',
            version: '1.0.0',
            environment: 'development'
        },

        // æ˜ç¢ºè¨­ç½® OpenTelemetry resource å±¬æ€§
        otelResourceAttributes: {
            'service.name': 'my-app-frontend',
            'service.version': '1.0.0',
            'deployment.environment': 'development'
        },

        // è‡ªå‹•æª¢æ¸¬é…ç½®
        instrumentations: [
            ...getWebInstrumentations(),      // åŸºæœ¬ Web æª¢æ¸¬å™¨
            new TracingInstrumentation()      // è¿½è¹¤æª¢æ¸¬å™¨ï¼ˆè‡ªå‹•ç‚º fetch æ³¨å…¥ traceparentï¼‰
        ],

        // OTLP å‚³è¼¸å™¨é…ç½®
        transports: [
            new OtlpHttpTransport({
                tracesURL: 'http://localhost:4318/v1/traces',
                logsURL: 'http://localhost:4318/v1/logs',
                bufferSize: 100,
                concurrency: 5,
            })
        ],

        debug: true,
    });

    // æ¸¬è©¦ç™¼é€åˆå§‹äº‹ä»¶
    faro.api.pushEvent('page_loaded', { timestamp: Date.now() });
});
</script>
```

#### è‡ªå‹•å‰å¾Œç«¯è¿½è¹¤é—œè¯

ç•¶ç”¨æˆ¶é»æ“Šã€ŒGet Booksã€æŒ‰éˆ•æ™‚ï¼ŒFaro çš„ `TracingInstrumentation` æœƒè‡ªå‹•ï¼š

1. **å‰µå»ºå‰ç«¯ Span**ï¼šè¨˜éŒ„ç”¨æˆ¶æ“ä½œå’Œ API è«‹æ±‚
2. **æ³¨å…¥ traceparent æ¨™é ­**ï¼šåœ¨ `fetch('/books')` è«‹æ±‚ä¸­è‡ªå‹•æ·»åŠ è¿½è¹¤ä¸Šä¸‹æ–‡
3. **é—œè¯å¾Œç«¯è¿½è¹¤**ï¼šSpring Boot æ¥æ”¶åˆ° traceparent æ¨™é ­ï¼Œå»ºç«‹é—œè¯çš„å¾Œç«¯ Span

```javascript
// å¯¦éš›çš„äº‹ä»¶è™•ç†é‚è¼¯
getBooksButton.addEventListener('click', () => {
    // æ‰‹å‹•ç™¼é€è‡ªè¨‚äº‹ä»¶
    if (window.faro && window.faro.api) {
        window.faro.api.pushEvent('button_clicked', { action: 'get_books' });
    }
    
    // Fetch API æœƒè¢« TracingInstrumentation è‡ªå‹•è¿½è¹¤
    fetch('/books')
      .then(response => {
          // è™•ç†å›æ‡‰...
          if (window.faro && window.faro.api) {
              window.faro.api.pushEvent('books_fetched', { count: data.length });
          }
      })
      .catch(error => {
          // è‡ªå‹•éŒ¯èª¤è¿½è¹¤
          if (window.faro && window.faro.api) {
              window.faro.api.pushError(error);
          }
      });
});
```

### å…¨æ£§è¿½è¹¤åœ¨ Tempo ä¸­çš„æ•ˆæœ

æ•´åˆ Grafana Faro å¾Œï¼Œæ‚¨å¯ä»¥åœ¨ Tempo ä¸­çœ‹åˆ°å®Œæ•´çš„å‰å¾Œç«¯è¿½è¹¤éˆè·¯ï¼š

![Tempo å…¨æ£§è¿½è¹¤æŸ¥è©¢](https://raw.githubusercontent.com/samzhu/demo-springboot-250613/refs/heads/main/dev-resources/images/tempo_query4.jpg)

å¦‚åœ–æ‰€ç¤ºï¼Œç¾åœ¨å¯ä»¥åœ¨ Tempo ä¸­æŸ¥è©¢åˆ°ï¼š

- **å‰ç«¯æœå‹™** (`my-app-frontend`)ï¼šç”¨æˆ¶äº’å‹•ã€é é¢è¼‰å…¥ã€API è«‹æ±‚
- **å¾Œç«¯æœå‹™** (`demo`)ï¼šAPI è™•ç†ã€æ¥­å‹™é‚è¼¯ã€è³‡æ–™åº«æ“ä½œ
- **å®Œæ•´éˆè·¯**ï¼šå¾ç”¨æˆ¶é»æ“Šåˆ°è³‡æ–™åº«æŸ¥è©¢çš„ç«¯åˆ°ç«¯è¿½è¹¤

### å¯¦ç”¨çš„å…¨æ£§è¿½è¹¤æŸ¥è©¢

#### 1. æŸ¥è©¢å‰ç«¯è¿½è¹¤

```traceql
{resource.service.name="my-app-frontend"}
```

#### 2. æŸ¥è©¢å¾Œç«¯è¿½è¹¤

```traceql
{resource.service.name="demo"}
```

#### 3. æŸ¥è©¢å®Œæ•´çš„å‰å¾Œç«¯éˆè·¯

```traceql
{resource.service.name="my-app-frontend" || resource.service.name="demo"}
```

#### 4. åˆ†æè·¨æœå‹™æ•ˆèƒ½

```traceql
{(resource.service.name="my-app-frontend" || resource.service.name="demo") && duration>1s}
```

#### 5. è¿½è¹¤ç‰¹å®šæ¥­å‹™æ“ä½œ

```traceql
{resource.service.name="demo" && name="æ›¸æœ¬è©³æƒ…æŸ¥çœ‹"}
```

### Faro æ•´åˆçš„å„ªå‹¢

1. **é›¶é…ç½®è‡ªå‹•é—œè¯**ï¼šå‰å¾Œç«¯è¿½è¹¤é€šé `traceparent` æ¨™é ­è‡ªå‹•é—œè¯
2. **å®Œæ•´ç”¨æˆ¶é«”é©—**ï¼šå¾ç€è¦½å™¨é»æ“Šåˆ°è³‡æ–™åº«æŸ¥è©¢çš„å®Œæ•´è¦–åœ–
3. **çµ±ä¸€ç›£æ§å¹³å°**ï¼šå‰å¾Œç«¯æ•¸æ“šéƒ½åŒ¯èšåˆ°åŒä¸€å€‹ Grafana/Tempo å¹³å°
4. **è±å¯Œçš„ä¸Šä¸‹æ–‡**ï¼šçµåˆå‰ç«¯ç”¨æˆ¶è¡Œç‚ºå’Œå¾Œç«¯æ¥­å‹™é‚è¼¯çš„å®Œæ•´ä¸Šä¸‹æ–‡

### å¯¦éš›æ‡‰ç”¨å ´æ™¯

- **ç”¨æˆ¶é«”é©—åˆ†æ**ï¼šåˆ†æå¾ç”¨æˆ¶é»æ“Šåˆ°é é¢æ›´æ–°çš„å®Œæ•´æ™‚é–“ç·š
- **æ•ˆèƒ½ç“¶é ¸å®šä½**ï¼šå¿«é€Ÿåˆ¤æ–·æ…¢è«‹æ±‚æ˜¯å‰ç«¯å•é¡Œé‚„æ˜¯å¾Œç«¯å•é¡Œ  
- **éŒ¯èª¤æ ¹å› åˆ†æ**ï¼šè¿½è¹¤éŒ¯èª¤å¾å‰ç«¯å‚³æ’­åˆ°å¾Œç«¯çš„å®Œæ•´éˆè·¯
- **æ¥­å‹™æµç¨‹ç›£æ§**ï¼šç›£æ§é—œéµæ¥­å‹™æµç¨‹åœ¨å‰å¾Œç«¯çš„åŸ·è¡Œæƒ…æ³

é€šé Grafana Faro çš„æ•´åˆï¼Œæˆ‘å€‘å¯¦ç¾äº†çœŸæ­£çš„å…¨æ£§å¯è§€æ¸¬æ€§ï¼Œç‚ºç¾ä»£åŒ– Web æ‡‰ç”¨æä¾›äº†å®Œæ•´çš„ç›£æ§è§£æ±ºæ–¹æ¡ˆã€‚

---

## ç’°å¢ƒèˆ‡çµ„æ…‹è¨­å®š

### å®¹å™¨åŒ–ç’°å¢ƒ (`compose.yaml`)

æˆ‘å€‘ä½¿ç”¨ Docker Compose ä¾†ä¸€éµå•Ÿå‹•æ‰€æœ‰éœ€è¦çš„å¤–éƒ¨æœå‹™ï¼ŒåŒ…æ‹¬ `postgres` (è³‡æ–™åº«)ã€`redis` (å¿«å–) å’Œ `otel-lgtm` (ç›£æ§å¾Œç«¯)ã€‚é€™è®“ä»»ä½•é–‹ç™¼è€…éƒ½èƒ½å¿«é€Ÿåœ¨è‡ªå·±é›»è…¦ä¸Šï¼Œå»ºç«‹èµ·ä¸€å€‹å®Œæ•´çš„é–‹ç™¼èˆ‡æ¸¬è©¦ç’°å¢ƒã€‚

### æ‡‰ç”¨ç¨‹å¼çµ„æ…‹ (`application.yml`)

é€™æ˜¯å°ˆæ¡ˆçš„æ§åˆ¶ä¸­å¿ƒï¼Œå®šç¾©äº†æ‡‰ç”¨ç¨‹å¼çš„å„ç¨®è¡Œç‚ºã€‚è®€åˆ°é€™è£¡ï¼Œä½ æ‡‰è©²æ›´èƒ½ç†è§£æ¯ä¸€é …è¨­å®šï¼Œæ˜¯å¦‚ä½•å°æ‡‰åˆ°å‰é¢ç« ç¯€è¨è«–åˆ°çš„æŠ€è¡“ï¼š

- **`spring.application.name: demo`**: éå¸¸é‡è¦ã€‚é€™å€‹åå­—æœƒè®Šæˆ OpenTelemetry è£¡çš„ `service.name`ï¼Œæ˜¯ä½ åœ¨ Grafana ä¸Šç¯©é¸æœå‹™çš„ä¾æ“šã€‚
- **`spring.threads.virtual.enabled: true`**: å•Ÿç”¨ Java 21 çš„è™›æ“¬åŸ·è¡Œç·’ï¼Œæå‡æ‡‰ç”¨ååé‡ã€‚è©³è¦‹ ğŸš€ æ•ˆèƒ½æå‡ ç« ç¯€ã€‚
- **`management.observations.annotations.enabled: true`**: å•Ÿç”¨ `@Observed` è¨»è§£çš„ç¸½é–‹é—œã€‚è©³è¦‹ ğŸ”¬ å¯è§€æ¸¬æ€§ ç« ç¯€ã€‚
- **`management.opentelemetry.resource-attributes`**: ç‚ºæ‰€æœ‰é€å‡ºå»çš„ç›£æ§æ•¸æ“šï¼Œéƒ½è²¼ä¸Šé¡å¤–çš„æ¨™ç±¤ï¼Œä¾‹å¦‚æœå‹™ç‰ˆæœ¬å’Œéƒ¨ç½²ç’°å¢ƒï¼Œæ–¹ä¾¿åœ¨å¾Œç«¯åˆ†é¡ç¯©é¸ã€‚
- **`management.tracing.sampling.probability: 1.0`**: æ¡æ¨£ç‡è¨­å®šç‚º `1.0` (ä¹Ÿå°±æ˜¯ 100%)ã€‚é€™åœ¨é–‹ç™¼å’Œæ¸¬è©¦æ™‚å¾ˆæœ‰ç”¨ï¼Œèƒ½ç¢ºä¿æ¯å€‹è«‹æ±‚çš„è¿½è¹¤éƒ½è¢«è¨˜éŒ„ä¸‹ä¾†ã€‚åœ¨æ­£å¼ç’°å¢ƒï¼Œç‚ºäº†æ•ˆèƒ½å’Œæˆæœ¬è€ƒé‡ï¼Œé€šå¸¸æœƒè¨­ä¸€å€‹æ¯”è¼ƒä½çš„å€¼ (ä¾‹å¦‚ `0.1`)ã€‚
- **`management.otlp.*.endpoint`**: æ˜ç¢ºæŒ‡å®šè¦æŠŠæŒ‡æ¨™ (Metrics)ã€è¿½è¹¤ (Traces)ã€æ—¥èªŒ (Logs) é€åˆ°å“ªè£¡ã€‚é€™è£¡æˆ‘å€‘éƒ½æŒ‡å‘ `otel-lgtm` å®¹å™¨çš„ 4318 é€£æ¥åŸ ã€‚
- **`spring.jpa.hibernate.ddl-auto`** (æ²’æœ‰è¨­å®šç‚º `update` æˆ– `create`)ï¼šæˆ‘å€‘æŠŠè³‡æ–™åº«çµæ§‹çš„ç®¡ç†æ¬Šå®Œå…¨äº¤çµ¦äº† Liquibaseï¼Œç¢ºä¿ç‰ˆæœ¬æ§åˆ¶çš„åš´è¬¹æ€§ã€‚

---

## ç›£æ§

å°±ç·’æ¢é‡ (readiness probe)

```bash
curl -X GET http://localhost:8080/actuator/health/readiness
```

å­˜æ´»æ¢é‡ (liveness probe)

```bash
curl -X GET http://localhost:8080/actuator/health/liveness
```

SBOM è³‡è¨Š

```bash
curl -X GET http://localhost:8080/actuator/sbom/application
```

## ç¸½çµ

é€™ä»½æ‰‹å†Šå±•ç¤ºäº†å¦‚ä½•æ•´åˆä¸€ç³»åˆ—ç¾ä»£åŒ–çš„å·¥å…·èˆ‡å¯¦è¸ï¼Œä¾†æ‰“é€ ä¸€å€‹ä¸åªåŠŸèƒ½å®Œæ•´ï¼ŒåŒæ™‚ä¹Ÿå…¼é¡§æ•ˆèƒ½ã€å¯ç¶­è­·æ€§å’Œå¯è§€æ¸¬æ€§çš„ Spring Boot å°ˆæ¡ˆã€‚

å°æ–¼é–‹ç™¼è€…è€Œè¨€ï¼Œå¾ã€ŒæŠŠåŠŸèƒ½åšå®Œã€é€²åŒ–åˆ°ã€ŒæŠŠå“è³ªåšå¥½ã€ï¼Œé—œéµåœ¨æ–¼æœ‰æ„è­˜åœ°å»æ¡ç”¨é€™äº›ç¾ä»£åŒ–çš„ä½œæ³•ï¼š

- æ“æŠ± Java 21 è™›æ“¬åŸ·è¡Œç·’ï¼Œç”¨æ›´ç°¡å–®çš„ç¨‹å¼ç¢¼ï¼Œæ›å–æ›´é«˜çš„ç³»çµ±ååé‡ã€‚
- é€é Liquibase é€²è¡Œè³‡æ–™åº«ç‰ˆæœ¬æ§åˆ¶ï¼Œç¢ºä¿åœ˜éšŠå”ä½œå’Œå¤šç’°å¢ƒéƒ¨ç½²çš„ä¸€è‡´æ€§ã€‚
- å¯¦è¸ API-First é–‹ç™¼æµç¨‹ï¼Œå»ºç«‹æ¸…æ™°çš„æœå‹™å¥‘ç´„ï¼ŒåŠ é€Ÿåœ˜éšŠçš„å¹³è¡Œé–‹ç™¼æ•ˆç‡ã€‚
- åˆ©ç”¨ MapStruct å’Œ Spring Cache ç­‰å·¥å…·ï¼Œæ¶ˆé™¤é‡è¤‡çš„æ¨£æ¿ç¨‹å¼ç¢¼ï¼Œä¸¦æœ‰æ•ˆæå‡æ‡‰ç”¨æ•ˆèƒ½ã€‚
- å»ºç«‹å…¨é¢çš„å¯è§€æ¸¬æ€§é«”ç³»ï¼Œé€é Micrometer å’Œ OpenTelemetry æ·±å…¥äº†è§£ç³»çµ±å…§éƒ¨è¡Œç‚ºï¼Œå°‡è¢«å‹•çš„ã€Œé™¤éŒ¯ã€ï¼Œè½‰è®Šç‚ºä¸»å‹•çš„ã€Œæ•ˆèƒ½å„ªåŒ–ã€èˆ‡ã€Œå•é¡Œé é˜²ã€ã€‚

å°‡é€™äº›å¯¦è¸èå…¥åˆ°æ—¥å¸¸é–‹ç™¼ä¸­ï¼Œæœ‰åŠ©æ–¼æå‡æœ€çµ‚ç”¢å“çš„å“è³ªèˆ‡é–‹ç™¼åœ˜éšŠçš„ç”Ÿç”¢åŠ›ã€‚å¸Œæœ›é€™ä»½æ‰‹å†Šèƒ½ç‚ºä½ åœ¨æ‰“é€ ä¸‹ä¸€å€‹å°ˆæ¡ˆæ™‚ï¼Œæä¾›æœ‰ç”¨çš„åƒè€ƒã€‚
